---
lang: zh-CN
title: å®¹å™¨ä¸bean
description: å®¹å™¨çš„å…·ä½“å®ç°å’Œbeançš„ç”Ÿå‘½å‘¨æœŸåº•å±‚æºç 
category: Spring
tag: 
 - Spring
 - Advanced

---


## å®¹å™¨ä¸ bean

### 1) å®¹å™¨æ¥å£

* BeanFactory æ¥å£ï¼Œå…¸å‹åŠŸèƒ½æœ‰ï¼š
  * getBean

* ApplicationContext æ¥å£ï¼Œæ˜¯ BeanFactory çš„å­æ¥å£ã€‚å®ƒæ‰©å±•äº† BeanFactory æ¥å£çš„åŠŸèƒ½ï¼Œå¦‚ï¼š
  * å›½é™…åŒ–
  * é€šé…ç¬¦æ–¹å¼è·å–ä¸€ç»„ Resource èµ„æº
  * æ•´åˆ Environment ç¯å¢ƒï¼ˆèƒ½é€šè¿‡å®ƒè·å–å„ç§æ¥æºçš„é…ç½®ä¿¡æ¯ï¼‰
  * äº‹ä»¶å‘å¸ƒä¸ç›‘å¬ï¼Œå®ç°ç»„ä»¶ä¹‹é—´çš„è§£è€¦

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è¯¾ä¸Šè®²çš„ï¼Œéƒ½æ˜¯ BeanFactory æä¾›çš„åŸºæœ¬åŠŸèƒ½ï¼ŒApplicationContext ä¸­çš„æ‰©å±•åŠŸèƒ½éƒ½æ²¡æœ‰ç”¨åˆ°ã€‚



#### æ¼”ç¤º1 - BeanFactory ä¸ ApplicationContext çš„åŒºåˆ«

#### æ”¶è·ğŸ’¡

é€šè¿‡è¿™ä¸ªç¤ºä¾‹ç»“åˆ debug æŸ¥çœ‹ ApplicationContext å¯¹è±¡çš„å†…éƒ¨ç»“æ„ï¼Œå­¦åˆ°ï¼š

1. åˆ°åº•ä»€ä¹ˆæ˜¯ BeanFactory

   - å®ƒæ˜¯ ApplicationContext çš„çˆ¶æ¥å£
   - å®ƒæ‰æ˜¯ Spring çš„æ ¸å¿ƒå®¹å™¨, ä¸»è¦çš„ ApplicationContext å®ç°éƒ½ã€ç»„åˆã€‘äº†å®ƒçš„åŠŸèƒ½ï¼Œã€ç»„åˆã€‘æ˜¯æŒ‡ ApplicationContext çš„ä¸€ä¸ªé‡è¦æˆå‘˜å˜é‡å°±æ˜¯ BeanFactory

2. BeanFactory èƒ½å¹²ç‚¹å•¥

   - è¡¨é¢ä¸Šåªæœ‰ getBean

   - å®é™…ä¸Šæ§åˆ¶åè½¬ã€åŸºæœ¬çš„ä¾èµ–æ³¨å…¥ã€ç›´è‡³ Bean çš„ç”Ÿå‘½å‘¨æœŸçš„å„ç§åŠŸèƒ½ï¼Œéƒ½ç”±å®ƒçš„å®ç°ç±»æä¾›

     ```java
     public class DefaultSingletonBeanRegistry extends SimpleAliasRegistry implements SingletonBeanRegistry {
         private final Map<String, Object> singletonObjects = new ConcurrentHashMap(256);
         private final Map<String, ObjectFactory<?>> singletonFactories = new HashMap(16);
     ```

   - ä¾‹å­ä¸­é€šè¿‡åå°„æŸ¥çœ‹äº†å®ƒçš„æˆå‘˜å˜é‡ singletonObjectsï¼Œå†…éƒ¨åŒ…å«äº†æ‰€æœ‰çš„å•ä¾‹ bean

3. ApplicationContext æ¯” BeanFactory å¤šç‚¹å•¥

   * ApplicationContext ç»„åˆå¹¶æ‰©å±•äº† BeanFactory çš„åŠŸèƒ½

   * å›½é™…åŒ–ã€é€šé…ç¬¦æ–¹å¼è·å–ä¸€ç»„ Resource èµ„æºã€æ•´åˆ Environment ç¯å¢ƒã€äº‹ä»¶å‘å¸ƒä¸ç›‘å¬

     ```java
     public interface MessageSource {  //å›½é™…åŒ–åŠŸèƒ½
         @Nullable
         String getMessage(String var1, @Nullable Object[] var2, @Nullable String var3, Locale var4);
     
         String getMessage(String var1, @Nullable Object[] var2, Locale var3) throws NoSuchMessageException;
     
         String getMessage(MessageSourceResolvable var1, Locale var2) throws NoSuchMessageException;
     
     ```

     ```java
     public interface ResourcePatternResolver extends ResourceLoader { //é€šé…ç¬¦åŒ¹é…èµ„æº
         String CLASSPATH_ALL_URL_PREFIX = "classpath*:";
     
         Resource[] getResources(String var1) throws IOException;
     }
     ```

     ```java
     @FunctionalInterface
     public interface ApplicationEventPublisher { //å‘å¸ƒäº‹ä»¶å¯¹è±¡
         default void publishEvent(ApplicationEvent event) {
             this.publishEvent((Object)event);
         }
     
         void publishEvent(Object var1);
     }
     ```

     ```java
     public interface EnvironmentCapable { //è¯»å–ç³»ç»Ÿç¯å¢ƒå˜é‡
         Environment getEnvironment();
     }
     ```

   * æ–°å­¦ä¸€ç§ä»£ç ä¹‹é—´è§£è€¦é€”å¾„ï¼Œäº‹ä»¶è§£è€¦

     ```java
     //ç”¨æˆ·æ³¨å†Œäº‹ä»¶
     @Autowired 
     private ApplicationEventPublisher context;//äº‹ä»¶å‘å¸ƒå™¨
     
     
     public void register(){
     	context.publishEvent(new UserRegisteredEvent(this));
     }
     
     
     //å¦ä¸€ä¸ªåŒ…
     @EventListener
     public void aaa(UserRegisteredEvent event){
     	//å¤„ç†ä¸šåŠ¡
     }
     ```

     

å»ºè®®ç»ƒä¹ ï¼šå®Œæˆç”¨æˆ·æ³¨å†Œä¸å‘é€çŸ­ä¿¡ä¹‹é—´çš„è§£è€¦ï¼Œç”¨äº‹ä»¶æ–¹å¼ã€å’Œ AOP æ–¹å¼åˆ†åˆ«å®ç°

> ***æ³¨æ„***
>
> * å¦‚æœ jdk > 8, è¿è¡Œæ—¶è¯·æ·»åŠ  --add-opens java.base/java.lang=ALL-UNNAMEDï¼Œè¿™æ˜¯å› ä¸ºè¿™äº›ç‰ˆæœ¬çš„ jdk é»˜è®¤ä¸å…è®¸è·¨ module åå°„
> * äº‹ä»¶å‘å¸ƒè¿˜å¯ä»¥å¼‚æ­¥ï¼Œè¿™ä¸ªè§†é¢‘ä¸­æ²¡æœ‰å±•ç¤ºï¼Œè¯·è‡ªè¡ŒæŸ¥é˜… @EnableAsyncï¼Œ@Async çš„ç”¨æ³•



#### æ¼”ç¤º2 - å›½é™…åŒ–

```java
public class TestMessageSource {
    public static void main(String[] args) {
        GenericApplicationContext context = new GenericApplicationContext();

        context.registerBean("messageSource", MessageSource.class, () -> {
            ResourceBundleMessageSource ms = new ResourceBundleMessageSource();
            ms.setDefaultEncoding("utf-8");
            ms.setBasename("messages");
            return ms;
        });

        context.refresh();

        System.out.println(context.getMessage("hi", null, Locale.ENGLISH));
        System.out.println(context.getMessage("hi", null, Locale.CHINESE));
        System.out.println(context.getMessage("hi", null, Locale.JAPANESE));
    }
}
```

å›½é™…åŒ–æ–‡ä»¶å‡åœ¨ src/resources ç›®å½•ä¸‹

messages.propertiesï¼ˆç©ºï¼‰

messages_en.properties

```properties
hi=Hello
```

messages_ja.properties

```properties
hi=ã“ã‚“ã«ã¡ã¯
```

messages_zh.properties

```properties
hi=ä½ å¥½
```

> ***æ³¨æ„***
>
> * ApplicationContext ä¸­ MessageSource bean çš„åå­—å›ºå®šä¸º messageSource
> * ä½¿ç”¨ SpringBoot æ—¶ï¼Œå›½é™…åŒ–æ–‡ä»¶åå›ºå®šä¸º messages
> * ç©ºçš„ messages.properties ä¹Ÿå¿…é¡»å­˜åœ¨



### 2) å®¹å™¨å®ç°

Spring çš„å‘å±•å†å²è¾ƒä¸ºæ‚ ä¹…ï¼Œå› æ­¤å¾ˆå¤šèµ„æ–™è¿˜åœ¨è®²è§£å®ƒè¾ƒæ—§çš„å®ç°ï¼Œè¿™é‡Œå‡ºäºæ€€æ—§çš„åŸå› ï¼ŒæŠŠå®ƒä»¬éƒ½åˆ—å‡ºæ¥ï¼Œä¾›å¤§å®¶å‚è€ƒ

* DefaultListableBeanFactoryï¼Œæ˜¯ BeanFactory æœ€é‡è¦çš„å®ç°ï¼Œåƒ**æ§åˆ¶åè½¬**å’Œ**ä¾èµ–æ³¨å…¥**åŠŸèƒ½ï¼Œéƒ½æ˜¯å®ƒæ¥å®ç°

  ```java
   DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
          AbstractBeanDefinition beanDefinition = BeanDefinitionBuilder.genericBeanDefinition(Config.class).setScope("singleton").getBeanDefinition();
          beanFactory.registerBeanDefinition("config", beanDefinition);
          //æ³¨å†Œåå¤„ç†å™¨
          AnnotationConfigUtils.registerAnnotationConfigProcessors(beanFactory);
          //è§£æBeanåå¤„ç†å™¨
          beanFactory.getBeansOfType(BeanFactoryPostProcessor.class).values().stream().forEach(beanFactoryPostProcessor -> {
              beanFactoryPostProcessor.postProcessBeanFactory(beanFactory);
          });
  
          for (String beanDefinitionName : beanFactory.getBeanDefinitionNames()) {
              System.out.println(beanDefinitionName);
          }
  ```

* ClassPathXmlApplicationContextï¼Œä»ç±»è·¯å¾„æŸ¥æ‰¾ XML é…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºå®¹å™¨ï¼ˆæ—§ï¼‰

* FileSystemXmlApplicationContextï¼Œä»ç£ç›˜è·¯å¾„æŸ¥æ‰¾ XML é…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºå®¹å™¨ï¼ˆæ—§ï¼‰

* XmlWebApplicationContextï¼Œä¼ ç»Ÿ SSM æ•´åˆæ—¶ï¼ŒåŸºäº XML é…ç½®æ–‡ä»¶çš„å®¹å™¨ï¼ˆæ—§ï¼‰

* AnnotationConfigWebApplicationContextï¼Œä¼ ç»Ÿ SSM æ•´åˆæ—¶ï¼ŒåŸºäº java é…ç½®ç±»çš„å®¹å™¨ï¼ˆæ—§ï¼‰

* AnnotationConfigApplicationContextï¼ŒSpring boot ä¸­é web ç¯å¢ƒå®¹å™¨ï¼ˆæ–°ï¼‰

* AnnotationConfigServletWebServerApplicationContextï¼ŒSpring boot ä¸­ servlet web ç¯å¢ƒå®¹å™¨ï¼ˆæ–°ï¼‰

* AnnotationConfigReactiveWebServerApplicationContextï¼ŒSpring boot ä¸­ reactive web ç¯å¢ƒå®¹å™¨ï¼ˆæ–°ï¼‰

å¦å¤–è¦æ³¨æ„çš„æ˜¯ï¼Œåé¢è¿™äº›å¸¦æœ‰ ApplicationContext çš„ç±»éƒ½æ˜¯ ApplicationContext æ¥å£çš„å®ç°ï¼Œä½†å®ƒä»¬æ˜¯**ç»„åˆ**äº† DefaultListableBeanFactory çš„åŠŸèƒ½ï¼Œå¹¶éç»§æ‰¿è€Œæ¥



#### æ¼”ç¤º1 - DefaultListableBeanFactory

#### æ”¶è·ğŸ’¡

* beanFactory å¯ä»¥é€šè¿‡ registerBeanDefinition æ³¨å†Œä¸€ä¸ª bean definition å¯¹è±¡

  * æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„é…ç½®ç±»ã€xmlã€ç»„ä»¶æ‰«æç­‰æ–¹å¼éƒ½æ˜¯ç”Ÿæˆ bean definition å¯¹è±¡æ³¨å†Œåˆ° beanFactory å½“ä¸­

  * bean definition æè¿°äº†è¿™ä¸ª bean çš„åˆ›å»ºè“å›¾ï¼šscope æ˜¯ä»€ä¹ˆã€ç”¨æ„é€ è¿˜æ˜¯å·¥å‚åˆ›å»ºã€åˆå§‹åŒ–é”€æ¯æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Œç­‰ç­‰

    ```java
    public class BeanFactory {
        public static void main(String[] args) {
            DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
            //éœ€è¦beanå®šä¹‰(class scope init destroy
            AbstractBeanDefinition beanDefinition =
                    BeanDefinitionBuilder.genericBeanDefinition(Config.class).setScope("singleton").getBeanDefinition();
            //æ³¨å†Œbean definitionåˆ°bean factory æŒ‡å®šåå­—ä¸ºconfig
            beanFactory.registerBeanDefinition("config",beanDefinition);
            //æ­¤æ—¶åªæœ‰config æ²¡æœ‰è§£æ@Bean
    
            //ç»™bean factory æ·»åŠ å¸¸ç”¨åç½®å¤„ç†å™¨
            AnnotationConfigUtils.registerAnnotationConfigProcessors(beanFactory);
            //org.springframework.context.annotation.internalConfigurationAnnotationProcessor  å¤„ç†configurationæ³¨è§£
            //org.springframework.context.annotation.internalAutowiredAnnotationProcessor   å¤„ç†autowiredæ³¨è§£
            //org.springframework.context.annotation.internalCommonAnnotationProcessor       å¤„ç†å…¶ä»–ç³»ç»Ÿå†…ç½®æ³¨è§£
            //org.springframework.context.event.internalEventListenerProcessor
            //org.springframework.context.event.internalEventListenerFactory
    
    
            //æ‹¿åˆ°æ‰€æœ‰bean factory åå¤„ç†å™¨
            beanFactory.getBeansOfType(BeanFactoryPostProcessor.class).values().forEach(beanFactoryPostProcessor->{
                //æ‰§è¡Œbean factory åå¤„ç†å™¨
                beanFactoryPostProcessor.postProcessBeanFactory(beanFactory);
            });
    
            //æ­¤æ—¶å‡ºç°bean1 bean2
            //config
            //org.springframework.context.annotation.internalConfigurationAnnotationProcessor
            //org.springframework.context.annotation.internalAutowiredAnnotationProcessor
            //org.springframework.context.annotation.internalCommonAnnotationProcessor
            //org.springframework.context.event.internalEventListenerProcessor
            //org.springframework.context.event.internalEventListenerFactory
            //bean1
            //bean2
    		//beanåå¤„ç†åŒº æ³¨å†Œåå¤„ç†å™¨ é’ˆå¯¹beanç”Ÿå‘½å‘¨æœŸçš„æä¾›æ‰©å±•çš„å†…å®¹
            beanFactory.getBeansOfType(BeanPostProcessor.class).values().forEach(beanFactory::addBeanPostProcessor);
            
            for (String beanDefinitionName : beanFactory.getBeanDefinitionNames()) {
                System.out.println(beanDefinitionName);
            }
        }
    
        @Configuration
        static class Config{
            @Bean
            public Bean1 bean1(){
                return new Bean1();
            }
    
            @Bean
            public Bean2 bean2(){
                return new Bean2();
            }
        }
        static class Bean1{
            public  Bean1(){
                System.out.println("constructor bean1");
            }
    
            @Autowired
            private Bean2 bean2;
    
            public Bean2 getBean2(){
                return bean2;
            }
        }
    
        static class Bean2{
            public Bean2(){
                System.out.println("constructor bean2");
            }
        }
    }
    ```

    

* beanFactory éœ€è¦æ‰‹åŠ¨è°ƒç”¨ beanFactory åå¤„ç†å™¨å¯¹å®ƒåšå¢å¼º

  * ä¾‹å¦‚é€šè¿‡è§£æ @Beanã€@ComponentScan ç­‰æ³¨è§£ï¼Œæ¥è¡¥å……ä¸€äº› bean definition

* beanFactory éœ€è¦æ‰‹åŠ¨æ·»åŠ  bean åå¤„ç†å™¨ï¼Œä»¥ä¾¿å¯¹åç»­ bean çš„åˆ›å»ºè¿‡ç¨‹æä¾›å¢å¼º

  * ä¾‹å¦‚ @Autowiredï¼Œ@Resource ç­‰æ³¨è§£çš„è§£æéƒ½æ˜¯ bean åå¤„ç†å™¨å®Œæˆçš„
  * bean åå¤„ç†çš„æ·»åŠ é¡ºåºä¼šå¯¹è§£æç»“æœæœ‰å½±å“ï¼Œè§è§†é¢‘ä¸­åŒæ—¶åŠ  @Autowiredï¼Œ@Resource çš„ä¾‹å­

* beanFactory éœ€è¦æ‰‹åŠ¨è°ƒç”¨æ–¹æ³•æ¥åˆå§‹åŒ–å•ä¾‹

* beanFactory éœ€è¦é¢å¤–è®¾ç½®æ‰èƒ½è§£æ ${} ä¸ #{}



#### æ¼”ç¤º2 - å¸¸è§ ApplicationContext å®ç°

#### æ”¶è·ğŸ’¡

1. å¸¸è§çš„ ApplicationContext å®¹å™¨å®ç°
2. å†…åµŒå®¹å™¨ã€DispatcherServlet çš„åˆ›å»ºæ–¹æ³•ã€ä½œç”¨

```java
public class ApplicationContext {
    public static void main(String[] args) {
        //ä»xmlé…ç½®åˆ›å»ºå®¹å™¨
        ClassPathXmlApplicationContext xmlContext = new ClassPathXmlApplicationContext();
        //ä»ç³»ç»Ÿè·¯å¾„åˆ›å»ºå®¹å™¨
        FileSystemXmlApplicationContext fileContext = new FileSystemXmlApplicationContext();

        //å°†xmlçš„æ•°æ®è¯»å…¥beanfactory
        DefaultListableBeanFactory beanFactory = new DefaultListableBeanFactory();
        XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(beanFactory);
        reader.loadBeanDefinitions(new ClassPathResource("xml"));

        //ç”¨æ³¨è§£æ–¹å¼é…ç½®å®¹å™¨
        AnnotationConfigApplicationContext annotationConfigApplicationContext =
                new AnnotationConfigApplicationContext();

        //åŸºäºjavaé…ç½®ç±»æ¥åˆ›å»º ç”¨äºwebç¯å¢ƒ
        AnnotationConfigServletWebApplicationContext annotationConfigServletWebApplicationContext =
                new AnnotationConfigServletWebApplicationContext(WebConfig.class);

    }

    @Configuration
    static class WebConfig{
        @Bean
        public ServletWebServerFactory servletWebServerFactory(){
            return new TomcatServletWebServerFactory();
        }
        @Bean
        public DispatcherServlet dispatcherServlet(){
            return  new DispatcherServlet();
        }
        @Bean
        public DispatcherServletRegistrationBean registrationBean(DispatcherServlet dispatcherServlet){
            return  new DispatcherServletRegistrationBean(dispatcherServlet,"/");
        }
        @Bean("/hello")
        public Controller controller(){
            return ((request, response) ->
            {
                response.getWriter().println("hello");
                return null;
            });
        }

    }

    static class Bean1{
        public  Bean1(){
            System.out.println("constructor bean1");
        }

        @Autowired
        private BeanFactory.Bean2 bean2;

        public BeanFactory.Bean2 getBean2(){
            return bean2;
        }
    }

    static class Bean2{
        public Bean2(){
            System.out.println("constructor bean2");
        }
    }
}
```



### 3) Bean çš„ç”Ÿå‘½å‘¨æœŸ

ä¸€ä¸ªå— Spring ç®¡ç†çš„ beanï¼Œç”Ÿå‘½å‘¨æœŸä¸»è¦é˜¶æ®µæœ‰

1. åˆ›å»ºï¼šæ ¹æ® bean çš„æ„é€ æ–¹æ³•æˆ–è€…å·¥å‚æ–¹æ³•æ¥åˆ›å»º bean å®ä¾‹å¯¹è±¡
2. ä¾èµ–æ³¨å…¥ï¼šæ ¹æ® @Autowiredï¼Œ@Value æˆ–å…¶å®ƒä¸€äº›æ‰‹æ®µï¼Œä¸º bean çš„æˆå‘˜å˜é‡å¡«å……å€¼ã€å»ºç«‹å…³ç³»
3. åˆå§‹åŒ–ï¼šå›è°ƒå„ç§ Aware æ¥å£ï¼Œè°ƒç”¨å¯¹è±¡çš„å„ç§åˆå§‹åŒ–æ–¹æ³•
4. é”€æ¯ï¼šåœ¨å®¹å™¨å…³é—­æ—¶ï¼Œä¼šé”€æ¯æ‰€æœ‰å•ä¾‹å¯¹è±¡ï¼ˆå³è°ƒç”¨å®ƒä»¬çš„é”€æ¯æ–¹æ³•ï¼‰
   * prototype å¯¹è±¡ä¹Ÿèƒ½å¤Ÿé”€æ¯ï¼Œä¸è¿‡éœ€è¦å®¹å™¨è¿™è¾¹ä¸»åŠ¨è°ƒç”¨

ä¸€äº›èµ„æ–™ä¼šæåˆ°ï¼Œç”Ÿå‘½å‘¨æœŸä¸­è¿˜æœ‰ä¸€ç±» bean åå¤„ç†å™¨ï¼šBeanPostProcessorï¼Œä¼šåœ¨ bean çš„åˆå§‹åŒ–çš„å‰åï¼Œæä¾›ä¸€äº›æ‰©å±•é€»è¾‘ã€‚ä½†è¿™ç§è¯´æ³•æ˜¯ä¸å®Œæ•´çš„ï¼Œè§ä¸‹é¢çš„æ¼”ç¤º1



#### æ¼”ç¤º1 - bean ç”Ÿå‘½å‘¨æœŸ



```mermaid
graph LR

åˆ›å»º --> ä¾èµ–æ³¨å…¥
ä¾èµ–æ³¨å…¥ --> åˆå§‹åŒ–
åˆå§‹åŒ– --> å¯ç”¨
å¯ç”¨ --> é”€æ¯
```

åˆ›å»ºå‰åçš„å¢å¼º

* postProcessBeforeInstantiation
  * è¿™é‡Œè¿”å›çš„å¯¹è±¡è‹¥ä¸ä¸º null ä¼šæ›¿æ¢æ‰åŸæœ¬çš„ beanï¼Œå¹¶ä¸”ä»…ä¼šèµ° postProcessAfterInitialization æµç¨‹
* postProcessAfterInstantiation
  * è¿™é‡Œå¦‚æœè¿”å› false ä¼šè·³è¿‡ä¾èµ–æ³¨å…¥é˜¶æ®µ

ä¾èµ–æ³¨å…¥å‰çš„å¢å¼º

* postProcessProperties
  * å¦‚ @Autowiredã€@Valueã€@Resource 

åˆå§‹åŒ–å‰åçš„å¢å¼º

* postProcessBeforeInitialization
  * è¿™é‡Œè¿”å›çš„å¯¹è±¡ä¼šæ›¿æ¢æ‰åŸæœ¬çš„ bean
  * å¦‚ @PostConstructã€@ConfigurationProperties
* postProcessAfterInitialization 
  * è¿™é‡Œè¿”å›çš„å¯¹è±¡ä¼šæ›¿æ¢æ‰åŸæœ¬çš„ bean
  * å¦‚ä»£ç†å¢å¼º

é”€æ¯ä¹‹å‰çš„å¢å¼º

* postProcessBeforeDestruction
  * å¦‚ @PreDestroy 

#### æ”¶è·ğŸ’¡

1. Spring bean ç”Ÿå‘½å‘¨æœŸå„ä¸ªé˜¶æ®µ
2. æ¨¡æ¿è®¾è®¡æ¨¡å¼, æŒ‡å¤§æµç¨‹å·²ç»å›ºå®šå¥½äº†, é€šè¿‡æ¥å£å›è°ƒï¼ˆbean åå¤„ç†å™¨ï¼‰åœ¨ä¸€äº›å…³é”®ç‚¹å‰åæä¾›æ‰©å±•



#### æ¼”ç¤º2 - æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼

##### å…³é”®ä»£ç 

```java
public class TestMethodTemplate {

    public static void main(String[] args) {
        MyBeanFactory beanFactory = new MyBeanFactory();
        beanFactory.addBeanPostProcessor(bean -> System.out.println("è§£æ @Autowired"));
        beanFactory.addBeanPostProcessor(bean -> System.out.println("è§£æ @Resource"));
        beanFactory.getBean();
    }

    // æ¨¡æ¿æ–¹æ³•  Template Method Pattern
    static class MyBeanFactory {
        public Object getBean() {
            Object bean = new Object();
            System.out.println("æ„é€  " + bean);
            System.out.println("ä¾èµ–æ³¨å…¥ " + bean); // @Autowired, @Resource
            for (BeanPostProcessor processor : processors) {
                processor.inject(bean);
            }
            System.out.println("åˆå§‹åŒ– " + bean);
            return bean;
        }

        private List<BeanPostProcessor> processors = new ArrayList<>();

        public void addBeanPostProcessor(BeanPostProcessor processor) {
            processors.add(processor);
        }
    }
    
    static interface BeanPostProcessor {
        public void inject(Object bean); // å¯¹ä¾èµ–æ³¨å…¥é˜¶æ®µçš„æ‰©å±•
    }
}
```



#### æ¼”ç¤º3 - bean åå¤„ç†å™¨æ’åº

#### æ”¶è·ğŸ’¡

1. å®ç°äº† PriorityOrdered æ¥å£çš„ä¼˜å…ˆçº§æœ€é«˜

2. å®ç°äº† Ordered æ¥å£ä¸åŠ äº† @Order æ³¨è§£çš„å¹³çº§, æŒ‰æ•°å­—å‡åº

3. å…¶å®ƒçš„æ’åœ¨æœ€å

   

   



### 4) Bean åå¤„ç†å™¨

#### æ¼”ç¤º1 - åå¤„ç†å™¨ä½œç”¨

#### æ”¶è·ğŸ’¡

1. @Autowired ç­‰æ³¨è§£çš„è§£æå±äº bean ç”Ÿå‘½å‘¨æœŸé˜¶æ®µï¼ˆä¾èµ–æ³¨å…¥, åˆå§‹åŒ–ï¼‰çš„æ‰©å±•åŠŸèƒ½ï¼Œè¿™äº›æ‰©å±•åŠŸèƒ½ç”± bean åå¤„ç†å™¨æ¥å®Œæˆ
2. æ¯ä¸ªåå¤„ç†å™¨å„è‡ªå¢å¼ºä»€ä¹ˆåŠŸèƒ½
   * AutowiredAnnotationBeanPostProcessor è§£æ @Autowired ä¸ @Value
   * CommonAnnotationBeanPostProcessor è§£æ @Resourceã€@PostConstructã€@PreDestroy
   * ConfigurationPropertiesBindingPostProcessor è§£æ @ConfigurationProperties
3. å¦å¤– ContextAnnotationAutowireCandidateResolver è´Ÿè´£è·å– @Value çš„å€¼ï¼Œè§£æ @Qualifierã€æ³›å‹ã€@Lazy ç­‰

```java
public class BeanPostProcessor {
    public static void main(String[] args) {
        GenericApplicationContext context = new GenericApplicationContext();
        
        //è§£æAutowired Value
        context.getDefaultListableBeanFactory().setAutowireCandidateResolver(new ContextAnnotationAutowireCandidateResolver());
        context.registerBean(AutowiredAnnotationBeanPostProcessor.class);
        
        context.registerBean(CommonAnnotationBeanPostProcessor.class);
        //è§£æ@Resource @PostConstruct @PreDestroy
        
        ConfigurationPropertiesBindingPostProcessor.register(context.getDefaultListableBeanFactory()); //@ConfigurationProperties
        context.refresh();
        context.close();
    }
}
```



#### æ¼”ç¤º2 - @Autowired bean åå¤„ç†å™¨è¿è¡Œåˆ†æ

#### æ”¶è·ğŸ’¡

1. AutowiredAnnotationBeanPostProcessor.findAutowiringMetadata ç”¨æ¥è·å–æŸä¸ª bean ä¸ŠåŠ äº† @Value @Autowired çš„æˆå‘˜å˜é‡ï¼Œæ–¹æ³•å‚æ•°çš„ä¿¡æ¯ï¼Œè¡¨ç¤ºä¸º InjectionMetadata
2. InjectionMetadata å¯ä»¥å®Œæˆä¾èµ–æ³¨å…¥
3. InjectionMetadata å†…éƒ¨æ ¹æ®æˆå‘˜å˜é‡ï¼Œæ–¹æ³•å‚æ•°å°è£…ä¸º DependencyDescriptor ç±»å‹
4. æœ‰äº† DependencyDescriptorï¼Œå°±å¯ä»¥åˆ©ç”¨ beanFactory.doResolveDependency æ–¹æ³•è¿›è¡ŒåŸºäºç±»å‹çš„æŸ¥æ‰¾

```
public static void main(String[] args) throws Throwable {
        GenericApplicationContext context = new GenericApplicationContext();

        //è§£æAutowired Value
        context.getDefaultListableBeanFactory().setAutowireCandidateResolver(new ContextAnnotationAutowireCandidateResolver());
        context.registerBean(AutowiredAnnotationBeanPostProcessor.class);

        //@Autowiredè§£æè¿‡ç¨‹
        AutowiredAnnotationBeanPostProcessor processor = new AutowiredAnnotationBeanPostProcessor();
        //æ³¨å†Œbeanfactory
        processor.setBeanFactory(context.getDefaultListableBeanFactory());
        //æ‰§è¡Œä¾èµ–æ³¨å…¥
        processor.postProcessProperties(null,null,null);

        Method findAutowiringMetadata = AutowiredAnnotationBeanPostProcessor.class.
                getDeclaredMethod("findAutowiringMetadata", String.class, Class.class, PropertyValues.class);
        findAutowiringMetadata.setAccessible(true);
        //è·å–é‚£äº›æ–¹æ³•å’Œå˜é‡åŠ äº†@autowired
        InjectionMetadata metadata = (InjectionMetadata) findAutowiringMetadata.invoke(processor, null);
        //æ³¨å…¥
        metadata.inject(null,null,null);

        //æ ¹æ®ç±»å‹æŸ¥æ‰¾å€¼
        //æˆå‘˜å˜é‡æ ¹æ®ç±»å‹æ‰¾beanå®Œæˆæ³¨å…¥ æ–¹æ³•æ ¹æ®å‚æ•°ç±»å‹æ‰¾ Field Method Valueå‡å¯
        Field bean1 = Bean1.class.getDeclaredField("bean1");
        DependencyDescriptor dd1 = new DependencyDescriptor(bean1,false);
        Object o =
                context.getDefaultListableBeanFactory().
                        doResolveDependency(dd1, null, null, null);
        System.out.println(o);


        context.registerBean(CommonAnnotationBeanPostProcessor.class);
        //@Resource @PostConstruct @PreDestroy

        ConfigurationPropertiesBindingPostProcessor.register(context.getDefaultListableBeanFactory()); //@ConfigurationProperties


        context.refresh();
        context.close();
    }
```



### 5) BeanFactory åå¤„ç†å™¨

#### æ¼”ç¤º1 - BeanFactory åå¤„ç†å™¨çš„ä½œç”¨

* ConfigurationClassPostProcessor å¯ä»¥è§£æ

  * @ComponentScan

  * @Bean

  * @Import

  * @ImportResource

    ```java
     public static void main(String[] args) {
            GenericApplicationContext context = new GenericApplicationContext();
            context.registerBean("config",Config.class);
            context.registerBean(ConfigurationClassPostProcessor.class);//ComponentScan @Bean @Import @ImportResource
            context.refresh();
        }
    ```

    

* MapperScannerConfigurer å¯ä»¥è§£æ

  * Mapper æ¥å£

#### æ”¶è·ğŸ’¡

1. @ComponentScan, @Bean, @Mapper ç­‰æ³¨è§£çš„è§£æå±äºæ ¸å¿ƒå®¹å™¨ï¼ˆå³ BeanFactoryï¼‰çš„æ‰©å±•åŠŸèƒ½
2. è¿™äº›æ‰©å±•åŠŸèƒ½ç”±ä¸åŒçš„ BeanFactory åå¤„ç†å™¨æ¥å®Œæˆï¼Œå…¶å®ä¸»è¦å°±æ˜¯è¡¥å……äº†ä¸€äº› bean å®šä¹‰



#### æ¼”ç¤º2 - æ¨¡æ‹Ÿè§£æ @ComponentScan

#### æ”¶è·ğŸ’¡

1. Spring æ“ä½œå…ƒæ•°æ®çš„å·¥å…·ç±» CachingMetadataReaderFactory
2. é€šè¿‡æ³¨è§£å…ƒæ•°æ®ï¼ˆAnnotationMetadataï¼‰è·å–ç›´æ¥æˆ–é—´æ¥æ ‡æ³¨çš„æ³¨è§£ä¿¡æ¯
3. é€šè¿‡ç±»å…ƒæ•°æ®ï¼ˆClassMetadataï¼‰è·å–ç±»åï¼ŒAnnotationBeanNameGenerator ç”Ÿæˆ bean å
4. è§£æå…ƒæ•°æ®æ˜¯åŸºäº ASM æŠ€æœ¯

```java
public class ComponentScanPostProcessor implements BeanDefinitionRegistryPostProcessor {
    @Override // context.refresh
    public void postProcessBeanFactory(ConfigurableListableBeanFactory configurableListableBeanFactory) throws BeansException {

    }

    @Override
    public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry beanFactory) throws BeansException {
        try {
            ComponentScan componentScan = AnnotationUtils.findAnnotation(Config.class, ComponentScan.class);
            if (componentScan != null) {
                for (String p : componentScan.basePackages()) {
                    System.out.println(p);
                    // com.itheima.a05.component -> classpath*:com/itheima/a05/component/**/*.class
                    String path = "classpath*:" + p.replace(".", "/") + "/**/*.class";
                    System.out.println(path);
                    CachingMetadataReaderFactory factory = new CachingMetadataReaderFactory();
                    Resource[] resources = new PathMatchingResourcePatternResolver().getResources(path);
                    AnnotationBeanNameGenerator generator = new AnnotationBeanNameGenerator();
                    for (Resource resource : resources) {
                        // System.out.println(resource);
                        MetadataReader reader = factory.getMetadataReader(resource);
                        // System.out.println("ç±»å:" + reader.getClassMetadata().getClassName());
                        AnnotationMetadata annotationMetadata = reader.getAnnotationMetadata();
                        // System.out.println("æ˜¯å¦åŠ äº† @Component:" + annotationMetadata.hasAnnotation(Component.class.getName()));
                        // System.out.println("æ˜¯å¦åŠ äº† @Component æ´¾ç”Ÿ:" + annotationMetadata.hasMetaAnnotation(Component.class.getName()));
                        if (annotationMetadata.hasAnnotation(Component.class.getName())
                            || annotationMetadata.hasMetaAnnotation(Component.class.getName())) {
                            AbstractBeanDefinition bd = BeanDefinitionBuilder
                                    .genericBeanDefinition(reader.getClassMetadata().getClassName())
                                    .getBeanDefinition();
                            String name = generator.generateBeanName(bd, beanFactory);
                            beanFactory.registerBeanDefinition(name, bd);
                        }
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```



#### æ¼”ç¤º3 - æ¨¡æ‹Ÿè§£æ @Bean

##### ä»£ç å‚è€ƒ 

**com.itheima.a05.AtBeanPostProcessor**

#### æ”¶è·ğŸ’¡

1. è¿›ä¸€æ­¥ç†Ÿæ‚‰æ³¨è§£å…ƒæ•°æ®ï¼ˆAnnotationMetadataï¼‰è·å–æ–¹æ³•ä¸Šæ³¨è§£ä¿¡æ¯

```java
  public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry beanFactory) throws BeansException {
        try {
            CachingMetadataReaderFactory factory = new CachingMetadataReaderFactory();
            MetadataReader reader = factory.getMetadataReader(new ClassPathResource("com/itheima/a05/Config.class"));
            Set<MethodMetadata> methods = reader.getAnnotationMetadata().getAnnotatedMethods(Bean.class.getName());
            for (MethodMetadata method : methods) {
                System.out.println(method);
                String initMethod = method.getAnnotationAttributes(Bean.class.getName()).get("initMethod").toString();
                BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition();
                builder.setFactoryMethodOnBean(method.getMethodName(), "config");
                builder.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_CONSTRUCTOR);
                if (initMethod.length() > 0) {
                    builder.setInitMethodName(initMethod);
                }
                AbstractBeanDefinition bd = builder.getBeanDefinition();
                beanFactory.registerBeanDefinition(method.getMethodName(), bd);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
```





#### æ¼”ç¤º4 - æ¨¡æ‹Ÿè§£æ Mapper æ¥å£

#### æ”¶è·ğŸ’¡

1. Mapper æ¥å£è¢« Spring ç®¡ç†çš„æœ¬è´¨ï¼šå®é™…æ˜¯è¢«ä½œä¸º MapperFactoryBean æ³¨å†Œåˆ°å®¹å™¨ä¸­
2. Spring çš„è¯¡å¼‚åšæ³•ï¼Œæ ¹æ®æ¥å£ç”Ÿæˆçš„ BeanDefinition ä»…ä¸ºæ ¹æ®æ¥å£åç”Ÿæˆ bean å

```java
public class MapperPostProcessor implements BeanDefinitionRegistryPostProcessor {

    @Override
    public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry beanFactory) throws BeansException {
        try {
            PathMatchingResourcePatternResolver resolver = new PathMatchingResourcePatternResolver();
            Resource[] resources = resolver.getResources("classpath:com/itheima/a05/mapper/**/*.class");
            AnnotationBeanNameGenerator generator = new AnnotationBeanNameGenerator();
            CachingMetadataReaderFactory factory = new CachingMetadataReaderFactory();
            for (Resource resource : resources) {
                MetadataReader reader = factory.getMetadataReader(resource);
                ClassMetadata classMetadata = reader.getClassMetadata();
                if (classMetadata.isInterface()) {
                    AbstractBeanDefinition bd = BeanDefinitionBuilder.genericBeanDefinition(MapperFactoryBean.class)
                            .addConstructorArgValue(classMetadata.getClassName())
                            .setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE)
                            .getBeanDefinition();
                    AbstractBeanDefinition bd2 = BeanDefinitionBuilder.genericBeanDefinition(classMetadata.getClassName()).getBeanDefinition();
                    String name = generator.generateBeanName(bd2, beanFactory);
                    beanFactory.registerBeanDefinition(name, bd);
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

    }

    @Override
    public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException {

    }
}

```



### 6) Aware æ¥å£

#### æ¼”ç¤º - Aware æ¥å£åŠ InitializingBean æ¥å£

##### ä»£ç å‚è€ƒ 

**com.itheima.a06** åŒ…

#### æ”¶è·ğŸ’¡

1. Aware æ¥å£æä¾›äº†ä¸€ç§ã€å†…ç½®ã€‘ çš„æ³¨å…¥æ‰‹æ®µï¼Œä¾‹å¦‚
   * BeanNameAware æ³¨å…¥ bean çš„åå­—
   * BeanFactoryAware æ³¨å…¥ BeanFactory å®¹å™¨
   * ApplicationContextAware æ³¨å…¥ ApplicationContext å®¹å™¨
   * EmbeddedValueResolverAware æ³¨å…¥ ${} è§£æå™¨
2. InitializingBean æ¥å£æä¾›äº†ä¸€ç§ã€å†…ç½®ã€‘çš„åˆå§‹åŒ–æ‰‹æ®µ
3. å¯¹æ¯”
   * å†…ç½®çš„æ³¨å…¥å’Œåˆå§‹åŒ–ä¸å—æ‰©å±•åŠŸèƒ½çš„å½±å“ï¼Œæ€»ä¼šè¢«æ‰§è¡Œ
   * è€Œæ‰©å±•åŠŸèƒ½å—æŸäº›æƒ…å†µå½±å“å¯èƒ½ä¼šå¤±æ•ˆ
   * å› æ­¤ Spring æ¡†æ¶å†…éƒ¨çš„ç±»å¸¸ç”¨å†…ç½®æ³¨å…¥å’Œåˆå§‹åŒ–



#### é…ç½®ç±» @Autowired å¤±æ•ˆåˆ†æ

Java é…ç½®ç±»ä¸åŒ…å« BeanFactoryPostProcessor çš„æƒ…å†µ

```mermaid
sequenceDiagram 
participant ac as ApplicationContext
participant bfpp as BeanFactoryPostProcessor
participant bpp as BeanPostProcessor
participant config as Javaé…ç½®ç±»
ac ->> bfpp : 1. æ‰§è¡Œ BeanFactoryPostProcessor
ac ->> bpp : 2. æ³¨å†Œ BeanPostProcessor
ac ->> +config : 3. åˆ›å»ºå’Œåˆå§‹åŒ–
bpp ->> config : 3.1 ä¾èµ–æ³¨å…¥æ‰©å±•(å¦‚ @Value å’Œ @Autowired)
bpp ->> config : 3.2 åˆå§‹åŒ–æ‰©å±•(å¦‚ @PostConstruct)
ac ->> config : 3.3 æ‰§è¡Œ Aware åŠ InitializingBean
config -->> -ac : 3.4 åˆ›å»ºæˆåŠŸ
```

Java é…ç½®ç±»åŒ…å« BeanFactoryPostProcessor çš„æƒ…å†µï¼Œå› æ­¤è¦åˆ›å»ºå…¶ä¸­çš„ BeanFactoryPostProcessor å¿…é¡»æå‰åˆ›å»º Java é…ç½®ç±»ï¼Œè€Œæ­¤æ—¶çš„ BeanPostProcessor è¿˜æœªå‡†å¤‡å¥½ï¼Œå¯¼è‡´ @Autowired ç­‰æ³¨è§£å¤±æ•ˆ

```mermaid
sequenceDiagram 
participant ac as ApplicationContext
participant bfpp as BeanFactoryPostProcessor
participant bpp as BeanPostProcessor
participant config as Javaé…ç½®ç±»
ac ->> +config : 3. åˆ›å»ºå’Œåˆå§‹åŒ–
ac ->> config : 3.1 æ‰§è¡Œ Aware åŠ InitializingBean
config -->> -ac : 3.2 åˆ›å»ºæˆåŠŸ

ac ->> bfpp : 1. æ‰§è¡Œ BeanFactoryPostProcessor
ac ->> bpp : 2. æ³¨å†Œ BeanPostProcessor



```

å¯¹åº”ä»£ç 

```java
@Configuration
public class MyConfig1 {

    private static final Logger log = LoggerFactory.getLogger(MyConfig1.class);

    @Autowired
    public void setApplicationContext(ApplicationContext applicationContext) {
        log.debug("æ³¨å…¥ ApplicationContext");
    }

    @PostConstruct
    public void init() {
        log.debug("åˆå§‹åŒ–");
    }

    @Bean //  â¬…ï¸ æ³¨é‡Šæˆ–æ·»åŠ  beanFactory åå¤„ç†å™¨å¯¹åº”ä¸Šæ–¹ä¸¤ç§æƒ…å†µ
    public BeanFactoryPostProcessor processor1() {
        return beanFactory -> {
            log.debug("æ‰§è¡Œ processor1");
        };
    }

}
```

> ***æ³¨æ„***
>
> è§£å†³æ–¹æ³•ï¼š
>
> * ç”¨å†…ç½®ä¾èµ–æ³¨å…¥å’Œåˆå§‹åŒ–å–ä»£æ‰©å±•ä¾èµ–æ³¨å…¥å’Œåˆå§‹åŒ–
> * ç”¨é™æ€å·¥å‚æ–¹æ³•ä»£æ›¿å®ä¾‹å·¥å‚æ–¹æ³•ï¼Œé¿å…å·¥å‚å¯¹è±¡æå‰è¢«åˆ›å»º

```
public static void main(String[] args) {
        /*
            1. Aware æ¥å£ç”¨äºæ³¨å…¥ä¸€äº›ä¸å®¹å™¨ç›¸å…³ä¿¡æ¯, ä¾‹å¦‚
                a. BeanNameAware æ³¨å…¥ bean çš„åå­—
                b. BeanFactoryAware æ³¨å…¥ BeanFactory å®¹å™¨
                c. ApplicationContextAware æ³¨å…¥ ApplicationContext å®¹å™¨
                d. EmbeddedValueResolverAware ${}

         */
        GenericApplicationContext context = new GenericApplicationContext();
//        context.registerBean("myBean", MyBean.class);
//        context.registerBean("myConfig1", MyConfig1.class);
        context.registerBean("myConfig2", MyConfig2.class);
        context.registerBean(AutowiredAnnotationBeanPostProcessor.class);
        context.registerBean(CommonAnnotationBeanPostProcessor.class);
        context.registerBean(ConfigurationClassPostProcessor.class);

        /*
            2. æœ‰åŒå­¦è¯´: bã€cã€d çš„åŠŸèƒ½ç”¨ @Autowired å°±èƒ½å®ç°å•Š, ä¸ºå•¥è¿˜è¦ç”¨ Aware æ¥å£å‘¢
            ç®€å•åœ°è¯´:
                a. @Autowired çš„è§£æéœ€è¦ç”¨åˆ° bean åå¤„ç†å™¨, å±äºæ‰©å±•åŠŸèƒ½
                b. è€Œ Aware æ¥å£å±äºå†…ç½®åŠŸèƒ½, ä¸åŠ ä»»ä½•æ‰©å±•, Spring å°±èƒ½è¯†åˆ«
            æŸäº›æƒ…å†µä¸‹, æ‰©å±•åŠŸèƒ½ä¼šå¤±æ•ˆ, è€Œå†…ç½®åŠŸèƒ½ä¸ä¼šå¤±æ•ˆ

            ä¾‹1: ä½ ä¼šå‘ç°ç”¨ Aware æ³¨å…¥ ApplicationContext æˆåŠŸ, è€Œ @Autowired æ³¨å…¥ ApplicationContext å¤±è´¥
         */

        /*
            ä¾‹2: Java é…ç½®ç±»åœ¨æ·»åŠ äº† bean å·¥å‚åå¤„ç†å™¨å,
                ä½ ä¼šå‘ç°ç”¨ä¼ ç»Ÿæ¥å£æ–¹å¼çš„æ³¨å…¥å’Œåˆå§‹åŒ–ä»ç„¶æˆåŠŸ, è€Œ @Autowired å’Œ @PostConstruct çš„æ³¨å…¥å’Œåˆå§‹åŒ–å¤±è´¥
         */

        context.refresh(); // 1. beanFactory åå¤„ç†å™¨,  2. æ·»åŠ  bean åå¤„ç†å™¨, 3. åˆå§‹åŒ–å•ä¾‹
        context.close();

        /*
            å­¦åˆ°äº†ä»€ä¹ˆ
                a. Aware æ¥å£æä¾›äº†ä¸€ç§ã€å†…ç½®ã€‘ çš„æ³¨å…¥æ‰‹æ®µ, å¯ä»¥æ³¨å…¥ BeanFactory, ApplicationContext
                b. InitializingBean æ¥å£æä¾›äº†ä¸€ç§ã€å†…ç½®ã€‘çš„åˆå§‹åŒ–æ‰‹æ®µ
                c. å†…ç½®çš„æ³¨å…¥å’Œåˆå§‹åŒ–ä¸å—æ‰©å±•åŠŸèƒ½çš„å½±å“, æ€»ä¼šè¢«æ‰§è¡Œ, å› æ­¤ Spring æ¡†æ¶å†…éƒ¨çš„ç±»å¸¸ç”¨å®ƒä»¬
         */
    }
```



### 7) åˆå§‹åŒ–ä¸é”€æ¯

#### æ¼”ç¤º - åˆå§‹åŒ–é”€æ¯é¡ºåº

#### æ”¶è·ğŸ’¡

Spring æä¾›äº†å¤šç§åˆå§‹åŒ–æ‰‹æ®µï¼Œé™¤äº†è¯¾å ‚ä¸Šè®²çš„ @PostConstructï¼Œ@Bean(initMethod) ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å®ç° InitializingBean æ¥å£æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œå¦‚æœåŒä¸€ä¸ª bean ç”¨äº†ä»¥ä¸Šæ‰‹æ®µå£°æ˜äº† 3 ä¸ªåˆå§‹åŒ–æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯

1. @PostConstruct æ ‡æ³¨çš„åˆå§‹åŒ–æ–¹æ³•
2. InitializingBean æ¥å£çš„åˆå§‹åŒ–æ–¹æ³•
3. @Bean(initMethod) æŒ‡å®šçš„åˆå§‹åŒ–æ–¹æ³•



ä¸åˆå§‹åŒ–ç±»ä¼¼ï¼ŒSpring ä¹Ÿæä¾›äº†å¤šç§é”€æ¯æ‰‹æ®µï¼Œæ‰§è¡Œé¡ºåºä¸º

1. @PreDestroy æ ‡æ³¨çš„é”€æ¯æ–¹æ³•
2. DisposableBean æ¥å£çš„é”€æ¯æ–¹æ³•
3. @Bean(destroyMethod) æŒ‡å®šçš„é”€æ¯æ–¹æ³•



### 8) Scope 

åœ¨å½“å‰ç‰ˆæœ¬çš„ Spring å’Œ Spring Boot ç¨‹åºä¸­ï¼Œæ”¯æŒäº”ç§ Scope

* singletonï¼Œå®¹å™¨å¯åŠ¨æ—¶åˆ›å»ºï¼ˆæœªè®¾ç½®å»¶è¿Ÿï¼‰ï¼Œå®¹å™¨å…³é—­æ—¶é”€æ¯
* prototypeï¼Œæ¯æ¬¡ä½¿ç”¨æ—¶åˆ›å»ºï¼Œä¸ä¼šè‡ªåŠ¨é”€æ¯ï¼Œéœ€è¦è°ƒç”¨ DefaultListableBeanFactory.destroyBean(bean) é”€æ¯
* requestï¼Œæ¯æ¬¡è¯·æ±‚ç”¨åˆ°æ­¤ bean æ—¶åˆ›å»ºï¼Œè¯·æ±‚ç»“æŸæ—¶é”€æ¯
* sessionï¼Œæ¯ä¸ªä¼šè¯ç”¨åˆ°æ­¤ bean æ—¶åˆ›å»ºï¼Œä¼šè¯ç»“æŸæ—¶é”€æ¯
* applicationï¼Œweb å®¹å™¨ç”¨åˆ°æ­¤ bean æ—¶åˆ›å»ºï¼Œå®¹å™¨åœæ­¢æ—¶é”€æ¯

æœ‰äº›æ–‡ç« æåˆ°æœ‰ globalSession è¿™ä¸€ Scopeï¼Œä¹Ÿæ˜¯é™ˆæ—§çš„è¯´æ³•ï¼Œç›®å‰ Spring ä¸­å·²åºŸå¼ƒ



ä½†è¦æ³¨æ„ï¼Œå¦‚æœåœ¨ singleton æ³¨å…¥å…¶å®ƒ scope éƒ½ä¼šæœ‰é—®é¢˜ï¼Œè§£å†³æ–¹æ³•æœ‰

* @Lazy
* @Scope(proxyMode = ScopedProxyMode.TARGET_CLASS)
* ObjectFactory
* ApplicationContext.getBean



#### æ¼”ç¤º1 - request, session, application ä½œç”¨åŸŸ

* æ‰“å¼€ä¸åŒçš„æµè§ˆå™¨, åˆ·æ–° http://localhost:8080/test å³å¯æŸ¥çœ‹æ•ˆæœ

* å¦‚æœ jdk > 8, è¿è¡Œæ—¶è¯·æ·»åŠ  --add-opens java.base/java.lang=ALL-UNNAMED

  ```java
  @Scope("request")
  @Component
  public class BeanForRequest {
      private static final Logger log = LoggerFactory.getLogger(BeanForRequest.class);
  
      @PreDestroy
      public void destroy() {
          log.debug("destroy");
      }
  
  }
  ```

  

#### æ”¶è·ğŸ’¡

1. æœ‰å‡ ç§ scope
2. åœ¨ singleton ä¸­ä½¿ç”¨å…¶å®ƒå‡ ç§ scope çš„æ–¹æ³•
3. å…¶å®ƒ scope çš„é”€æ¯æ—¶æœº
   * å¯ä»¥å°†é€šè¿‡ server.servlet.session.timeout=30s è§‚å¯Ÿ session bean çš„é”€æ¯
   * ServletContextScope é”€æ¯æœºåˆ¶ç–‘ä¼¼å®ç°æœ‰è¯¯



#### åˆ†æ - singleton æ³¨å…¥å…¶å®ƒ scope å¤±æ•ˆ

ä»¥å•ä¾‹æ³¨å…¥å¤šä¾‹ä¸ºä¾‹

æœ‰ä¸€ä¸ªå•ä¾‹å¯¹è±¡ E

```java
@Component
public class E {
    private static final Logger log = LoggerFactory.getLogger(E.class);

    private F f;

    public E() {
        log.info("E()");
    }

    @Autowired
    public void setF(F f) {
        this.f = f;
        log.info("setF(F f) {}", f.getClass());
    }

    public F getF() {
        return f;
    }
}
```

è¦æ³¨å…¥çš„å¯¹è±¡ F æœŸæœ›æ˜¯å¤šä¾‹

```java
@Component
@Scope("prototype")
public class F {
    private static final Logger log = LoggerFactory.getLogger(F.class);

    public F() {
        log.info("F()");
    }
}
```

æµ‹è¯•

```java
E e = context.getBean(E.class);
F f1 = e.getF();
F f2 = e.getF();
System.out.println(f1);
System.out.println(f2);
```

è¾“å‡º

```
com.itheima.demo.cycle.F@6622fc65
com.itheima.demo.cycle.F@6622fc65
```

å‘ç°å®ƒä»¬æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯æœŸæœ›çš„å¤šä¾‹å¯¹è±¡



å¯¹äºå•ä¾‹å¯¹è±¡æ¥è®²ï¼Œä¾èµ–æ³¨å…¥ä»…å‘ç”Ÿäº†ä¸€æ¬¡ï¼Œåç»­å†æ²¡æœ‰ç”¨åˆ°å¤šä¾‹çš„ Fï¼Œå› æ­¤ E ç”¨çš„å§‹ç»ˆæ˜¯ç¬¬ä¸€æ¬¡ä¾èµ–æ³¨å…¥çš„ F

```mermaid
graph LR

e1(e åˆ›å»º)
e2(e set æ³¨å…¥ f)

f1(f åˆ›å»º)

e1-->f1-->e2

```

è§£å†³

* ä»ç„¶ä½¿ç”¨ @Lazy ç”Ÿæˆä»£ç†
* ä»£ç†å¯¹è±¡è™½ç„¶è¿˜æ˜¯åŒä¸€ä¸ªï¼Œä½†å½“æ¯æ¬¡**ä½¿ç”¨ä»£ç†å¯¹è±¡çš„ä»»æ„æ–¹æ³•**æ—¶ï¼Œç”±ä»£ç†åˆ›å»ºæ–°çš„ f å¯¹è±¡

```mermaid
graph LR

e1(e åˆ›å»º)
e2(e set æ³¨å…¥ fä»£ç†)

f1(f åˆ›å»º)
f2(f åˆ›å»º)
f3(f åˆ›å»º)

e1-->e2
e2--ä½¿ç”¨fæ–¹æ³•-->f1
e2--ä½¿ç”¨fæ–¹æ³•-->f2
e2--ä½¿ç”¨fæ–¹æ³•-->f3

```

```java
@Component
public class E {

    @Autowired
    @Lazy
    public void setF(F f) {
        this.f = f;
        log.info("setF(F f) {}", f.getClass());
    }

    // ...
}
```

> ***æ³¨æ„***
>
> * @Lazy åŠ åœ¨ä¹Ÿå¯ä»¥åŠ åœ¨æˆå‘˜å˜é‡ä¸Šï¼Œä½†åŠ åœ¨ set æ–¹æ³•ä¸Šçš„ç›®çš„æ˜¯å¯ä»¥è§‚å¯Ÿè¾“å‡ºï¼ŒåŠ åœ¨æˆå‘˜å˜é‡ä¸Šå°±ä¸è¡Œäº†
> * @Autowired åŠ åœ¨ set æ–¹æ³•çš„ç›®çš„ç±»ä¼¼

è¾“å‡º

```
E: setF(F f) class com.itheima.demo.cycle.F$$EnhancerBySpringCGLIB$$8b54f2bc
F: F()
com.itheima.demo.cycle.F@3a6f2de3
F: F()
com.itheima.demo.cycle.F@56303b57
```

ä»è¾“å‡ºæ—¥å¿—å¯ä»¥çœ‹åˆ°è°ƒç”¨ setF æ–¹æ³•æ—¶ï¼Œf å¯¹è±¡çš„ç±»å‹æ˜¯ä»£ç†ç±»å‹



#### æ¼”ç¤º2 - 4ç§è§£å†³æ–¹æ³•

* å¦‚æœ jdk > 8, è¿è¡Œæ—¶è¯·æ·»åŠ  --add-opens java.base/java.lang=ALL-UNNAMED

#### æ”¶è·ğŸ’¡

1. å•ä¾‹æ³¨å…¥å…¶å®ƒ scope çš„å››ç§è§£å†³æ–¹æ³•
   * @Lazy
   * @Scope(value = "prototype", proxyMode = ScopedProxyMode.TARGET_CLASS)
   * ObjectFactory 
   * ApplicationContext
2. è§£å†³æ–¹æ³•è™½ç„¶ä¸åŒï¼Œä½†ç†å¿µä¸Šæ®Šé€”åŒå½’: éƒ½æ˜¯æ¨è¿Ÿå…¶å®ƒ scope bean çš„è·å–
<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.59" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vuepress-theme-hope-docs-demo.netlify.app/article/os/filesystem.html"><meta property="og:site_name" content="Pineapple Coding"><meta property="og:title" content="æ–‡ä»¶ç³»ç»Ÿ"><meta property="og:description" content="Linuxæ“ä½œç³»ç»Ÿ"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="article:tag" content="OS"><title>æ–‡ä»¶ç³»ç»Ÿ | Pineapple Coding</title><meta name="description" content="Linuxæ“ä½œç³»ç»Ÿ">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-49f3aa5b.css" as="style"><link rel="stylesheet" href="/assets/style-49f3aa5b.css">
    <link rel="modulepreload" href="/assets/app-89ebfde6.js"><link rel="modulepreload" href="/assets/framework-3845b112.js"><link rel="modulepreload" href="/assets/filesystem.html-1df56d68.js"><link rel="modulepreload" href="/assets/filesystem.html-6c4ee874.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/pineapple.png" alt="Pineapple Coding"><!----><span class="site-name hide-in-pad">Pineapple Coding</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="é¦–é¡µ"><span class="icon iconfont icon-home"></span>é¦–é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a href="/article/os/overview.html" class="nav-link" aria-label="åŸºç¡€å­¦ä¹ "><span class="icon iconfont icon-creative"></span>åŸºç¡€å­¦ä¹ <!----></a></div><div class="nav-item hide-in-mobile"><a href="/article/interview/" class="nav-link" aria-label="é¢è¯•çªå‡»"><span class="icon iconfont icon-edit"></span>é¢è¯•çªå‡»<!----></a></div><div class="nav-item hide-in-mobile"><a href="/article/algorithm/binarysearch/%E4%BA%8C%E5%88%86%E6%B3%95.html" class="nav-link" aria-label="ç®—æ³•ç¬”è®°"><span class="icon iconfont icon-note"></span>ç®—æ³•ç¬”è®°<!----></a></div><div class="nav-item hide-in-mobile"><a href="/aboutme.html" class="nav-link" aria-label="å…³äºæˆ‘"><span class="icon iconfont icon-home"></span>å…³äºæˆ‘<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/" class="nav-link sidebar-link sidebar-page" aria-label="é¦–é¡µ"><span class="icon iconfont icon-home"></span>é¦–é¡µ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-process"></span><span class="title">è®¡ç®—æœºç³»ç»ŸåŸºç¡€</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-centos"></span><span class="title">æ“ä½œç³»ç»ŸåŸºç¡€</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-network"></span><span class="title">è®¡ç®—æœºç½‘ç»œåŸºç¡€</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-java"></span><span class="title">Java</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-mysql"></span><span class="title">MySQL</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-link"></span><span class="title">Redis</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-leaf"></span><span class="title">Spring</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-python"></span><span class="title">Python</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-generic"></span><span class="title">Golang</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-vscode"></span><span class="title">C/C++</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-function"></span><span class="title">ç®—æ³•</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->æ–‡ä»¶ç³»ç»Ÿ</h1><div class="page-info"><span class="author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="author-item">Pineapple</span></span><span property="author" content="Pineapple"></span></span><!----><!----><span class="category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="category-item category0 clickable" role="navigation">Linux</span><meta property="articleSection" content="Linux"></span><span class="tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="tag-item tag-item1 clickable" role="navigation">OS</span><meta property="keywords" content="OS"></span><span class="reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 35 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT35M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#_1-æ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„" class="router-link-active router-link-exact-active toc-link level2">1.æ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#i-node-table" class="router-link-active router-link-exact-active toc-link level3">I-node table</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ-vfs" class="router-link-active router-link-exact-active toc-link level3">è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ (VFS)</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#_2-è¿›ç¨‹å¦‚ä½•æ“ä½œæ–‡ä»¶" class="router-link-active router-link-exact-active toc-link level2">2.è¿›ç¨‹å¦‚ä½•æ“ä½œæ–‡ä»¶</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#è¿›ç¨‹ä¸­çš„æ–‡ä»¶ç»“æ„" class="router-link-active router-link-exact-active toc-link level3">è¿›ç¨‹ä¸­çš„æ–‡ä»¶ç»“æ„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#è¿›ç¨‹æ‰“å¼€æ–‡ä»¶" class="router-link-active router-link-exact-active toc-link level3">è¿›ç¨‹æ‰“å¼€æ–‡ä»¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#æ–‡ä»¶çš„ç»“æ„" class="router-link-active router-link-exact-active toc-link level3">æ–‡ä»¶çš„ç»“æ„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#è¿›ç¨‹è¯»æ–‡ä»¶" class="router-link-active router-link-exact-active toc-link level3">è¿›ç¨‹è¯»æ–‡ä»¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#è¿›ç¨‹å†™æ–‡ä»¶" class="router-link-active router-link-exact-active toc-link level3">è¿›ç¨‹å†™æ–‡ä»¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#è¿›ç¨‹å…³é—­æ–‡ä»¶" class="router-link-active router-link-exact-active toc-link level3">è¿›ç¨‹å…³é—­æ–‡ä»¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#æ–‡ä»¶çš„åç§»é‡" class="router-link-active router-link-exact-active toc-link level3">æ–‡ä»¶çš„åç§»é‡</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#_3-ç‰¹æ®Šæ–‡ä»¶çš„å°è£…" class="router-link-active router-link-exact-active toc-link level2">3.ç‰¹æ®Šæ–‡ä»¶çš„å°è£…</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#å¯¹socketçš„å°è£…" class="router-link-active router-link-exact-active toc-link level2">å¯¹Socketçš„å°è£…</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#æ‰“å¼€ä¸€ä¸ªsocket" class="router-link-active router-link-exact-active toc-link level3">æ‰“å¼€ä¸€ä¸ªsocket</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#ç»™socketç»‘å®šç«¯å£" class="router-link-active router-link-exact-active toc-link level3">ç»™socketç»‘å®šç«¯å£</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#ç›‘å¬socketç»‘å®šçš„ç«¯å£" class="router-link-active router-link-exact-active toc-link level3">ç›‘å¬socketç»‘å®šçš„ç«¯å£</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#ä¸å®¢æˆ·ç«¯çš„socketå»ºç«‹è¿æ¥" class="router-link-active router-link-exact-active toc-link level3">ä¸å®¢æˆ·ç«¯çš„socketå»ºç«‹è¿æ¥</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#æ€»ç»“" class="router-link-active router-link-exact-active toc-link level3">æ€»ç»“</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#å¯¹ç›®å½•çš„å°è£…" class="router-link-active router-link-exact-active toc-link level2">å¯¹ç›®å½•çš„å°è£…</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#è½¯è¿æ¥å’Œç¡¬è¿æ¥" class="router-link-active router-link-exact-active toc-link level3">è½¯è¿æ¥å’Œç¡¬è¿æ¥</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#_4-æ–‡ä»¶i-o" class="router-link-active router-link-exact-active toc-link level2">4.æ–‡ä»¶I/O</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#i-o-buffer" class="router-link-active router-link-exact-active toc-link level2">I/O buffer</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#å†…æ ¸ç¼“å­˜åŒº" class="router-link-active router-link-exact-active toc-link level3">å†…æ ¸ç¼“å­˜åŒº</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#ç”¨æˆ·æ€ç¼“å­˜åŒº" class="router-link-active router-link-exact-active toc-link level3">ç”¨æˆ·æ€ç¼“å­˜åŒº</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#ç›´æ¥i-o" class="router-link-active router-link-exact-active toc-link level3">ç›´æ¥I/O</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#i-oæ¨¡å‹" class="router-link-active router-link-exact-active toc-link level2">I/Oæ¨¡å‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#_5-fd-æ–‡ä»¶æè¿°ç¬¦" class="router-link-active router-link-exact-active toc-link level2">5.fd(æ–‡ä»¶æè¿°ç¬¦)</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#æ™®é€šfd" class="router-link-active router-link-exact-active toc-link level3">æ™®é€šfd</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#åŒ¿å-fd" class="router-link-active router-link-exact-active toc-link level3">åŒ¿å fd</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#socket-fd" class="router-link-active router-link-exact-active toc-link level3">Socket fd</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#event-fd" class="router-link-active router-link-exact-active toc-link level3">Event fd</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#signal-fd" class="router-link-active router-link-exact-active toc-link level3">Signal fd</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/article/os/filesystem.html#timer-fd" class="router-link-active router-link-exact-active toc-link level3">**Timer fd **</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><p>Linuxçš„è®¾è®¡å“²å­¦æ˜¯ã€Œ<strong>ä¸€åˆ‡çš†æ–‡ä»¶</strong>ã€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒLinuxç³»ç»Ÿä¸­çš„ä¸€åˆ‡å®ä½“éƒ½å¯ä»¥æŠ½è±¡ä¸ºæ–‡ä»¶è¿™ä¸€æ¦‚å¿µã€‚æ‰€ä»¥ï¼Œå…ˆäº†è§£ä¸€ä¸‹Linuxæ˜¯æ€æ ·å®ç°<strong>æ–‡ä»¶</strong>è¿™ä¸€æ¦‚å¿µæ˜¯ç›¸å¯¹é‡è¦çš„ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»ä»¥ä¸‹å‡ ç‚¹ç»¼è§‚Linuxçš„æ–‡ä»¶ç³»ç»Ÿæ˜¯è¿›è¡Œå¦‚ä½•å·¥ä½œçš„</p><h2 id="_1-æ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_1-æ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„" aria-hidden="true">#</a> <strong>1.æ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„</strong></h2><p>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ†é…ç©ºé—´çš„åŸºæœ¬å•ä½æ˜¯é€»è¾‘å—ï¼Œé€»è¾‘å—æ˜¯æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨çš„ç£ç›˜è®¾å¤‡ä¸Šçš„å¤šä¸ªè¿ç»­ç‰©ç†å­˜å‚¨åŒºé—´ã€‚ä¾‹å¦‚ï¼Œåœ¨ext2æ–‡ä»¶ç³»ç»Ÿä¸Šçš„é€»è¾‘å—å¤§å°ä¸º1024ã€2048æˆ–4096å­—èŠ‚ã€‚</p><figure><img src="/os/image-20221005160310792.png" alt="image-20221005160310792" tabindex="0" loading="lazy"><figcaption>image-20221005160310792</figcaption></figure><p><strong>Boot Block</strong>ï¼šå¯åŠ¨å—å¹¶æ²¡æœ‰è¢«æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ã€‚å…¶ä¸­åŒ…å«çš„æ˜¯ç”¨äºå¼•å¯¼æ“ä½œç³»ç»Ÿçš„ä¿¡æ¯ã€‚å°½ç®¡æ“ä½œç³»ç»Ÿåªéœ€è¦ä¸€ä¸ªå¼•å¯¼å—ï¼Œä½†æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿéƒ½æœ‰ä¸€ä¸ªå¼•å¯¼å—(å…¶ä¸­å¤§å¤šæ•°æ˜¯æœªä½¿ç”¨çš„)ã€‚</p><p><strong>Superblock</strong>:è¿™æ˜¯ä¸€ä¸ªå•ç‹¬çš„å—ï¼Œç´§æŒ¨ç€å¼•å¯¼å—ï¼Œå®ƒåŒ…å«å…³äºæ–‡ä»¶ç³»ç»Ÿçš„å‚æ•°ä¿¡æ¯ï¼ŒåŒ…æ‹¬:</p><ul><li>inodeè¡¨çš„æ€»é‡ã€ä½¿ç”¨é‡ã€å‰©ä½™é‡ï¼ˆé€šè¿‡ä½å›¾æ ‡è¯†ï¼‰ç­‰;</li><li>data blockçš„æ€»é‡ã€ä½¿ç”¨é‡ã€å‰©ä½™é‡ï¼ˆé€šè¿‡ä½å›¾æ ‡è¯†ï¼‰ç­‰;</li><li>æ–‡ä»¶ç³»ç»Ÿæ ¼å¼ç­‰ã€‚</li></ul><p>ä½äºåŒä¸€ç‰©ç†è®¾å¤‡ä¸Šçš„ä¸åŒæ–‡ä»¶ç³»ç»Ÿå¯ä»¥å…·æœ‰ä¸åŒçš„ç±»å‹å’Œå¤§å°ï¼Œå¹¶ä¸”å…·æœ‰ä¸åŒçš„å‚æ•°è®¾ç½®(ä¾‹å¦‚ï¼Œå—å¤§å°)ã€‚è¿™æ˜¯å°†ç£ç›˜åˆ†å‰²ä¸ºå¤šä¸ªåˆ†åŒºçš„åŸå› ä¹‹ä¸€ã€‚</p><p><strong>I-node table</strong>:æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ¯ä¸ªæ–‡ä»¶æˆ–ç›®å½•åœ¨I-nodeè¡¨ä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ¡ç›®ã€‚è¿™ä¸ªæ¡ç›®è®°å½•äº†å…³äºæ–‡ä»¶çš„å„ç§ä¿¡æ¯ã€‚</p><p><strong>Data block</strong>:æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç»å¤§å¤šæ•°ç©ºé—´ç”¨äºæ„æˆæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶å’Œç›®å½•çš„æ•°æ®å—ã€‚</p><h3 id="i-node-table" tabindex="-1"><a class="header-anchor" href="#i-node-table" aria-hidden="true">#</a> <strong>I-node table</strong></h3><p>æ–‡ä»¶ç³»ç»Ÿçš„i-node tableä¸ºæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ¯ä¸ªæ–‡ä»¶ä¿å­˜ä¸€ä¸ªi-nodeæŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥æ–‡ä»¶çš„åœ°å€ã€‚</p><p>i-nodeé€šè¿‡å®ƒä»¬åœ¨i-nodeè¡¨ä¸­çš„é¡ºåºä½ç½®è¿›è¡Œæ•°å­—æ ‡è¯†ã€‚</p><figure><img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/æ“ä½œç³»ç»Ÿ/æ–‡ä»¶ç³»ç»Ÿ/Unix å¤šçº§ç´¢å¼•.png" alt="æ—©æœŸ Unix æ–‡ä»¶ç³»ç»Ÿ" tabindex="0" loading="lazy"><figcaption>æ—©æœŸ Unix æ–‡ä»¶ç³»ç»Ÿ</figcaption></figure><h3 id="è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ-vfs" tabindex="-1"><a class="header-anchor" href="#è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ-vfs" aria-hidden="true">#</a> <strong>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ (VFS)</strong></h3><p>æ“ä½œç³»ç»Ÿæ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿæœ‰å¾ˆå¤šï¼Œå¦‚ext2ã€ext3ã€VFATã€NFSç­‰ã€‚å¦‚æœæ¯æ¬¡å®ç°å…·ä½“çš„æ–‡ä»¶ä¿å­˜éœ€è¦è€ƒè™‘å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿçš„ä¸åŒå®ç°æ˜¯ç›¸å½“éº»çƒ¦çš„ã€‚</p><p>VFSä¸ºæ–‡ä»¶ç³»ç»Ÿæ“ä½œå®šä¹‰äº†ä¸€ä¸ªé€šç”¨æ¥å£ã€‚æ‰€æœ‰å¤„ç†æ–‡ä»¶çš„ç¨‹åºéƒ½æ ¹æ®è¿™ä¸ªé€šç”¨æ¥å£æŒ‡å®šå®ƒä»¬çš„æ“ä½œã€‚å¹¶ä¸”æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½æä¾›VFSæ¥å£çš„å®ç°ã€‚è¿™æ ·ï¼Œåº”ç”¨ç¨‹åºå°±åªéœ€è¦å’ŒVFSæ‰“äº¤é“å³å¯å®ç°ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œäº†ã€‚</p><h2 id="_2-è¿›ç¨‹å¦‚ä½•æ“ä½œæ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#_2-è¿›ç¨‹å¦‚ä½•æ“ä½œæ–‡ä»¶" aria-hidden="true">#</a> 2.è¿›ç¨‹å¦‚ä½•æ“ä½œæ–‡ä»¶</h2><p>å¯¹äºä¸€ä¸ªè¿›ç¨‹è€Œè¨€ï¼Œå¯¹æ–‡ä»¶çš„æ“ä½œä¸€èˆ¬åˆ†ä¸ºä¸‰ç§ç±»å‹æ‰“å¼€æ–‡ä»¶ã€è¯»/å†™æ–‡ä»¶ã€å…³é—­æ–‡ä»¶ã€‚</p><p>æ“ä½œæ–‡ä»¶çš„æ¨¡å¼ä¸ºï¼š</p><p><code>æ‰“å¼€æ–‡ä»¶-&gt;è¯»/å†™æ–‡ä»¶-&gt;å…³é—­æ–‡ä»¶</code></p><p>è¿›ç¨‹æ˜¯å¦‚ä½•è¿›è¡Œè¿™ä¸‰ä¸ªæ“ä½œçš„å‘¢ï¼Ÿ</p><p>åœ¨æ­¤ä¹‹å‰ï¼Œé¦–å…ˆè¦çœ‹ä¸‹åœ¨Linuxå†…æ ¸ä¸­ï¼Œè¿›ç¨‹æ˜¯å¦‚ä½•è¡¨ç¤ºçš„ã€‚</p><h3 id="è¿›ç¨‹ä¸­çš„æ–‡ä»¶ç»“æ„" tabindex="-1"><a class="header-anchor" href="#è¿›ç¨‹ä¸­çš„æ–‡ä»¶ç»“æ„" aria-hidden="true">#</a> <strong>è¿›ç¨‹ä¸­çš„æ–‡ä»¶ç»“æ„</strong></h3><p>è¿›ç¨‹åœ¨linuxä¸­ç”¨<code>task_struct</code>æ¥è¿›è¡ŒæŠ½è±¡ã€‚åœ¨task_structä¸­ï¼Œå…³äºæ–‡ä»¶çš„å®šä¹‰æ˜¯</p><div class="language-C line-numbers-mode" data-ext="C"><pre class="language-C"><code>//linux-master/linux-master/kernel/sched/sched.h
struct task_struct {
    // ...
    struct files_struct     *files;
    // ...
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™å°±æ˜¯è¯´ æ¯ä¸ªè¿›ç¨‹é‡Œéƒ½ä¼šä¿å­˜ä¸€ä¸ªfilesçš„æŒ‡é’ˆ æŒ‡å‘ä¸€ä¸ªfiles_structçš„ç»“æ„ä½“ã€‚</p><p>é‚£ä¹ˆè¿™ä¸ªfiles_structçš„ç»“æ„ä½“çš„æ„æˆåˆæ˜¯ä»€ä¹ˆå‘¢</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//linux-master/linux-master/include/linux/fdtable.h</span>
<span class="token keyword">struct</span> <span class="token class-name">files_struct</span> <span class="token punctuation">{</span>
  <span class="token comment">/*
   * read mostly part
   */</span>
	<span class="token class-name">atomic_t</span> count<span class="token punctuation">;</span>
	bool resize_in_progress<span class="token punctuation">;</span>
	<span class="token class-name">wait_queue_head_t</span> resize_wait<span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">fdtable</span> __rcu <span class="token operator">*</span>fdt<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">fdtable</span> fdtab<span class="token punctuation">;</span>
  <span class="token comment">/*
   * written part on a separate cache line in SMP
   */</span>
	<span class="token class-name">spinlock_t</span> file_lock ____cacheline_aligned_in_smp<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> next_fd<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> close_on_exec_init<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> open_fds_init<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> full_fds_bits_init<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">file</span> __rcu <span class="token operator">*</span> fd_array<span class="token punctuation">[</span>NR_OPEN_DEFAULT<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸€ä¸ª<code>fdtable</code>çš„æŒ‡é’ˆ <code>fdt</code> å’Œä¸€ä¸ª<code>fdtable</code>çš„å®ä¾‹ <code>fdtab</code>ã€‚ä»¥åŠä¸€ä¸ªå­˜å‚¨*fileç±»å‹çš„æ•°ç»„<code>fd_array</code>ä»¥åŠå…¶ä»–ä¸€äº›ä¸fdæ“ä½œç›¸å…³çš„å­—æ®µã€‚</p><p>åœ¨<code>fd_array</code>ä¸­å­˜å‚¨çš„ä¾¿æ˜¯è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶çš„æ•°ç»„ã€‚æ•°ç»„å­˜å‚¨çš„ç±»å‹ struct *fileçš„æ–‡ä»¶æŒ‡é’ˆã€‚ä½†æ˜¯è¿™ä¸ªæ•°ç»„æ˜¯å›ºå®šé•¿åº¦çš„ï¼Œå¦‚æœè¿›ç¨‹æ‰“å¼€äº†è¶…è¿‡è¯¥æ•°ç›®çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆå°±éœ€è¦é€šè¿‡fdtableå¯¹è¯¥æ•°ç»„è¿›è¡ŒåŠ¨æ€ç®¡ç†äº†ã€‚</p><p>fdtableçš„ç»“æ„å¦‚ä¸‹</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//linux-master/linux-master/include/linux/fdtable.h</span>
<span class="token keyword">struct</span> <span class="token class-name">fdtable</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> max_fds<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">file</span> __rcu <span class="token operator">*</span><span class="token operator">*</span>fd<span class="token punctuation">;</span>      <span class="token comment">/* current fd array */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>close_on_exec<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>open_fds<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>full_fds_bits<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">rcu_head</span> rcu<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>fd</code>å­—æ®µçš„ç±»å‹æœ‰ç‚¹è´¹è§£ï¼Œæ‹†å¼€æ¥çœ‹fdæ˜¯ä¸€ä¸ªæŒ‡å‘fileæŒ‡é’ˆç±»å‹çš„æŒ‡é’ˆã€‚å…¶å®è¯¥å­—æ®µæŒ‡å‘çš„å°±æ˜¯å½“å‰fd_arrayçš„åœ°å€ã€‚ä¹Ÿå°±æ˜¯è¯´ fdå…¶å®å°±æ˜¯fd_arrayè¿™ä¸ªæ•°ç»„çš„å¼•ç”¨ã€‚å½“ä¸ç”¨æˆ·æ€äº¤äº’çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡fdt-&gt;fd[fd]è·å–è¯¥*fileæŒ‡é’ˆã€‚</p><p>å½“ä¸€ä¸ªè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æ•°ç›®æ²¡æœ‰è¾¾åˆ°max_fdsçš„æ—¶å€™ï¼Œç›´æ¥ä»fdtableé‡Œç”³è¯·æ–°çš„ä½ç½®ï¼Œå½“è¶…è¿‡æ—¶ï¼Œé€šè¿‡ç”³è¯·ä¸€ä¸ªæ–°çš„fdtæ•°ç»„ç»“æ„ï¼Œå¹¶æŠŠå½“å‰æ‰“å¼€çš„è¿›è¡Œcopyä¹‹åï¼Œå°†å½“å‰çš„æŒ‡é’ˆæŒ‡å‘æ–°çš„tableå®Œæˆæ‰©å®¹ã€‚è¿™å°±æ˜¯fdtæŒ‡é’ˆçš„ä½œç”¨ã€‚</p><figure><img src="/os/image-20221005210948015.png" alt="image-20221005210948015" tabindex="0" loading="lazy"><figcaption>image-20221005210948015</figcaption></figure><p>äº†è§£äº†è¿™äº›ä¹‹åï¼Œå†å°è¯•çœ‹ä¸€ä¸‹å†…æ ¸åœ¨æ‰“å¼€æ–‡ä»¶æ—¶åšçš„æ“ä½œ</p><h3 id="è¿›ç¨‹æ‰“å¼€æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#è¿›ç¨‹æ‰“å¼€æ–‡ä»¶" aria-hidden="true">#</a> <strong>è¿›ç¨‹æ‰“å¼€æ–‡ä»¶</strong></h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">long</span> <span class="token function">do_sys_open</span><span class="token punctuation">(</span><span class="token keyword">int</span> dfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token class-name">umode_t</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">open_flags</span> op<span class="token punctuation">;</span>
        <span class="token comment">/*flagæ˜¯ç”¨æˆ·ä¼ é€’çš„å‚æ•°ï¼Œæ£€æŸ¥åˆæ³•æ€§å¹¶æ ¹æ®modeç”Ÿæˆæ–°çš„flags*/</span>
        <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">build_open_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> <span class="token operator">&amp;</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">filename</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
                <span class="token keyword">return</span> fd<span class="token punctuation">;</span>

        tmp <span class="token operator">=</span> <span class="token function">getname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*ç”³è¯·æ–°çš„fd*/</span>
        fd <span class="token operator">=</span> <span class="token function">get_unused_fd_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token function">do_filp_open</span><span class="token punctuation">(</span>dfd<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">put_unused_fd</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        fd <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">/*äº§ç”Ÿæ‰“å¼€æ–‡ä»¶çš„é€šçŸ¥äº‹ä»¶*/</span>
                        <span class="token function">fsnotify_open</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">/*å°†fdå’Œæ–‡ä»¶ç®¡ç†ç»“æ„å¯¹åº”èµ·æ¥*/</span>
                        <span class="token function">fd_install</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">putname</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//ç”³è¯·fdçš„å‡½æ•°</span>
<span class="token comment">/*do_sys_open-&gt;get_unused_fd_flags-&gt;alloc_fd(0, (flags))*/</span>
<span class="token keyword">int</span> <span class="token function">__alloc_fd</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">files_struct</span> <span class="token operator">*</span>files<span class="token punctuation">,</span>
               <span class="token keyword">unsigned</span> start<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> end<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
        <span class="token keyword">int</span> error<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">fdtable</span> <span class="token operator">*</span>fdt<span class="token punctuation">;</span>

        <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>files<span class="token operator">-&gt;</span>file_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
repeat<span class="token operator">:</span>
        fdt <span class="token operator">=</span> <span class="token function">files_fdtable</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fd <span class="token operator">=</span> start<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> files<span class="token operator">-&gt;</span>next_fd<span class="token punctuation">)</span>
                fd <span class="token operator">=</span> files<span class="token operator">-&gt;</span>next_fd<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> fdt<span class="token operator">-&gt;</span>max_fds<span class="token punctuation">)</span>
                fd <span class="token operator">=</span> <span class="token function">find_next_fd</span><span class="token punctuation">(</span>fdt<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * N.B. For clone tasks sharing a files structure, this test
         * will limit the total number of files that can be opened.
         */</span>
        error <span class="token operator">=</span> <span class="token operator">-</span>EMFILE<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&gt;=</span> end<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>

        error <span class="token operator">=</span> <span class="token function">expand_files</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>

        <span class="token comment">/*
         * If we needed to expand the fs array we
         * might have blocked - try again.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> repeat<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">&lt;=</span> files<span class="token operator">-&gt;</span>next_fd<span class="token punctuation">)</span>
                files<span class="token operator">-&gt;</span>next_fd <span class="token operator">=</span> fd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token function">__set_open_fd</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> fdt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> O_CLOEXEC<span class="token punctuation">)</span>
                <span class="token function">__set_close_on_exec</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> fdt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
                <span class="token function">__clear_close_on_exec</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> fdt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        error <span class="token operator">=</span> fd<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">1</span></span></span>
        <span class="token comment">/* Sanity check */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rcu_access_pointer</span><span class="token punctuation">(</span>fdt<span class="token operator">-&gt;</span>fd<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">&quot;alloc_fd: slot %d not NULL!\n&quot;</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">rcu_assign_pointer</span><span class="token punctuation">(</span>fdt<span class="token operator">-&gt;</span>fd<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

out<span class="token operator">:</span>
        <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>files<span class="token operator">-&gt;</span>file_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//å°†fdå’Œfilesåœ¨fdtableä¸­ç›¸å…³è”</span>
<span class="token keyword">void</span> <span class="token function">__fd_install</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">files_struct</span> <span class="token operator">*</span>files<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">fdtable</span> <span class="token operator">*</span>fdt<span class="token punctuation">;</span>

        <span class="token function">might_sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">rcu_read_lock_sched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>files<span class="token operator">-&gt;</span>resize_in_progress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">rcu_read_unlock_sched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">wait_event</span><span class="token punctuation">(</span>files<span class="token operator">-&gt;</span>resize_wait<span class="token punctuation">,</span> <span class="token operator">!</span>files<span class="token operator">-&gt;</span>resize_in_progress<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">rcu_read_lock_sched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* coupled with smp_wmb() in expand_fdtable() */</span>
        <span class="token function">smp_rmb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fdt <span class="token operator">=</span> <span class="token function">rcu_dereference_sched</span><span class="token punctuation">(</span>files<span class="token operator">-&gt;</span>fdt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">BUG_ON</span><span class="token punctuation">(</span>fdt<span class="token operator">-&gt;</span>fd<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">rcu_assign_pointer</span><span class="token punctuation">(</span>fdt<span class="token operator">-&gt;</span>fd<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">rcu_read_unlock_sched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡fdt-&gt;fd[fd]æ¥è·å–è¯¥æ‰“å¼€æ–‡ä»¶çš„*fileæŒ‡é’ˆ</p><p>æ‰€ä»¥è¯´æ˜fdæœ¬è´¨ä¸Šå°±æ˜¯fd_arrayçš„ä¸‹æ ‡æˆ–è€…è¯´æ˜¯ç´¢å¼•ã€‚</p><p>æ­¤æ—¶ä¹Ÿä¾¿æœ‰äº†æ‰“å¼€æ–‡ä»¶çš„ç³»ç»Ÿè°ƒç”¨</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* mode_t mode */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								Returns file descriptor on success<span class="token punctuation">,</span> or â€“<span class="token number">1</span> on error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥ç³»ç»Ÿè°ƒç”¨è¿”å›çš„å°±æ˜¯æ–‡ä»¶æè¿°ç¬¦ ä¹Ÿå°±æ˜¯fd</p><h3 id="æ–‡ä»¶çš„ç»“æ„" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶çš„ç»“æ„" aria-hidden="true">#</a> æ–‡ä»¶çš„ç»“æ„</h3><p>åœ¨å‰é¢è®²åˆ°fdå°±æ˜¯fd_arrayçš„ç´¢å¼•ï¼Œfd_arrayä¸­å­˜å‚¨çš„å˜é‡ä¸º*fileç»“æ„ä½“ï¼Œé‚£ä¹ˆè¿™ä¸ª *fileç»“æ„ä½“åˆæ˜¯ä»€ä¹ˆæ ·å­çš„ç»“æ„å‘¢ï¼Ÿ</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token punctuation">{</span>
	<span class="token keyword">union</span> <span class="token punctuation">{</span>
		<span class="token keyword">struct</span> <span class="token class-name">llist_node</span>	f_llist<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">rcu_head</span> 	f_rcuhead<span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">int</span> 		f_iocb_flags<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    
	<span class="token keyword">struct</span> <span class="token class-name">path</span>		f_path<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">inode</span>		<span class="token operator">*</span>f_inode<span class="token punctuation">;</span>	<span class="token comment">/* cached value */</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span>	<span class="token operator">*</span>f_op<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * Protects f_ep, f_flags.
	 * Must not be taken from IRQ context.
	 */</span>
	<span class="token class-name">spinlock_t</span>		f_lock<span class="token punctuation">;</span>
	<span class="token class-name">atomic_long_t</span>		f_count<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> 		f_flags<span class="token punctuation">;</span>
	<span class="token class-name">fmode_t</span>			f_mode<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mutex</span>		f_pos_lock<span class="token punctuation">;</span>
	<span class="token class-name">loff_t</span>			f_pos<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">fown_struct</span>	f_owner<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cred</span>	<span class="token operator">*</span>f_cred<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">file_ra_state</span>	f_ra<span class="token punctuation">;</span>

	u64			f_version<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_SECURITY</span></span>
	<span class="token keyword">void</span>			<span class="token operator">*</span>f_security<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token comment">/* needed for tty driver, and maybe others */</span>
	<span class="token keyword">void</span>			<span class="token operator">*</span>private_data<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_EPOLL</span></span>
	<span class="token comment">/* Used by fs/eventpoll.c to link all the hooks to this file */</span>
	<span class="token keyword">struct</span> <span class="token class-name">hlist_head</span>	<span class="token operator">*</span>f_ep<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* #ifdef CONFIG_EPOLL */</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">address_space</span>	<span class="token operator">*</span>f_mapping<span class="token punctuation">;</span>
	<span class="token class-name">errseq_t</span>		f_wb_err<span class="token punctuation">;</span>
	<span class="token class-name">errseq_t</span>		f_sb_err<span class="token punctuation">;</span> <span class="token comment">/* for syncfs */</span>
<span class="token punctuation">}</span> __randomize_layout
  <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">aligned</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>f_path</code>ï¼šæ ‡è¯†è¯¥æ–‡ä»¶åœ°å€ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶å</p><p><code>f_inode</code>ï¼šVFSç³»ç»Ÿçš„inodeæŒ‡é’ˆ</p><p><code>f_pos</code>ï¼šæ–‡ä»¶çš„åç§»é‡</p><p>é¦–å…ˆéœ€è¦æ˜ç¡®ï¼Œè¿™ä¸ª*fileç±»å‹çš„æŒ‡é’ˆä¸æ˜¯åªå±äºæŸä¸ªè¿›ç¨‹çš„ï¼Œè€Œæ˜¯åœ¨å…¨å±€å¯¹æ‰€æœ‰çš„è¿›ç¨‹å…±äº«çš„ã€‚</p><p>è¯•æƒ³ä¸€ç§æƒ…å†µï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹å¯¹æŸä¸ªæ–‡ä»¶è¿›è¡Œå†™æ“ä½œï¼Œè€Œå¦ä¸€ä¸ªä¹Ÿè¿›è¡Œå†™æ“ä½œï¼Œè¿™æ ·æ˜¯ä¼šå¯¼è‡´é”™è¯¯çš„å‘ç”Ÿçš„ã€‚æ‰€ä»¥éœ€è¦ç”¨ä¸€äº›åŒæ­¥é”çš„æ‰‹æ®µä¿è¯ä¸ä¼šäº§ç”ŸåŒæ—¶å†™çš„æ“ä½œã€‚æ‰€ä»¥*file åº”è¯¥æ˜¯å…¨å±€æ‰€æœ‰è¿›ç¨‹å…±äº«çš„ã€‚</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•é€šè¿‡fileç»“æ„ä½“æ‰¾åˆ°æˆ‘ä»¬æƒ³è¦æ‰“å¼€çš„æ–‡ä»¶å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆåœ¨inodeç»“æ„ä½“å½“ä¸­ï¼Œinodeä¿å­˜äº†ä¸€äº›æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ–‡ä»¶ç›¸å…³çš„åŸºæœ¬ä¿¡æ¯ï¼ˆæƒé™ï¼Œæ¨¡å¼ï¼Œuidï¼Œgidç­‰ï¼‰</span>
    <span class="token class-name">umode_t</span>             i_mode<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span>      i_opflags<span class="token punctuation">;</span>
    <span class="token class-name">kuid_t</span>              i_uid<span class="token punctuation">;</span>
    <span class="token class-name">kgid_t</span>              i_gid<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>        i_flags<span class="token punctuation">;</span>
    <span class="token comment">// å›è°ƒå‡½æ•°</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">inode_operations</span>   <span class="token operator">*</span>i_op<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">super_block</span>              <span class="token operator">*</span>i_sb<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">address_space</span>            <span class="token operator">*</span>i_mapping<span class="token punctuation">;</span>
    <span class="token comment">// æ–‡ä»¶å¤§å°ï¼Œatimeï¼Œctimeï¼Œmtimeç­‰</span>
    <span class="token class-name">loff_t</span>              i_size<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">timespec64</span>   i_atime<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">timespec64</span>   i_mtime<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">timespec64</span>   i_ctime<span class="token punctuation">;</span>
    <span class="token comment">// å›è°ƒå‡½æ•°</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span>    <span class="token operator">*</span>i_fop<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">address_space</span>            i_data<span class="token punctuation">;</span>
    <span class="token comment">// æŒ‡å‘åç«¯å…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æ®Šæ•°æ®</span>
    <span class="token keyword">void</span>    <span class="token operator">*</span>i_private<span class="token punctuation">;</span>     <span class="token comment">/* fs or device private pointer */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚ä½•é€šè¿‡VFSçš„inodeæ‹¿åˆ°å…·ä½“å®ç°çš„æ–‡ä»¶ç³»ç»Ÿçš„inodeå‘¢ï¼Ÿ</p><p>ä»¥ext4ä¸¾ä¾‹</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">ext4_inode_info</span> <span class="token punctuation">{</span>
    <span class="token comment">// ext4 inode ç‰¹è‰²å­—æ®µ</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">struct</span> <span class="token class-name">inode</span>    vfs_inode<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ext4çš„inode infoç»“æ„ä½“é‡Œå·²ç»åŒ…å«äº†inodeå­—æ®µ</p><p>é‚£ä¹ˆå·²çŸ¥è¯¥å­—æ®µåœ¨è¯¥ç»“æ„ä½“ä¸­çš„åç§»é‡ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç±»å‹å¼ºåˆ¶è½¬æ¢çš„æ–¹å¼æ‹¿åˆ°ext4ç»“æ„ä½“çš„åœ°å€</p><p>å‡è®¾åç§»é‡ä¸º64 vfs inode çš„åœ°å€ä¸º0xa89be0</p><p>é‚£ä¹ˆå…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„ä½“åœ°å€å°±ä¸º</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ext4_inode_info</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0xa89be0</span> <span class="token operator">-</span> <span class="token number">64</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="/os/image-20221005214526462.png" alt="image-20221005214526462" tabindex="0" loading="lazy"><figcaption>image-20221005214526462</figcaption></figure><p>é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬å°±æ‰¾åˆ°äº†å…·ä½“æ–‡ä»¶ç®¡ç†ç³»ç»Ÿä¸‹é¢çš„å…·ä½“çš„æ–‡ä»¶çš„ç»“æ„ä½“ã€‚</p><h3 id="è¿›ç¨‹è¯»æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#è¿›ç¨‹è¯»æ–‡ä»¶" aria-hidden="true">#</a> è¿›ç¨‹è¯»æ–‡ä»¶</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token class-name">ssize_t</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
							Returns number of bytes read<span class="token punctuation">,</span> <span class="token number">0</span> on <span class="token constant">EOF</span><span class="token punctuation">,</span> or â€“<span class="token number">1</span> on error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Countå‚æ•°æŒ‡å®šè¦è¯»å–çš„æœ€å¤§å­—èŠ‚æ•°ã€‚(SIZE_Tæ•°æ®ç±»å‹æ˜¯æ— ç¬¦å·æ•´æ•°ç±»å‹ã€‚)ã€‚BUFFERå‚æ•°æä¾›è¦æ”¾ç½®è¾“å…¥æ•°æ®çš„å†…å­˜ç¼“å†²åŒºçš„åœ°å€ã€‚æ­¤ç¼“å†²åŒºå¿…é¡»è‡³å°‘æœ‰è®¡æ•°å­—èŠ‚é•¿ã€‚</p><p>ç³»ç»Ÿè°ƒç”¨ä¸ä¼šä¸ºç”¨äºå‘è°ƒç”¨æ–¹è¿”å›ä¿¡æ¯çš„ç¼“å†²åŒºåˆ†é…å†…å­˜ã€‚ç›¸åï¼Œæˆ‘ä»¬å¿…é¡»ä¼ é€’ä¸€ä¸ªæŒ‡å‘å…ˆå‰åˆ†é…çš„æ­£ç¡®å¤§å°çš„å†…å­˜ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚è¿™ä¸ä¸€äº›åº“å‡½æ•°ä¸åŒï¼Œè¿™äº›åº“å‡½æ•°ç¡®å®ä¼šåˆ†é…å†…å­˜ç¼“å†²åŒºï¼Œä»¥ä¾¿å‘è°ƒç”¨æ–¹è¿”å›ä¿¡æ¯ã€‚</p><h3 id="è¿›ç¨‹å†™æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#è¿›ç¨‹å†™æ–‡ä»¶" aria-hidden="true">#</a> è¿›ç¨‹å†™æ–‡ä»¶</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token class-name">ssize_t</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
									Returns number of bytes written<span class="token punctuation">,</span> or â€“<span class="token number">1</span> on error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>writeå°è¯•ä»bufå†™å…¥countä¸ªå­—èŠ‚åˆ°æ–‡ä»¶æè¿°ç¬¦fdæ‰€æŒ‡çš„æ–‡ä»¶ï¼Œå¹¶è¿”å›æˆåŠŸå†™å…¥çš„å­—èŠ‚æ•°ï¼ŒåŒæ—¶å°†æ–‡ä»¶åç§»å‘å‰ç§»åŠ¨ç›¸åŒå­—èŠ‚æ•°ã€‚writeæœ‰å¯èƒ½å†™å…¥æ¯”æŒ‡å®šcountå°‘çš„å­—èŠ‚æ•°ã€‚</p><p>writeæœ¬è´¨ä¸Šæ˜¯æŠŠç”¨æˆ·æ€ç¼“å­˜åŒºçš„æ•°æ®å†™å…¥å†…æ ¸æ€ç¼“å­˜ã€‚</p><h3 id="è¿›ç¨‹å…³é—­æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#è¿›ç¨‹å…³é—­æ–‡ä»¶" aria-hidden="true">#</a> è¿›ç¨‹å…³é—­æ–‡ä»¶</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
 												Returns <span class="token number">0</span> on success<span class="token punctuation">,</span> or â€“<span class="token number">1</span> on error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ–‡ä»¶çš„åç§»é‡" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶çš„åç§»é‡" aria-hidden="true">#</a> æ–‡ä»¶çš„åç§»é‡</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token class-name">off_t</span> <span class="token function">lseek</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token class-name">off_t</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> whence<span class="token punctuation">)</span><span class="token punctuation">;</span>
							   Returns new file offset <span class="token keyword">if</span> successful<span class="token punctuation">,</span> or â€“<span class="token number">1</span> on error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨å†™å…¥å’Œè¯»å–çš„æ–‡ä»¶çš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡åç§»é‡æ‰€åœ¨çš„ä½ç½®è¿›è¡Œè¯»å’Œå†™çš„ã€‚</p><h2 id="_3-ç‰¹æ®Šæ–‡ä»¶çš„å°è£…" tabindex="-1"><a class="header-anchor" href="#_3-ç‰¹æ®Šæ–‡ä»¶çš„å°è£…" aria-hidden="true">#</a> <strong>3.ç‰¹æ®Šæ–‡ä»¶çš„å°è£…</strong></h2><p>Linuxç§‰æŒã€Œ<strong>ä¸€åˆ‡çš†æ–‡ä»¶</strong>ã€çš„è®¾è®¡å“²å­¦ï¼Œå¯¹äºæ‰€æœ‰çš„æ–‡ä»¶éƒ½å¯ä»¥æŒ‰ç…§è¿™ä¸ªæ¨¡å¼è¿›è¡Œæ“ä½œ</p><p><code>æ‰“å¼€æ–‡ä»¶-&gt;è¯»/å†™æ–‡ä»¶-&gt;å…³é—­æ–‡ä»¶</code></p><p>å¯¹äºä¸€äº›ç‰¹æ®Šçš„æ–‡ä»¶ï¼ŒLinuxæ˜¯å¦‚ä½•è¿›è¡Œå°è£…çš„å‘¢ï¼Ÿ</p><h2 id="å¯¹socketçš„å°è£…" tabindex="-1"><a class="header-anchor" href="#å¯¹socketçš„å°è£…" aria-hidden="true">#</a> å¯¹Socketçš„å°è£…</h2><p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨Linuxä¸­ Socketä¹Ÿè¢«æŠ½è±¡æˆäº†æ–‡ä»¶çš„æ–¹å¼å¤„ç†ã€‚é‚£ä¹ˆLinuxæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p><p>å¯¹äºä¸€ä¸ªC/Sä½“ç³»è€Œè¨€ï¼Œä¸€èˆ¬å¯¹äºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œæ‰€ä½¿ç”¨çš„socketæ¨¡å¼ä¸€èˆ¬æ˜¯è¿™æ ·</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>æœåŠ¡ç«¯
socket = socket()
socket.bind()
socket.listen()
socket.accept()
wirte/read
socket.close()
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>å®¢æˆ·ç«¯
socket = socket()
socket.connect()
write/read
socket.close()
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡ç«¯çš„socketæ˜¯è¢«åŠ¨ç­‰å¾…è¿æ¥çš„ï¼Œè€Œå®¢æˆ·ç«¯çš„socketæ˜¯è¦ä¸»åŠ¨å‘é€è¿æ¥è¯·æ±‚çš„ã€‚è¿™ä¸ªåŒºåˆ«ä¸»è¦æ˜¯åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­å®ç°çš„</p><p>socketä¹Ÿèƒ½åƒä¸€ä¸ªæ–‡ä»¶ä¸€æ ·è¿›è¡Œæ‰“å¼€ã€è¯»å†™ã€å…³é—­çš„æ“ä½œã€‚</p><h3 id="æ‰“å¼€ä¸€ä¸ªsocket" tabindex="-1"><a class="header-anchor" href="#æ‰“å¼€ä¸€ä¸ªsocket" aria-hidden="true">#</a> æ‰“å¼€ä¸€ä¸ªsocket</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
									   Returns file descriptor on success<span class="token punctuation">,</span> or â€“<span class="token number">1</span> on error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è°ƒç”¨è¯¥æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ªä¸»åŠ¨çš„æ™®é€šsocket</p><p>å…·ä½“è€Œè¨€</p><p>é¦–å…ˆè°ƒç”¨ <code>socket_create</code> å‡½æ•°åˆ›å»ºå¥½ <code>struct socket</code> ï¼Œè¿˜æœ‰ä¸ä¹‹å…³è”çš„ <code>socket sock</code> ç»“æ„ï¼Œå†å¾€ä¸‹å°±æ˜¯å…·ä½“ç½‘ç»œåè®®å¯¹åº”çš„ç»“æ„ä½“</p><p>è°ƒç”¨ <code>sock_map_fd</code> å‡½æ•°åˆ›å»ºå¥½ <code>struct file</code> è¿™ä¸ªç»“æ„ä½“ï¼Œå¹¶ä¸ç¬¬ä¸€æ­¥åˆ›å»ºå‡ºçš„ <code>struct socket</code> å…³è”èµ·æ¥ï¼›</p><p>è¿™ä¸ªstruct fileç»“æ„ä½“åœ¨ä¹‹å‰çš„ç»“æ„ä¸­æœ‰è®²åˆ° åœ¨fd_arrayä¸­å­˜å‚¨çš„å°±æ˜¯æŒ‡å‘è¯¥ç»“æ„ä½“çš„æŒ‡é’ˆ è€Œfdå°±ä¸ºè¯¥æ•°ç»„çš„ç´¢å¼•ä¹Ÿå°±æ˜¯ä¸‹æ ‡ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±æŠŠfileç»“æ„ä½“å’Œå®é™…çš„socketç›¸å…³è”äº†èµ·æ¥ã€‚</p><p><code>sock_create</code> å‡½æ•°é‡Œï¼Œä¼šæ ¹æ®åè®®æ—æŸ¥æ‰¾å¯¹åº”çš„æ“ä½œè¡¨ï¼Œä»¥ AF_INET åè®®æ—ä¸¾ä¾‹ï¼Œ<code>pf-&gt;create</code> æ˜¯ <code>inet_create</code> ï¼Œä¸»è¦åšä¸¤ä»¶äº‹ï¼š</p><ol><li>æŠŠ <code>sock-&gt;ops</code> æŒ‰ç…§åè®®ç±»å‹èµ‹å€¼æˆ<strong>å…·ä½“çš„å‡½æ•°æ“ä½œè¡¨</strong>ï¼Œæ¯”å¦‚ tcp çš„å°±æ˜¯ <code>inet_stream_ops</code> ï¼›</li><li>åˆ›å»ºäº† <code>struct sock</code> å¯¹è±¡ï¼Œå¹¶ä¸”æŠŠ <code>struct sock</code> åˆå§‹åŒ–ï¼Œå¹¶å’Œ <code>struct socket</code> è¿›è¡Œå…³è”ï¼›</li></ol><p>ç€é‡æä¸€ç‚¹ï¼Œ<code>sock_init_data</code> å‡½æ•°ï¼ˆ <code>net/core/sock.c</code> ï¼‰ä¸»è¦æ˜¯åˆå§‹åŒ– <code>struct sock</code> ç»“æ„ä½“çš„ï¼Œæä¸¤ç‚¹æœ€å…³é”®çš„ï¼š</p><p><strong>ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–æ¥æ”¶é˜Ÿåˆ—å’Œå‘é€é˜Ÿåˆ—</strong></p><p>æ¯ä¸ªsocketåŒ…å«ä¸€ä¸ªæ¥æ”¶é˜Ÿåˆ—å’Œä¸€ä¸ªå‘é€é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯åœ¨å†…æ ¸ä¸­å¼€è¾Ÿä¸€ç¯‡ç¼“å­˜ä¾›å‘é€å’Œæ¥æ”¶æ•°æ®ä½¿ç”¨ã€‚</p><ul><li>sk_receive_queueï¼šsocketæ¥æ”¶åˆ°çš„æ•°æ®ï¼ˆsk_buff é‡Œé¢æ˜¯çº¯ç²¹çš„ç”¨æˆ·æ•°æ®å“¦ï¼Œæ²¡æœ‰ header å•¥ä¿¡æ¯ï¼‰ï¼›</li><li>sk_write_queueï¼šsocketè¦å‘é€çš„æ•°æ®ï¼›</li><li>sk_error_queueï¼šæŒ‚æ¥ä¸€äº› pengding çš„ error ä¿¡æ¯ï¼›</li></ul><p><strong>ç¬¬äºŒæ­¥ï¼šè®¾ç½®socket çš„å”¤é†’å›è°ƒæ–¹å¼</strong>ï¼›</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>   sk-&gt;sk_data_ready   =   sock_def_readable;
   sk-&gt;sk_write_space  =   sock_def_write_space;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸ºä»€ä¹ˆè¿™é‡Œå¾ˆé‡è¦ï¼Œå› ä¸ºè¿™ä¸ªè·Ÿ socket fd å¯è¯»å¯å†™çš„åˆ¤æ–­é€»è¾‘ï¼Œæ•°æ®åˆ°äº†ä¹‹åçš„å”¤é†’è·¯å¾„æ¯æ¯ç›¸å…³ã€‚ç®€è¿°ä¸‹å›è°ƒé“¾è·¯ï¼ˆä»¥å¥—æ¥å­—å±‚ä¸ºä¸»å¹²ï¼Œå…¶ä»–çš„æµç¨‹ç®€ç•¥æè¿°ï¼‰ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>sk-&gt;sk_data_readyï¼ˆæ•°æ®åˆ°äº†ï¼Œè¯¥é€šçŸ¥ç•™ä¸‹è¿‡è”ç³»æ–¹å¼çš„äººäº†ï¼‰
tcp_v4_rcvï¼ˆå…·ä½“åè®®æ ˆå¤„ç†å‡½æ•°ï¼‰
è½¯ä¸­æ–­
ç¡¬ä¸­æ–­
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å†è¯´ä¸‹ç»“æ„ä½“ï¼š</strong></p><p>ç»§ç»­è¯´ <code>struct sock</code> ï¼Œè¿™ä¸ªå¯¹è±¡æœ‰æ„æ€äº†ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä»¥ç»„åˆçš„æ–¹å¼å¾€ä¸‹å…¼å®¹çš„ï¼ŒåŒä¸€ä¸ªåœ°å€å¼ºè½¬ç±»å‹å¾—åˆ°ä¸åŒå±‚é¢çš„ç»“æ„ä½“ã€‚åŸç†å°±åœ¨äºï¼šä»–ä»¬æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œèµ·å§‹åœ°å€ç›¸åŒã€‚</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>sock -&gt; inet_sock -&gt; inet_connection_sock-&gt; tcp_sock
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong><code>struct socket</code> å’Œ <code>struct sock</code> æ˜¯ä¸¤ä¸ªä¸åŒçš„ç»“æ„ä½“</strong>å±äº<strong>å¥—æ¥å­—å±‚</strong>çš„ä¸¤ä¸ªç»´åº¦çš„æè¿°ï¼Œä¸€ä¸ªé¢å‘ä¸Šå±‚ï¼Œä¸€ä¸ªé¢å‘ä¸‹å±‚ã€‚</p><p><code>struct socket</code> åœ¨å†…æ ¸çš„æ³¨é‡Šä¸ºï¼š</p><blockquote><p>struct socket - general BSD socket</p></blockquote><p><code>struct sock</code> åœ¨å†…æ ¸çš„æ³¨é‡Šä¸ºï¼š</p><blockquote><p>struct sock_common - minimal network layer representation of sockets</p></blockquote><p><code>struct socket</code> æ˜¯å†…æ ¸æŠ½è±¡å‡ºçš„ä¸€ä¸ªé€šç”¨ç»“æ„ä½“ï¼Œä¸»è¦ä½œç”¨æ˜¯æ”¾ç½®äº†ä¸€äº›è·Ÿ fs ç›¸å…³çš„å­—æ®µï¼Œè€ŒçœŸæ­£è·Ÿç½‘ç»œé€šä¿¡ç›¸å…³çš„å­—æ®µç»“æ„ä½“æ˜¯ <code>struct sock</code> ã€‚å®ƒä»¬å†…éƒ¨æœ‰ç›¸äº’çš„æŒ‡é’ˆï¼Œå¯ä»¥è·å–åˆ°å¯¹æ–¹çš„åœ°å€ã€‚</p><p><code>struct socket</code> è¿™ä¸ªå­—æ®µå‡ºç”Ÿçš„æ—¶å€™å…¶å®å°±å’Œä¸€ä¸ª inode ç»“æ„ä½“ä¼´ç”Ÿå‡ºæ¥çš„ï¼Œç”± socketfs çš„ <code>sock_alloc_inode</code> å‡½æ•°åˆ†é…ã€‚</p><p><code>struct sock</code> è¿™ä¸ªç»“æ„ä½“æ˜¯ socket å¥—é˜¶å­—æ ¸å¿ƒçš„ç»“æ„ï¼ˆæ³¨æ„ï¼Œè¿˜æœ‰ä¸ªç»“æ„æ˜¯ <code>struct socket</code>ï¼Œè¿™ä¸¤ä¸ªæ˜¯ä¸åŒçš„ç»“æ„ä½“å“¦ï¼‰ã€‚è¿™ä¸ªæ˜¯å¯¹åº•ä¸‹å…·ä½“åè®®åšçš„ä¸€å±‚æŠ½è±¡å°è£…ï¼Œæ¯”å¦‚åœ¨åˆ†é… <code>struct sock</code> çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯ tcp åè®®ï¼Œé‚£ä¹ˆ <code>sk-&gt;sk_prot</code> ä¼šèµ‹å€¼ä¸º <code>tcp_prot</code> ï¼Œudp åè®®èµ‹å€¼çš„æ˜¯ <code>udp_prot</code> ï¼Œä¹‹åçš„ä¸€ç³»åˆ—åè®®è§£æå’Œå¤„ç†å°±æ˜¯è°ƒç”¨åˆ°å¯¹åº”åè®®çš„å›è°ƒå‡½æ•°ã€‚</p><p>**ä¸ºä»€ä¹ˆsocketfd å¯ä»¥åƒæ–‡ä»¶ä¸€æ ·è°ƒç”¨ <code>write(fd,args)</code> **</p><p><code>write(fd, args)</code> è¿›åˆ°å†…æ ¸é¦–å…ˆæ˜¯åˆ° vfs å±‚ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨åˆ° <code>vfs_write</code> ï¼Œåœ¨è¿™ä¸ªé‡Œé¢é¦–å…ˆè·å–åˆ° <code>file</code> è¿™ä¸ªç»“æ„ä½“ï¼Œç„¶åè°ƒç”¨ä¸‹å±‚æ³¨å†Œçš„å›è°ƒï¼Œæ¯”å¦‚ <code>file-&gt;f_op-&gt;write_iter</code> ï¼Œ<code>file-&gt;f_op-&gt;write</code> ï¼Œæ‰€ä»¥ï¼Œå…³é”®åœ¨å¦‚ä½•è°ƒç”¨çš„<code>file-&gt;f_op</code> è¿™ä¸ªå­—æ®µã€‚</p><p>è¯¥å­—æ®µèµ‹å€¼æ˜¯æ ¹æ®æ‰€è°“fileçš„ç±»å‹å†³å®šçš„ï¼Œä¸åŒçš„ç±»å‹çš„fileä¼šè¢«èµ‹äºˆä¸åŒçš„å€¼</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>vfs_write    <span class="token operator">=</span><span class="token operator">&gt;</span>  
                <span class="token operator">-&gt;</span> socket_file_ops ï¼ˆsockfsï¼‰
                <span class="token operator">-&gt;</span> ext2_file_operations ï¼ˆext2ï¼‰
                <span class="token operator">-&gt;</span> ext4_file_operations ï¼ˆext4ï¼‰
                <span class="token operator">-&gt;</span> eventfd_fops 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è€Œè¿™ä¸ªsocket_file_opsç»“æ„ä½“å°±æ˜¯</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> socket_file_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>llseek <span class="token operator">=</span>   no_llseek<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read_iter <span class="token operator">=</span>    sock_read_iter<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write_iter <span class="token operator">=</span>   sock_write_iter<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>poll <span class="token operator">=</span>     sock_poll<span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰€ä»¥è°ƒç”¨writeæ–¹æ³•æ—¶ï¼Œé€šè¿‡vfsç³»ç»Ÿï¼Œå®é™…è°ƒç”¨çš„æ˜¯sock_write_iterè¿™ä¸ªæ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•ç›´æ¥æ¥å…¥ç½‘ç»œå¤„ç†çš„æ–¹å‘å»äº†ã€‚</p><h3 id="ç»™socketç»‘å®šç«¯å£" tabindex="-1"><a class="header-anchor" href="#ç»™socketç»‘å®šç«¯å£" aria-hidden="true">#</a> ç»™socketç»‘å®šç«¯å£</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
													 Returns <span class="token number">0</span> on success<span class="token punctuation">,</span> or â€“<span class="token number">1</span> on error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sockfd</code>å‚æ•°æ˜¯ä»å…ˆå‰å¯¹Socket()çš„è°ƒç”¨ä¸­è·å¾—çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p><code>addr</code>å‚æ•°æ˜¯æŒ‡å‘æŒ‡å®šæ­¤å¥—æ¥å­—è¦ç»‘å®šåˆ°çš„åœ°å€çš„ç»“æ„çš„æŒ‡é’ˆã€‚</p><p>å†…æ ¸é€šè¿‡sockfdæ‰¾åˆ°å¯¹åº”çš„struct socketç»“æ„ä½“</p><p>é€šè¿‡å†…éƒ¨çš„sock-&gt;ops-&gt;bindå‡½æ•°æŠŠaddrå’Œsocketè¿›è¡Œç»‘å®š</p><h3 id="ç›‘å¬socketç»‘å®šçš„ç«¯å£" tabindex="-1"><a class="header-anchor" href="#ç›‘å¬socketç»‘å®šçš„ç«¯å£" aria-hidden="true">#</a> ç›‘å¬socketç»‘å®šçš„ç«¯å£</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
 													Returns <span class="token number">0</span> on success<span class="token punctuation">,</span> or â€“<span class="token number">1</span> on error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤æ—¶æ“ä½œç³»ç»Ÿä¼šå°†æ™®é€šçš„socketè½¬åŒ–ä¸ºç›‘å¬socket</p><p>é¦–å…ˆé€šè¿‡fdæ‰¾åˆ°è¯¥struct socketç»“æ„ä½“ å¹¶ä¸”è°ƒç”¨sock-&gt;opsä¸­çš„listenå‡½æ•°</p><p>è€Œè¯¥listenå‡½æ•°åšäº†å‡ ä»¶äº‹</p><p><strong>åˆå§‹åŒ–è¯·æ±‚é˜Ÿåˆ—</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">reqsk_queue_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">request_sock_queue</span> <span class="token operator">*</span>queue<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-&gt;</span>rskq_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token operator">-&gt;</span>fastopenq<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	queue<span class="token operator">-&gt;</span>fastopenq<span class="token punctuation">.</span>rskq_rst_head <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	queue<span class="token operator">-&gt;</span>fastopenq<span class="token punctuation">.</span>rskq_rst_tail <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	queue<span class="token operator">-&gt;</span>fastopenq<span class="token punctuation">.</span>qlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	queue<span class="token operator">-&gt;</span>rskq_accept_head <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token comment">// å…¨è¿æ¥é˜Ÿåˆ—</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å¥—æ¥å­—çŠ¶æ€è®¾ç½®æˆ <code>TCP_LISTEN</code>ï¼›</strong></p><p><strong>è·å–åˆ°ä¹‹å‰socketç»‘å®šçš„ç«¯å£ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œé‚£ä¹ˆå°±ä¼šç”¨ä¸ªä¸´æ—¶çš„ç«¯å£ï¼›</strong></p><p><strong>æŠŠç›‘å¬å¥—æ¥å­—åŠ å…¥åˆ°å…¨å±€ hash è¡¨ä¸­ï¼›</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">inet_hash</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆšæ‰çŠ¶æ€å·²ç»æ˜¯TCP_LISTENäº†</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>sk<span class="token operator">-&gt;</span>sk_state <span class="token operator">!=</span> TCP_CLOSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">local_bh_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		err <span class="token operator">=</span> <span class="token function">__inet_hash</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">local_bh_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">__inet_hash</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>osk<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">inet_hashinfo</span> <span class="token operator">*</span>hashinfo <span class="token operator">=</span> sk<span class="token operator">-&gt;</span>sk_prot<span class="token operator">-&gt;</span>h<span class="token punctuation">.</span>hashinfo<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">inet_listen_hashbucket</span> <span class="token operator">*</span>ilb<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// TCPçŠ¶æ€ä¸€å®šæ˜¯TCP_LISTENï¼Œä¸æ»¡è¶³æ­¤æ¡ä»¶</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>sk<span class="token operator">-&gt;</span>sk_state <span class="token operator">!=</span> TCP_LISTEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">inet_ehash_nolisten</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> osk<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">WARN_ON</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">sk_unhashed</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ilb <span class="token operator">=</span> <span class="token operator">&amp;</span>hashinfo<span class="token operator">-&gt;</span>listening_hash<span class="token punctuation">[</span><span class="token function">inet_sk_listen_hashfn</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ilb<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>sk<span class="token operator">-&gt;</span>sk_reuseport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		err <span class="token operator">=</span> <span class="token function">inet_reuseport_add_sock</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> ilb<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token keyword">goto</span> unlock<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
        <span class="token comment">// åŠ å…¥å…¨å±€hashè¡¨</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_IPV6<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sk<span class="token operator">-&gt;</span>sk_reuseport <span class="token operator">&amp;&amp;</span>
		sk<span class="token operator">-&gt;</span>sk_family <span class="token operator">==</span> AF_INET6<span class="token punctuation">)</span>
		<span class="token function">__sk_nulls_add_node_tail_rcu</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ilb<span class="token operator">-&gt;</span>nulls_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		<span class="token function">__sk_nulls_add_node_rcu</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ilb<span class="token operator">-&gt;</span>nulls_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">inet_hash2</span><span class="token punctuation">(</span>hashinfo<span class="token punctuation">,</span> sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ilb<span class="token operator">-&gt;</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token function">sock_set_flag</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> SOCK_RCU_FREE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sock_prot_inuse_add</span><span class="token punctuation">(</span><span class="token function">sock_net</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">,</span> sk<span class="token operator">-&gt;</span>sk_prot<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
unlock<span class="token operator">:</span>
	<span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ilb<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä¸å®¢æˆ·ç«¯çš„socketå»ºç«‹è¿æ¥" tabindex="-1"><a class="header-anchor" href="#ä¸å®¢æˆ·ç«¯çš„socketå»ºç«‹è¿æ¥" aria-hidden="true">#</a> ä¸å®¢æˆ·ç«¯çš„socketå»ºç«‹è¿æ¥</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
									   Returns file descriptor on success<span class="token punctuation">,</span> or â€“<span class="token number">1</span> on error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>inet_accept ï¼ˆ <code>net/ipv4/af_inet.c</code> ï¼‰æ³¨é‡Šï¼š</p><blockquote><p>Accept a pending connection. The TCP layer now gives BSD semantics.</p></blockquote><p>è¿™ä¸ªä¸»è¦æ˜¯ä»é˜Ÿåˆ— <code>icsk-&gt;icsk_accept_queue</code> ä¸­å–è¯·æ±‚ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œå°±çœ‹ socket æ˜¯å¦è®¾ç½®äº†éé˜»å¡æ ‡è¯†ï¼Œéé˜»å¡çš„å°±ç›´æ¥æŠ¥é”™ EAGAINï¼Œå¦åˆ™é˜»å¡çº¿ç¨‹ç­‰å¾…ã€‚</p><p>æ‰€ä»¥ï¼Œç›‘å¬å¥—æ¥å­—çš„å¯è¯»äº‹ä»¶æ˜¯å•¥ï¼Ÿ</p><p>icsk_accept_queue é˜Ÿåˆ—éç©ºã€‚</p><p>è¿™ä¸ªé˜Ÿåˆ—ä»€ä¹ˆæ—¶å€™è¢«å¡«å……çš„ï¼Ÿ</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>tcp_child_process
    -&gt; tcp_rcv_state_process
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªä¹Ÿæ˜¯åº•å±‚ç½‘ç»œåè®®å›è°ƒå¾€ä¸Šè°ƒç”¨çš„ï¼Œtcp ä¸‰æ¬¡æ¡æ‰‹ä¹‹åï¼Œå»ºç«‹å¥½çš„è¿æ¥å°±åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­ accept_queue ï¼Œé˜Ÿåˆ—éç©ºåˆ™ä¸ºåªè¯»ã€‚ç”± tcp çš„åè®®æ ˆå¾€ä¸Šè°ƒç”¨ï¼Œå¯¹åº”åˆ° socket å±‚ï¼Œè¿˜æ˜¯ä¼šè°ƒç”¨åˆ° <code>sk-&gt;sk_data_ready</code> ã€‚</p><p>è¿™é‡Œè¿˜æ˜¯ä»¥ epoll ç®¡ç†ç›‘å¬å¥—æ¥å­—æ¥ä¸¾ä¾‹ã€‚è¿™ä¸ªè·Ÿä¸Šé¢è®²çš„æ•°æ®æ¥äº†ä¸€æ ·ï¼Œéƒ½æ˜¯æŠŠæŒ‚æ¥åœ¨ socket æœ¬èº«ä¸Šçš„ wait å¯¹è±¡è¿›è¡Œå”¤é†’ï¼ˆè°ƒç”¨å›è°ƒï¼‰ï¼Œè¿™æ ·å°±ä¼šåˆ° <code>ep_poll_callback</code> ï¼Œ<code>ep_poll_callback</code> å°±ä¼šæŠŠç›‘å¬å¥—æ¥å­—å¯¹åº”çš„ ep_item æŒ‚åˆ° epoll çš„ ready é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”å”¤é†’é˜»å¡åœ¨ epoll_wait çš„çº¿ç¨‹ï¼Œä»è€Œå®ç°äº†ç›‘å¬å¥—æ¥å­—çš„è¯»äº‹ä»¶çš„è§¦å‘çš„æµç¨‹ã€‚</p><p>å…³äºaccept()éœ€è¦ç†è§£çš„å…³é”®ç‚¹æ˜¯å®ƒåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„socketï¼Œå¹¶ä¸”æ­£æ˜¯è¿™ä¸ªæ–°socketä¸å®¢æˆ·ç«¯çš„Connect()çš„å¯¹ç­‰socketç›¸è¿æ¥ã€‚acceptçš„è¿”å›å€¼å³ä¸ºè¯¥socketçš„fdã€‚è€Œæ­¤æ—¶ï¼Œä¹‹å‰ç›‘å¬çš„socket(Sockfd)ä»ç„¶ä¿æŒæ‰“å¼€çŠ¶æ€ï¼Œå¯ç”¨äºæ¥å—è¿›ä¸€æ­¥çš„è¿æ¥ã€‚</p><p>æ‰€ä»¥åœ¨æœåŠ¡ç«¯å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ä¸­ï¼Œå®é™…ä¸Šåˆ›å»ºäº†ä¸¤ä¸ªsocketï¼Œä¸€ä¸ªè´Ÿè´£ç›‘å¬æ¥è‡ªäºå®¢æˆ·ç«¯çš„è¿æ¥ï¼Œé€šè¿‡bind/listenåˆ›å»ºå¹¶ä½¿ç”¨ï¼Œå¦ä¸€ä¸ªæ˜¯ä¸å®¢æˆ·ç«¯å»ºç«‹ç«¯å£å¯¹ç«¯å£çš„è¿æ¥çš„socketï¼Œå…¶fdç”±acceptç³»ç»Ÿè°ƒç”¨è¿”å›ã€‚</p><h3 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h3><p>1.åœ¨Linuxä¸­ socketä¹Ÿèƒ½åƒæ–‡ä»¶ä¸€æ ·é€šè¿‡fdè°ƒç”¨ï¼Œå¹¶ä¸”å¯ä»¥open-&gt;read/write-&gt;closeï¼Œè¿™å¾—ç›Šäºvfsä¸­çš„fileç»“æ„ä½“ä¸­åšå¾—å¤„ç†ï¼Œå°†read&amp;writeç­‰æ“ä½œè½¬ç§»</p><p>2.socketåˆ†ä¸ºç›‘å¬socketå’Œæ™®é€šsocketï¼Œè°ƒç”¨socket()æ—¶åˆ›å»ºçš„æ˜¯æ™®é€šsocketï¼Œåœ¨è¿›è¡Œlistenä¹‹åï¼Œè½¬å˜ä¸ºç›‘å¬socketã€‚ç›‘å¬å¥—æ¥å­—ä¸€èˆ¬åªç›‘å¬å¯è¯»äº‹ä»¶ï¼Œå…³æ³¨è¿æ¥çš„å»ºç«‹ï¼Œæ™®é€šå¥—æ¥å­—èµ°æ•°æ®æµï¼Œå…³æ³¨æ•°æ®çš„è¯»å†™äº‹ä»¶ï¼›</p><p>3.å› ä¸ºsocketå®ç°äº†pollæ¥å£ï¼Œæ‰€ä»¥socketæ–‡ä»¶å¯ä»¥ç”¨epollç®¡ç†socketfdï¼Œè¿™ä¹Ÿæ˜¯ä¹‹åå®ç°å¤šè·¯å¤ç”¨çš„é‡è¦åŸç†ã€‚</p><h2 id="å¯¹ç›®å½•çš„å°è£…" tabindex="-1"><a class="header-anchor" href="#å¯¹ç›®å½•çš„å°è£…" aria-hidden="true">#</a> å¯¹ç›®å½•çš„å°è£…</h2><p>åœ¨Linuxä¸­ï¼Œç›®å½•ä»¥ä¸å¸¸è§„æ–‡ä»¶ç±»ä¼¼çš„æ–¹å¼å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p><p>ä½†æ˜¯ç›®å½•ä¸å¸¸è§„æ–‡ä»¶æœ‰ä¸¤ä¸ªåŒºåˆ«ï¼š</p><p>åœ¨å…¨å±€çš„inodeè¡¨ä¸­ï¼Œç›®å½•è¢«æ ‡è®°ä¸ºä¸åŒçš„æ–‡ä»¶ç±»å‹ï¼Œ</p><p>ç›®å½•åœ¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç”±æ–‡ä»¶åå’Œinodeç¼–å·ç»„æˆçš„æ–‡ä»¶</p><figure><img src="/os/image-20221006203230816.png" alt="image-20221006203230816" tabindex="0" loading="lazy"><figcaption>image-20221006203230816</figcaption></figure><p>å°½ç®¡è¿›ç¨‹å¯ä»¥æ‰“å¼€ç›®å½•ï¼Œä½†å®ƒä¸èƒ½ä½¿ç”¨Read()æ¥è¯»å–ç›®å½•çš„å†…å®¹ã€‚è‹¥è¦æ£€ç´¢ç›®å½•çš„å†…å®¹ï¼Œè¿›ç¨‹å¿…é¡»æ”¹ç”¨æœ¬ç« åé¢è®¨è®ºçš„ç³»ç»Ÿè°ƒç”¨å’Œåº“å‡½æ•°ã€‚(åœ¨æŸäº›UNIXå®ç°ä¸­ï¼Œå¯ä»¥å¯¹ç›®å½•æ‰§è¡ŒRead()ï¼Œä½†è¿™æ˜¯ä¸å¯ç§»æ¤çš„ã€‚)ã€‚è¿›ç¨‹ä¹Ÿä¸èƒ½ä½¿ç”¨WRITE()ç›´æ¥æ›´æ”¹ç›®å½•çš„å†…å®¹ï¼›å®ƒåªèƒ½ä½¿ç”¨è¯¸å¦‚Open()(åˆ›å»ºæ–°æ–‡ä»¶)ã€link()ã€mkdir()ã€symlink()ã€unlink()å’Œrmdir()ç­‰ç³»ç»Ÿè°ƒç”¨é—´æ¥(å³è¯·æ±‚å†…æ ¸)æ›´æ”¹å†…å®¹ã€‚I-nodeè¡¨ä»1å¼€å§‹ç¼–å·ï¼Œè€Œä¸æ˜¯ä»0å¼€å§‹ç¼–å·ï¼Œå› ä¸ºç›®å½•æ¡ç›®çš„i-nodeå­—æ®µä¸­çš„0è¡¨ç¤ºè¯¥æ¡ç›®æœªä½¿ç”¨ã€‚IèŠ‚ç‚¹1ç”¨äºåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­è®°å½•åå—ã€‚æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç›®å½•(/)æ€»æ˜¯å­˜å‚¨åœ¨i-nodeæ¡ç›®2ä¸­ï¼Œå› æ­¤å†…æ ¸åœ¨è§£æè·¯å¾„åæ—¶çŸ¥é“ä»å“ªé‡Œå¼€å§‹ã€‚</p><p>åªæœ‰å½“ièŠ‚ç‚¹çš„é“¾æ¥è®¡æ•°é™è‡³0æ—¶ï¼Œå³å½“æ–‡ä»¶çš„æ‰€æœ‰åç§°éƒ½å·²åˆ é™¤æ—¶ï¼Œæ‰ä¼šåˆ é™¤(é‡Šæ”¾)æ–‡ä»¶çš„inodeæ¡ç›®å’Œæ•°æ®å—ã€‚æ€»è€Œè¨€ä¹‹ï¼šrmå‘½ä»¤ä»ç›®å½•åˆ—è¡¨ä¸­åˆ é™¤æ–‡ä»¶åï¼Œå°†ç›¸åº”i-nodeçš„é“¾æ¥è®¡æ•°å‡1ï¼Œå¹¶ä¸”å¦‚æœé“¾æ¥è®¡æ•°å› æ­¤è€Œé™è‡³0ï¼Œåˆ™é‡Šæ”¾i-nodeåŠå…¶å¼•ç”¨çš„æ•°æ®å—ã€‚æ–‡ä»¶çš„æ‰€æœ‰åç§°(é“¾æ¥)éƒ½æ˜¯ç­‰ä»·çš„--æ²¡æœ‰ä¸€ä¸ªåç§°(ä¾‹å¦‚ï¼Œç¬¬ä¸€ä¸ª)çš„ä¼˜å…ˆçº§é«˜äºä»»ä½•å…¶ä»–åç§°ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­çœ‹åˆ°çš„ï¼Œåœ¨åˆ é™¤äº†ä¸æ–‡ä»¶ç›¸å…³è”çš„ç¬¬ä¸€ä¸ªåç§°ä¹‹åï¼Œç‰©ç†æ–‡ä»¶ä»ç„¶å­˜åœ¨ï¼Œä½†éšååªèƒ½é€šè¿‡å¦ä¸€ä¸ªåç§°è®¿é—®å®ƒã€‚</p><h3 id="è½¯è¿æ¥å’Œç¡¬è¿æ¥" tabindex="-1"><a class="header-anchor" href="#è½¯è¿æ¥å’Œç¡¬è¿æ¥" aria-hidden="true">#</a> è½¯è¿æ¥å’Œç¡¬è¿æ¥</h3><p>æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›ç»™æŸä¸ªæ–‡ä»¶å–ä¸ªåˆ«åï¼Œé‚£ä¹ˆåœ¨ Linux ä¸­å¯ä»¥é€šè¿‡<strong>ç¡¬é“¾æ¥ï¼ˆ*Hard Link*ï¼‰</strong> å’Œ<strong>è½¯é“¾æ¥ï¼ˆ*Symbolic Link*ï¼‰</strong> çš„æ–¹å¼æ¥å®ç°ï¼Œå®ƒä»¬éƒ½æ˜¯æ¯”è¾ƒç‰¹æ®Šçš„æ–‡ä»¶ï¼Œä½†æ˜¯å®ç°æ–¹å¼ä¹Ÿæ˜¯ä¸ç›¸åŒçš„ã€‚</p><p>ç¡¬é“¾æ¥æ˜¯<strong>å¤šä¸ªç›®å½•é¡¹ä¸­çš„ã€Œç´¢å¼•èŠ‚ç‚¹ã€æŒ‡å‘ä¸€ä¸ªæ–‡ä»¶</strong>ï¼Œä¹Ÿå°±æ˜¯æŒ‡å‘åŒä¸€ä¸ª inodeï¼Œä½†æ˜¯ inode æ˜¯ä¸å¯èƒ½è·¨è¶Šæ–‡ä»¶ç³»ç»Ÿçš„ï¼Œæ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½æœ‰å„è‡ªçš„ inode æ•°æ®ç»“æ„å’Œåˆ—è¡¨ï¼Œæ‰€ä»¥<strong>ç¡¬é“¾æ¥æ˜¯ä¸å¯ç”¨äºè·¨æ–‡ä»¶ç³»ç»Ÿçš„</strong>ã€‚ç”±äºå¤šä¸ªç›®å½•é¡¹éƒ½æ˜¯æŒ‡å‘ä¸€ä¸ª inodeï¼Œé‚£ä¹ˆ<strong>åªæœ‰åˆ é™¤æ–‡ä»¶çš„æ‰€æœ‰ç¡¬é“¾æ¥ä»¥åŠæºæ–‡ä»¶æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šå½»åº•åˆ é™¤è¯¥æ–‡ä»¶ã€‚</strong></p><figure><img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/æ“ä½œç³»ç»Ÿ/æ–‡ä»¶ç³»ç»Ÿ/ç¡¬é“¾æ¥-2.png" alt="ç¡¬é“¾æ¥" tabindex="0" loading="lazy"><figcaption>ç¡¬é“¾æ¥</figcaption></figure><p>è½¯é“¾æ¥ç›¸å½“äºé‡æ–°åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶æœ‰<strong>ç‹¬ç«‹çš„ inode</strong>ï¼Œä½†æ˜¯è¿™ä¸ª<strong>æ–‡ä»¶çš„å†…å®¹æ˜¯å¦å¤–ä¸€ä¸ªæ–‡ä»¶çš„è·¯å¾„</strong>ï¼Œæ‰€ä»¥è®¿é—®è½¯é“¾æ¥çš„æ—¶å€™ï¼Œå®é™…ä¸Šç›¸å½“äºè®¿é—®åˆ°äº†å¦å¤–ä¸€ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥<strong>è½¯é“¾æ¥æ˜¯å¯ä»¥è·¨æ–‡ä»¶ç³»ç»Ÿçš„</strong>ï¼Œç”šè‡³<strong>ç›®æ ‡æ–‡ä»¶è¢«åˆ é™¤äº†ï¼Œé“¾æ¥æ–‡ä»¶è¿˜æ˜¯åœ¨çš„ï¼Œåªä¸è¿‡æŒ‡å‘çš„æ–‡ä»¶æ‰¾ä¸åˆ°äº†è€Œå·²ã€‚</strong></p><figure><img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/æ“ä½œç³»ç»Ÿ/æ–‡ä»¶ç³»ç»Ÿ/è½¯é“¾æ¥.png" alt="è½¯é“¾æ¥" tabindex="0" loading="lazy"><figcaption>è½¯é“¾æ¥</figcaption></figure><h2 id="_4-æ–‡ä»¶i-o" tabindex="-1"><a class="header-anchor" href="#_4-æ–‡ä»¶i-o" aria-hidden="true">#</a> 4.æ–‡ä»¶I/O</h2><h2 id="i-o-buffer" tabindex="-1"><a class="header-anchor" href="#i-o-buffer" aria-hidden="true">#</a> I/O buffer</h2><p>ä¸ºäº†é€Ÿåº¦å’Œæ•ˆç‡ï¼Œå½“æ“ä½œç£ç›˜æ–‡ä»¶æ—¶ï¼ŒI/Oç³»ç»Ÿè°ƒç”¨å’Œæ ‡å‡†Cåº“çš„I/Oå‡½æ•°ä¼šå¯¹ç£ç›˜æ•°æ®è¿›è¡Œç¼“å†²ã€‚è¿™ä¸¤ç§ç±»å‹çš„ç¼“å†²ç©¶ç«Ÿæ˜¯å¦‚ä½•å®ç°çš„ï¼Œå®ƒä»¬å¦‚ä½•å½±å“åº”ç”¨ç¨‹åºæ€§èƒ½ï¼Ÿå¦‚æœç¦ç”¨è¿™ä¸¤ç§ç±»å‹çš„ç¼“å†²çš„å„ç§æŠ€æœ¯ä¼šé€ æˆä»€ä¹ˆå½±å“ï¼Œç›´æ¥I/Oåˆæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</p><h3 id="å†…æ ¸ç¼“å­˜åŒº" tabindex="-1"><a class="header-anchor" href="#å†…æ ¸ç¼“å­˜åŒº" aria-hidden="true">#</a> å†…æ ¸ç¼“å­˜åŒº</h3><p>å½“è¿›è¡Œwrite()å’Œread()æ“ä½œç£ç›˜æ–‡ä»¶çš„æ—¶å€™ï¼Œè¯¥ç³»ç»Ÿè°ƒç”¨å¹¶ä¸ä¼šç›´æ¥ä»ç£ç›˜è¿›è¡Œè®¿é—®ã€‚</p><p>writeæ“ä½œåªä¼šå°†ç”¨æˆ·æ€ç¼“å­˜åŒºçš„æ•°æ®copyåˆ°å†…æ ¸æ€ä¸­çš„ç¼“å­˜åŒºï¼Œä¹‹åæŸä¸ªæ—¶åˆ»ï¼Œå†…æ ¸æ‰ä¼šå°†ç¼“å­˜åŒºçš„æ•°æ®å†™å…¥ç£ç›˜ã€‚ä¹Ÿå°±æ˜¯è¯´ç³»ç»Ÿè°ƒç”¨å’Œç£ç›˜çš„æ“ä½œå¹¶ä¸æ˜¯åŒæ­¥çš„ã€‚å¦‚æœåœ¨æ­¤æ—¶ï¼Œæœ‰è¿›ç¨‹å°è¯•è¯»å–è¿™äº›å­—èŠ‚ï¼Œå†…æ ¸ä¼šç›´æ¥ä»ç¼“å­˜åŒºæä¾›æ•°æ®ã€‚</p><p>å¯¹äºreadæ“ä½œï¼Œå†…æ ¸ä»ç¡¬ç›˜ä¸­è¯»å–æ•°æ®åä¼šå­˜å‚¨åœ¨å†…æ ¸ç¼“å­˜åŒºä¸­ï¼Œè°ƒç”¨readæ—¶ï¼Œä»ç¼“å†²åŒºæä¾›æ•°æ®ï¼Œç›´åˆ°å†…æ ¸ç¼“å†²åŒºè€—å°½ã€‚</p><p>è¿™ç§è®¾è®¡çš„ç›®çš„æ˜¯ä½¿è¯»å†™å¾ˆå¿«ï¼Œå› ä¸ºå®ƒä»¬ä¸éœ€è¦ç­‰å¾…(æ…¢çš„)ç£ç›˜æ“ä½œã€‚è¿™ç§è®¾è®¡ä¹Ÿå¾ˆé«˜æ•ˆï¼Œå› ä¸ºå®ƒå‡å°‘äº†å†…æ ¸å¿…é¡»æ‰§è¡Œçš„ç£ç›˜ä¼ è¾“æ¬¡æ•°ã€‚</p><h3 id="ç”¨æˆ·æ€ç¼“å­˜åŒº" tabindex="-1"><a class="header-anchor" href="#ç”¨æˆ·æ€ç¼“å­˜åŒº" aria-hidden="true">#</a> ç”¨æˆ·æ€ç¼“å­˜åŒº</h3><p>ç”¨æˆ·æ€ç¼“å­˜åŒºæ˜¯ç”±ç¼–ç¨‹è¯­è¨€çš„æ ‡å‡†åº“æ–¹æ³•æä¾›çš„ï¼Œä»¥Cè¯­è¨€æ¥è¯´æ˜ã€‚</p><p>å°†æ•°æ®ç¼“å†²åˆ°å†…å­˜ä¸­ä»¥å‡å°‘ç³»ç»Ÿè°ƒç”¨æ­£æ˜¯Cåº“I/Oå‡½æ•°(ä¾‹å¦‚ï¼Œfprint tf()ã€fscanf()ã€fget()ã€flets()ã€fputc()ã€fgetc())åœ¨æ“ä½œç£ç›˜æ–‡ä»¶æ—¶æ‰€åšçš„äº‹æƒ…ã€‚å› æ­¤ï¼Œä½¿ç”¨stdioåº“ä½¿æˆ‘ä»¬æ‘†è„±äº†ç¼“å†²æ•°æ®ä»¥é€šè¿‡WRITE()è¾“å‡ºæˆ–é€šè¿‡READ()è¾“å…¥çš„ä»»åŠ¡ã€‚</p><figure><img src="/os/image-20221006210345024.png" alt="image-20221006210345024" tabindex="0" loading="lazy"><figcaption>image-20221006210345024</figcaption></figure><h3 id="ç›´æ¥i-o" tabindex="-1"><a class="header-anchor" href="#ç›´æ¥i-o" aria-hidden="true">#</a> ç›´æ¥I/O</h3><p>é€šè¿‡ç¦ç”¨ç¼“å­˜çš„æ–¹å¼ï¼Œå°†ç”¨æˆ·æ€çš„ä¿¡æ¯ç›´æ¥æ‹·è´åˆ°å†…æ ¸æ€æˆ–è€…ç£ç›˜çš„æ–¹å¼ã€‚</p><ul><li>ç¼“å­˜æ–‡ä»¶ I/Oï¼šç”¨æˆ·ç©ºé—´è¦è¯»å†™ä¸€ä¸ªæ–‡ä»¶å¹¶<strong>ä¸ç›´æ¥</strong>ä¸ç£ç›˜äº¤äº’ï¼Œè€Œæ˜¯ä¸­é—´å¤¹äº†ä¸€å±‚ç¼“å­˜ï¼Œå³ page cacheï¼›</li><li>ç›´æ¥æ–‡ä»¶ I/Oï¼šç”¨æˆ·ç©ºé—´è¯»å–çš„æ–‡ä»¶<strong>ç›´æ¥</strong>ä¸ç£ç›˜äº¤äº’ï¼Œæ²¡æœ‰ä¸­é—´ page cache å±‚ï¼›</li></ul><p>â€œç›´æ¥â€åœ¨è¿™é‡Œè¿˜æœ‰å¦ä¸€å±‚è¯­ä¹‰ï¼šå…¶ä»–æ‰€æœ‰æŠ€æœ¯ä¸­ï¼Œæ•°æ®è‡³å°‘éœ€è¦åœ¨å†…æ ¸ç©ºé—´å­˜å‚¨ä¸€ä»½ï¼Œä½†æ˜¯åœ¨ Direct I/O æŠ€æœ¯ä¸­ï¼Œæ•°æ®ç›´æ¥å­˜å‚¨åœ¨ç”¨æˆ·ç©ºé—´ä¸­ï¼Œç»•è¿‡äº†å†…æ ¸ã€‚</p><p>ä½¿ç”¨DMAæŠ€æœ¯å¯ä»¥å®ç°ç›´æ¥IOï¼Œç›´æ¥IOåœ¨Nettyç­‰è½¯ä»¶ä¸­å‘æŒ¥çš„å¾ˆå¤§çš„ä½œç”¨ï¼Œå°†åœ¨åé¢éƒ¨åˆ†è¿›è¡Œè¯´æ˜ã€‚</p><h2 id="i-oæ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#i-oæ¨¡å‹" aria-hidden="true">#</a> I/Oæ¨¡å‹</h2><p>ä¸»è¦æœ‰BIO/NIO/AIOç­‰</p><p>å°†åœ¨ä¹‹åçš„ç¯‡å¹…ä»‹ç»</p><h2 id="_5-fd-æ–‡ä»¶æè¿°ç¬¦" tabindex="-1"><a class="header-anchor" href="#_5-fd-æ–‡ä»¶æè¿°ç¬¦" aria-hidden="true">#</a> 5.fd(æ–‡ä»¶æè¿°ç¬¦)</h2><h3 id="æ™®é€šfd" tabindex="-1"><a class="header-anchor" href="#æ™®é€šfd" aria-hidden="true">#</a> æ™®é€šfd</h3><p>åœ¨å‰é¢çš„éƒ¨åˆ†é‡Œï¼Œæåˆ°è¿‡fdçš„æœ¬è´¨ã€‚</p><p>fdå°±æ˜¯å®šä¹‰åœ¨fd_arrayä¸­ï¼Œç”¨äºç®¡ç†fileæ•°ç»„çš„ç´¢å¼•ï¼Œfdä¼šæŒ‡å‘ä¸€ä¸ªfileæŒ‡é’ˆï¼Œè¡¨ç¤ºä¸€ä¸ªLinux æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¯èƒ½æ˜¯æ™®é€šæ–‡ä»¶ï¼Œå¯èƒ½æ˜¯socketï¼Œä¹Ÿå¯èƒ½æ˜¯ç›®å½•é¡¹ç­‰ã€‚fdåœ¨Linuxæ–‡ä»¶ç³»ç»Ÿé‡Œèµ·åˆ°å¾ˆé‡è¦çš„ä½œç”¨ã€‚è¿™é‡Œå¯¹fdåšå‡ºæ€»ç»“ã€‚</p><p>å½“æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œå†…æ ¸å‘è¿›ç¨‹è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆ <code>open</code> ç³»ç»Ÿè°ƒç”¨å¾—åˆ° ï¼‰ï¼Œåç»­ <code>read</code>ã€<code>write</code> è¿™ä¸ªæ–‡ä»¶æ—¶ï¼Œåˆ™åªéœ€è¦ç”¨è¿™ä¸ª<strong>æ–‡ä»¶æè¿°ç¬¦</strong>fdæ¥æ ‡è¯†è¯¥æ–‡ä»¶ï¼Œå°†å…¶ä½œä¸ºå‚æ•°ä¼ å…¥ <code>read</code>ã€<code>write</code> ã€‚</p><p><strong>ä»€ä¹ˆæ—¶å€™ä¼šå‡ºç°å¤šä¸ªè¿›ç¨‹çš„ <code>fd</code> æŒ‡å‘åŒä¸€ä¸ª <code>file</code> ç»“æ„ä½“ï¼Ÿ</strong></p><p>åœ¨å­è¿›ç¨‹forkçˆ¶è¿›ç¨‹æ—¶ï¼Œå¦‚æœçˆ¶è¿›ç¨‹æ‰“å¼€äº†æ–‡ä»¶ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚</p><p><strong>ä»€ä¹ˆæ—¶å€™ï¼Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œå¤šä¸ª <code>fd</code> æŒ‡å‘åŒä¸€ä¸ª file ç»“æ„ï¼Ÿ</strong></p><p>åœ¨ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨dupçš„æ—¶å€™ï¼Œå¯èƒ½å‡ºç°</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">dup</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
 	                             <span class="token function">Returns</span> <span class="token punctuation">(</span>new<span class="token punctuation">)</span> file descriptor on success<span class="token punctuation">,</span> or â€“<span class="token number">1</span> on error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>dupç³»ç»Ÿè°ƒç”¨ç”¨äºè·å–ä¸€ä¸ªæ–°çš„fdæŒ‡å‘è¯¥fileç»“æ„ä½“</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">dup2</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                 <span class="token function">Returns</span> <span class="token punctuation">(</span>new<span class="token punctuation">)</span> file descriptor on success<span class="token punctuation">,</span> or â€“<span class="token number">1</span> on error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>dup2å¯ä»¥æŒ‡å®šè·å–çš„æ–°çš„fd</p><p>è¿›ç¨‹ <code>open</code> æ–‡ä»¶å¾—åˆ°ä¸€ä¸ªéè´Ÿæ•° <code>fd</code>ï¼Œä¹‹åé’ˆå¯¹è¯¥æ–‡ä»¶çš„ I/O æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ª <code>fd</code> ï¼›</p><p>æ–‡ä»¶æè¿°ç¬¦ <code>fd</code> æœ¬è´¨ä¸Šæ¥è®²å°±æ˜¯æ•°ç»„ç´¢å¼•ï¼Œ<code>fd</code> ç­‰äº 5 ï¼Œé‚£å¯¹åº”array__fdçš„ç¬¬ 5 ä¸ªå…ƒç´ è€Œå·²ï¼Œè¯¥æ•°ç»„æ˜¯è¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶çš„æ•°ç»„ï¼Œæ•°ç»„å…ƒç´ ç±»å‹ä¸º <code>struct file</code>ï¼›</p><p>ç»“æ„ä½“ <code>task_struct</code> å¯¹åº”ä¸€ä¸ªæŠ½è±¡çš„è¿›ç¨‹ï¼Œ<code>files_struct</code> æ˜¯è¿™ä¸ªè¿›ç¨‹ç®¡ç†<strong>è¯¥è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶</strong>æ•°ç»„ç®¡ç†å™¨ã€‚<code>fd</code> åˆ™å¯¹åº”äº†è¿™ä¸ªæ•°ç»„çš„ç¼–å·ï¼Œæ¯ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶ç”¨ <code>file</code> ç»“æ„ä½“è¡¨ç¤ºï¼Œå†…å«å½“å‰åç§»ç­‰ä¿¡æ¯ï¼›</p><p><code>file</code> ç»“æ„ä½“å¯ä»¥ä¸ºè¿›ç¨‹é—´å…±äº«ï¼Œå±äºç³»ç»Ÿçº§èµ„æºï¼ŒåŒä¸€ä¸ªæ–‡ä»¶å¯èƒ½å¯¹åº”å¤šä¸ª <code>file</code> ç»“æ„ä½“ï¼Œ<code>file</code> å†…éƒ¨æœ‰ä¸ª <code>inode</code> æŒ‡é’ˆï¼ŒæŒ‡å‘æ–‡ä»¶ç³»ç»Ÿçš„ <code>inode</code>ï¼›</p><p><code>inode</code> æ˜¯è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçº§åˆ«çš„æ¦‚å¿µï¼Œåªç”±æ–‡ä»¶ç³»ç»Ÿç®¡ç†ç»´æŠ¤ï¼Œä¸å› è¿›ç¨‹æ”¹å˜ï¼ˆ <code>file</code> æ˜¯è¿›ç¨‹å‡ºå‘åˆ›å»ºçš„ï¼Œè¿›ç¨‹ <code>open</code> åŒä¸€ä¸ªæ–‡ä»¶ä¼šå¯¼è‡´å¤šä¸ª <code>file</code> ï¼ŒæŒ‡å‘åŒä¸€ä¸ª <code>inode</code> ï¼‰</p><h3 id="åŒ¿å-fd" tabindex="-1"><a class="header-anchor" href="#åŒ¿å-fd" aria-hidden="true">#</a> åŒ¿å fd</h3><p>åœ¨ <code>/proc/${pid}/fd/</code> ä¸‹é¢èƒ½çœ‹åˆ° <code>anon_inode :</code> å‰ç¼€çš„å¥æŸ„ï¼Œå¦‚ä¸‹ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>root@ubuntu:~/temp# ll /proc/5398/fd

lr-x------ 1 root root 64 Aug 24 09:39 11 -&gt; anon_inode:inotify
lrwx------ 1 root root 64 Aug 24 09:39 4 -&gt; anon_inode:[eventpoll]
lrwx------ 1 root root 64 Aug 24 09:39 5 -&gt; anon_inode:[signalfd]
lrwx------ 1 root root 64 Aug 24 09:39 7 -&gt; anon_inode:[timerfd]
lrwx------ 1 root root 64 Aug 24 09:39 9 -&gt; anon_inode:[eventpoll]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ˜¯æ­£å¸¸çš„æ–‡ä»¶å¥æŸ„ï¼Œä¸€èˆ¬æ˜¾å¼çš„æ˜¯ä¸€ä¸ªè·¯å¾„ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>root@ubuntu:~/temp# ll /proc/5398/fd

lr-x------ 1 root root 64 Aug 24 09:39 10 -&gt; /proc/5398/mountinfo
lr-x------ 1 root root 64 Aug 24 09:39 12 -&gt; /proc/swaps
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ç„¶ path åªæ˜¯ä¸€ä¸ªæµ…å±‚æ¬¡çš„æ„Ÿå®˜ï¼Œå› ä¸ºå¯¹äº socket å¥æŸ„æ¥è¯´ä¹Ÿä¸ç®—æœ‰ path ï¼Œæ‰€ä»¥è¿™ä¸ªåŒ¿åå…¶å®<strong>åŒ¿çš„æ˜¯ inode</strong> ã€‚</p><p>åœ¨ Linux é‡Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œä½ ç†è§£çš„å¸¸è§â€œæ–‡ä»¶â€æœ‰ä»€ä¹ˆç‰¹æ€§ï¼Ÿæ˜¯<strong>è·¯å¾„</strong>ï¼Œä¹Ÿå°±æ˜¯ path ï¼Œ<strong>åŒ¿å</strong>çš„æ„æ€è¯´çš„å°±æ˜¯æ²¡æœ‰è·¯å¾„ï¼ˆ åœ¨å†…æ ¸é‡Œé¢è¯´çš„å°±æ˜¯æ²¡æœ‰æœ‰æ•ˆçš„ dentry ï¼‰ã€‚</p><p>åœ¨ Linux çš„æ–‡ä»¶ä½“ç³»ä¸­ï¼Œä¸€ä¸ªæ–‡ä»¶å¥æŸ„ï¼Œå¯¹åº”ä¸€ä¸ª file ç»“æ„ä½“ï¼Œå…³è”ä¸€ä¸ª inode ã€‚ <code>file/dentry/inode</code> è¿™ä¸‰é©¾é©¬è½¦æ˜¯ä¸€å®šè¦é…é½çš„ï¼Œå°±ç®—æ˜¯åŒ¿åçš„ï¼ˆæ—  pathï¼Œæ— æ•ˆ dentryï¼‰ï¼Œå¯¹äº file ç»“æ„ä½“æ¥è¯´ï¼Œä¸€å®šè¦ç»‘å®š inode å’Œ dentry ï¼Œ<strong>å“ªæ€•æ˜¯ä¼ªé€ çš„ã€ä¸å®Œæ•´çš„ inode</strong>ã€‚</p><p><strong>anon_inodefs</strong> å°±åº”è¿è€Œç”Ÿäº†ï¼Œå†…æ ¸å°±å¸®ä½ æå‡ºæ¥ä¸€ä¸ªå…¬å…±çš„ inode ï¼Œè¿™å°±èŠ‚çœäº†æ‰€æœ‰<strong>æœ‰è¿™æ ·éœ€æ±‚çš„å†…æ ¸æ¨¡å—</strong>ï¼Œé¿å…äº†å†…å­˜çš„æµªè´¹ï¼Œçœäº†å†—ä½™é‡å¤çš„ inode åˆå§‹åŒ–ä»£ç ã€‚</p><p>åŒ¿å fd èƒŒåçš„æ˜¯ä¸€ä¸ªå«åš anon_inodefs çš„å†…æ ¸æ–‡ä»¶ç³»ç»Ÿï¼ˆ ä½äº <code>fs/anon_inodes.c</code> ï¼‰ï¼Œè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿæå…¶ç®€å•ï¼Œæ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿåªæœ‰ä¸€ä¸ª inode ï¼Œè¿™ä¸ª inode æ˜¯æ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™åˆ›å»ºå¥½çš„ã€‚ä¹‹åï¼Œæ‰€æœ‰éœ€è¦ä¸€ä¸ªåŒ¿å inode çš„å¥æŸ„éƒ½ç›´æ¥è·Ÿè¿™ä¸ª inode å…³è”å³å¯ã€‚</p><ol><li>anon_inodefs æ˜¯ä¸ºäº†å…¬å…±éœ€æ±‚æŠ½ç¦»å‡ºæ¥çš„ä¸€ä¸ªå†…æ ¸æ–‡ä»¶ç³»ç»Ÿï¼Œåªæœ‰ä¸€ä¸ª inode ï¼Œä¸ºäº†èŠ‚çœå†…å­˜ï¼ŒæŠ½è±¡é‡å¤ä»£ç ä¹‹ç”¨ï¼›</li><li>åŒ¿åå¥æŸ„æ˜¯å› ä¸º fd å¯¹åº”çš„ file å®ä¾‹èƒŒé ç€çš„æ˜¯åŒ¿å inode ï¼Œanon_inodefs æä¾›äº†ä¸¤ä¸ªåŠŸèƒ½å‡½æ•°ï¼Œéƒ½æ˜¯ç”¨æ¥è·å–åŒ¿å fd çš„ï¼›</li><li>inode ä¸Šå¯ä»¥æŒ‚å¤šä¸ª dentry èŠ‚ç‚¹ï¼Œæ¢å¥è¯è¯´ï¼Œ<strong>ä¸€ä¸ª inode å¯ä»¥å‡ºç°åœ¨ Linux ç›®å½•æ ‘çš„å¤šä¸ªä½ç½®</strong>ï¼›</li><li>dentry å¯¹åº”ç›®å½•æ ‘çš„ä¸€ä¸ªèŠ‚ç‚¹ä½ç½®ï¼Œæœ€ç›´è§‚çš„æ˜¯å¯¹åº” path è·¯å¾„çš„ä¸€ä¸ªä½ç½®ï¼›</li><li>ä¸€ä¸ªæŒ‚è½½è·¯å¾„å¯ä»¥æŒ‚å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿå®ä¾‹ï¼Œåé¢çš„è¦†ç›–å‰é¢çš„ï¼Œæ‰€ä»¥å…‰é  dentry æ— æ³•å”¯ä¸€å®šä½ä¸€ä¸ªâ€œæ–‡ä»¶â€ï¼ŒLinux å†…æ ¸æ‰ç”¨ä¸¤å…ƒç»„ &lt; vfsmount, dentry &gt; æ¥å”¯ä¸€å®šä½ä¸€ä¸ªâ€œæ–‡ä»¶â€ï¼›</li></ol><h3 id="socket-fd" tabindex="-1"><a class="header-anchor" href="#socket-fd" aria-hidden="true">#</a> Socket fd</h3><p>vfs ä¸‹æœ‰ä¸€ä¸ª sockfs çš„æŠ½è±¡å±‚ï¼Œæ˜¯æŠŠ socket æŠ½è±¡æˆâ€œæ–‡ä»¶â€ fd çš„å…³é”®ä¹‹ä¸€ï¼›</p><p>socket fd èƒ½å¤Ÿå’Œæ–‡ä»¶ IO ä¸€æ ·ï¼Œä½¿ç”¨ write/read ç­‰ç³»ç»Ÿè°ƒç”¨ï¼Œå°±å¾—ç›Šäº vfs å¸®ä½ åšçš„è½¬æ¥ã€‚é‚£ <code>socket()</code> å‡½æ•°è°ƒç”¨æ˜¯ä¸æ˜¯å°±å’Œ open æ–‡ä»¶ fd çš„æ•ˆæœæ˜¯ä¸€æ ·çš„å‘€ï¼Ÿæ˜¯çš„ï¼Œéƒ½æ˜¯æ„å»ºå¹¶å…³è”å„ç§å†…æ ¸ç»“æ„ä½“ï¼›</p><h3 id="event-fd" tabindex="-1"><a class="header-anchor" href="#event-fd" aria-hidden="true">#</a> Event fd</h3><p>ä»å†…æ ¸2.6.22å¼€å§‹ï¼ŒLinuxé€šè¿‡Eventfd()ç³»ç»Ÿè°ƒç”¨æä¾›äº†é¢å¤–çš„éæ ‡å‡†åŒæ­¥æœºåˆ¶ã€‚æ­¤ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªEventfdå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å…·æœ‰ç”±å†…æ ¸ç»´æŠ¤çš„å…³è”8å­—èŠ‚æ— ç¬¦å·æ•´æ•°ã€‚ç³»ç»Ÿè°ƒç”¨è¿”å›å¼•ç”¨è¯¥å¯¹è±¡çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>å°†æ•´æ•°å†™å…¥æ­¤æ–‡ä»¶æè¿°ç¬¦ä¼šå°†è¯¥æ•´æ•°ä¸å¯¹è±¡çš„å€¼ç›¸åŠ ã€‚</p><p>å¦‚æœå¯¹è±¡çš„å€¼ä¸º0ï¼Œåˆ™ä»æ–‡ä»¶æè¿°ç¬¦ä¸­è¯»å–()ä¼šé˜»å¡ã€‚å¦‚æœå¯¹è±¡å…·æœ‰éé›¶å€¼ï¼Œåˆ™Read()è¿”å›è¯¥å€¼å¹¶å°†å…¶é‡ç½®ä¸º0ã€‚</p><p>æ­¤å¤–ï¼ŒPoll()ã€SELECT()æˆ–EPOLLå¯ç”¨äºæµ‹è¯•å¯¹è±¡æ˜¯å¦å…·æœ‰éé›¶å€¼ï¼›å¦‚æœå…·æœ‰éé›¶å€¼ï¼Œåˆ™æ–‡ä»¶æè¿°ç¬¦æŒ‡ç¤ºä¸ºå¯è¯»ã€‚å¸Œæœ›ä½¿ç”¨Eventfdå¯¹è±¡è¿›è¡ŒåŒæ­¥çš„åº”ç”¨ç¨‹åºå¿…é¡»é¦–å…ˆä½¿ç”¨Eventfd()åˆ›å»ºå¯¹è±¡ï¼Œç„¶åè°ƒç”¨fork()ä»¥åˆ›å»ºç»§æ‰¿å¼•ç”¨è¯¥å¯¹è±¡çš„æ–‡ä»¶æè¿°ç¬¦çš„ç›¸å…³è¿›ç¨‹ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/eventfd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">eventfd</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> initval<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
																		returns eventfd
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åªæœ‰å®ç°äº† <code>file_operation-&gt;poll</code> çš„è°ƒç”¨çš„â€œæ–‡ä»¶â€ fd æ‰èƒ½è¢« epoll ç®¡ç†ã€‚eventfd åˆšå¥½å°±å®ç°äº†è¿™ä¸ªæ¥å£ã€‚</p><p>eventfd æ˜¯ä¸“é—¨ç”¨æ¥ä¼ é€’äº‹ä»¶çš„ fd ï¼Œè€Œ epoll æ± åˆ™æ˜¯ä¸“é—¨ç”¨æ¥ç®¡ç†äº‹ä»¶çš„æ± å­ï¼Œå®ƒä»¬ä¸¤ç»“åˆå°±å¦™äº†ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ epoll ç›‘å¬çš„æ˜¯<strong>å¯è¯»å¯å†™äº‹ä»¶</strong>ã€‚é‚£ä¹ˆä½ æƒ³è¿‡ eventfd çš„å¯è¯»å¯å†™äº‹ä»¶æ˜¯å•¥å—ï¼Ÿ</p><p>â€œ<strong>å¯è¯»å¯å†™äº‹ä»¶</strong>â€è¿™æ˜¯ä¸ªæœ‰è¶£çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å»å‘æ•£ä¸‹ï¼Œå¯¹æ¯”æ€è€ƒä¸‹ socket fdï¼Œæ–‡ä»¶ fdï¼š</p><ul><li>socket fdï¼šç¼“å­˜åŒºå¯ä»¥å†™å…¥å‘é€æ•°æ®ï¼Œé‚£ä¹ˆè§¦å‘å¯å†™äº‹ä»¶ï¼Œç½‘å¡ä¸­æ¥è‡ªå…¶ä»–ç½‘ç»œçš„æ•°æ®æ¥äº†ï¼Œå¯ä»¥è¯»ï¼Œè§¦å‘å¯è¯»äº‹ä»¶ï¼›</li><li>æ–‡ä»¶ fdï¼šæ–‡ä»¶ fd çš„å¯è¯»å¯å†™äº‹ä»¶å°±æ›´æœ‰æ„æ€äº†ï¼Œå› ä¸ºæ–‡ä»¶ä¸€ç›´æ˜¯å¯å†™çš„ï¼Œæ‰€ä»¥ä¸€ç›´éƒ½è§¦å‘å¯å†™äº‹ä»¶ï¼Œæ–‡ä»¶é‡Œçš„æ•°æ®ä¹Ÿä¸€ç›´æ˜¯å¯è¯»çš„ï¼Œæ‰€ä»¥ä¸€ç›´è§¦å‘å¯è¯»äº‹ä»¶ã€‚è¿™ä¸ªä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç±»ä¼¼ ext4 è¿™ç§æ–‡ä»¶ä¸å®ç° poll æ¥å£çš„åŸå› ã€‚<strong>å› ä¸ºæ–‡ä»¶ fd ä¸€ç›´æ˜¯å¯è¯»å¯å†™çš„ï¼Œpoll ç›‘å¬æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼›</strong></li></ul><p>eventfd å®ç°çš„æ˜¯è®¡æ•°çš„åŠŸèƒ½ã€‚æ‰€ä»¥ eventfd è®¡æ•°ä¸ä¸º 0 ï¼Œé‚£ä¹ˆ fd æ˜¯å¯è¯»çš„ã€‚</p><p>ç”±äº eventfd ä¸€ç›´å¯å†™ï¼ˆå¯ä»¥ä¸€ç›´ç´¯è®¡è®¡æ•°ï¼‰ï¼Œæ‰€ä»¥ä¸€ç›´æœ‰å¯å†™äº‹ä»¶ã€‚</p><p>æ‰€ä»¥ï¼Œè¿™é‡Œæœ‰ä¸ªä»€ä¹ˆéšè—çŸ¥è¯†ç‚¹å‘¢ï¼Ÿ</p><p><strong>eventfd å¦‚æœç”¨ epoll ç›‘å¬äº‹ä»¶ï¼Œé‚£ä¹ˆéƒ½æ˜¯ç›‘å¬è¯»äº‹ä»¶ï¼Œå› ä¸ºç›‘å¬å†™äº‹ä»¶æ— æ„ä¹‰ã€‚</strong></p><p>æœ€ç®€å•çš„ä¾‹å­ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…å’Œå¤šä¸ªç”Ÿäº§è€…ï¼Œè¿™ç§å°±å¯ä»¥å€ŸåŠ© eventfd ä¼˜é›…çš„å®Œæˆäº‹ä»¶é€šçŸ¥ã€‚</p><p>ç”Ÿäº§è€…ï¼š</p><p>æ˜¯å¤šä¸ªçº¿ç¨‹ï¼Œä¼šæŠŠè¯·æ±‚æŠ•é€’åˆ°ä¸€ä¸ª list ä¸­ï¼Œç„¶åå”¤é†’ç”Ÿäº§è€…ã€‚</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>producer:
    // æŠ•é€’è¯·æ±‚åˆ°é“¾è¡¨
    list_add( global_list, request )
    // å”¤é†’æ¶ˆè´¹è€…å¤„ç†
    write(eventfd, &amp;cnt /* 1 */ , 8)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¶ˆè´¹è€…ï¼š</p><p>æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œåå° loop å¤„ç†ã€‚ä½¿ç”¨ epoll ç›‘å¬ eventfd çš„å¯è¯»äº‹ä»¶ï¼Œè¿™æ ·èƒ½åšåˆ°ä¸€æ—¦æœ‰è¯·æ±‚å…¥é˜Ÿï¼Œæ¶ˆè´¹è€…å°±ç«‹é©¬å”¤é†’å¤„ç†ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>consumer 
    <span class="token comment">// æ·»åŠ  eventfd åˆ°ç›‘å¬æ± </span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> eventfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ee<span class="token punctuation">)</span><span class="token punctuation">;</span>

loop<span class="token operator">:</span>
    <span class="token comment">// ç­‰å¾…å”¤é†’</span>
    <span class="token function">epoll_wait</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// è¯»å–æ–°æ·»åŠ åˆ°åˆ—è¡¨é‡Œçš„å…ƒç´ ä¸ªæ•°ï¼Œå¹¶ä¸”è¿›è¡Œå¤„ç†ï¼›</span>
    n <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>eventfd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
    <span class="token comment">// éå†é“¾è¡¨å¤„ç†</span>
    <span class="token keyword">for</span> each global_list<span class="token operator">:</span>
        <span class="token comment">// do something</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>eventfd å®ç°äº† read/write çš„æ¥å£ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªè®¡æ•°å™¨çš„å®ç°ï¼›</p><p>eventfd å®ç°äº† poll æ¥å£ï¼Œæ‰€ä»¥å¯ä»¥å’Œ epoll åŒå‰‘åˆç’§ï¼Œå®ç°äº‹ä»¶çš„é€šçŸ¥ç®¡ç†ï¼›</p><p>eventfd å¯ä»¥å’Œ libaio &amp; epoll ä¸€èµ·ï¼Œå®ç° Linux ä¸‹çš„çº¯å¼‚æ­¥ IOï¼›</p><p>eventfd ç›‘å¬å¯è¯»äº‹ä»¶æ‰æœ‰æ„ä¹‰ï¼›</p><p>ext4 è¿™ç§æ–‡ä»¶ fd ä¸€ç›´å¯è¯»å¯å†™ï¼Œæ‰€ä»¥å®ç° poll æ¯«æ— æ„ä¹‰ã€‚eventfd ä¸€ç›´å¯å†™ï¼Œæ‰€ä»¥ç›‘å¬å¯å†™æ¯«æ— æ„ä¹‰ï¼›</p><p>eventfd å¯ä»¥ç»“åˆä¸šåŠ¡ï¼Œåšä¸€ä¸ªäº‹ä»¶é€šçŸ¥çš„é€šä¿¡æœºåˆ¶ï¼Œéå¸¸å·§å¦™ï¼›</p><h3 id="signal-fd" tabindex="-1"><a class="header-anchor" href="#signal-fd" aria-hidden="true">#</a> Signal fd</h3><p>ä¿¡å·ï¼ˆ signal ï¼‰æœ¬è´¨æ˜¯ Linux è¿›ç¨‹é—´é€šä¿¡çš„ä¸€ç§æœºåˆ¶ï¼Œä¹Ÿå«<strong>è½¯ä¸­æ–­ä¿¡å·</strong>ã€‚æ—¢ç„¶æ˜¯é€šä¿¡æœºåˆ¶ï¼Œé‚£ä¹ˆå°±æ˜¯ä¼ é€’ä¿¡æ¯ç”¨çš„ï¼Œä¿¡å·ä¼ é€’çš„ä¿¡æ¯å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œä¸€èˆ¬ç”¨äºé…åˆç³»ç»Ÿç®¡ç†ä»»åŠ¡ï¼Œæ¯”å¦‚è¿›ç¨‹çš„ç»ˆç»“ã€æ¢å¤ã€çƒ­åŠ è½½ç­‰ã€‚</p><p>ä¿¡å·éƒ½ç”¨æ•´æ•°å¸¸é‡è¡¨ç¤ºï¼Œå‘½åä»¥ SIG æœªå‰ç¼€ï¼Œæ¯”å¦‚ SIGINTï¼ˆ ctrl-c è§¦å‘ï¼‰ï¼ŒSIGKILLï¼ˆ kill -9 è§¦å‘ ï¼‰ã€‚</p><p><strong>ä¿¡å·ä¸€èˆ¬æ€ä¹ˆäº§ç”Ÿï¼Ÿ</strong></p><ul><li>ç”±å†…æ ¸äº§ç”Ÿï¼Œæ¯”å¦‚å†…å­˜é”™è¯¯ï¼Œé™¤ 0 ç­‰é”™è¯¯ï¼Œå†…æ ¸é€šè¿‡ä¿¡å·é€šçŸ¥åˆ°ç›¸åº”çš„è¿›ç¨‹ï¼›</li><li>å¯ä»¥ç”±å…¶ä»–è¿›ç¨‹ä¼ é€’ç»™ç›®æ ‡è¿›ç¨‹ï¼Œæ¯”å¦‚ kill å‘½ä»¤å°±æ˜¯ä¸“é—¨å¹²è¿™ä¸ªäº‹æƒ…çš„ï¼›</li></ul><p><strong>ä¿¡å·å¤„ç†åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ</strong>ï¼š</p><ul><li>å‘é€é˜¶æ®µï¼šå†…æ ¸å°†ä¿¡å·ï¼ˆsignalï¼‰æ”¾åˆ°å¯¹åº”çš„ pending é˜Ÿåˆ—ä¸­ï¼›</li><li>ä¼ é€’é˜¶æ®µï¼šä¹Ÿå«åšå¤„ç†é˜¶æ®µï¼Œå†…æ ¸å°†ä¿¡å·ä» pending é˜Ÿåˆ—ä¸­å–å‡ºæ¥ï¼Œå¹¶ä¸”è¿›è¡Œå¤„ç†ï¼Œä¸€èˆ¬æ˜¯è°ƒç”¨ç›¸åº”çš„å›è°ƒå‡½æ•°ï¼ˆå¤„ç†æ–¹å¼æœ‰ä¸‰ç§ï¼šç”¨æˆ·å®šä¹‰ã€å†…æ ¸é»˜è®¤å®šä¹‰ SIG_DELã€å¿½ç•¥ SIG_IGNï¼‰ï¼›</li></ul><p>äº†è§£äº†ä»€ä¹ˆæ˜¯ä¿¡å·ï¼ˆ signal ï¼‰ï¼Œé‚£ signalfd åˆä¼šæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>æ˜¯ä¸€ä¸ªè·Ÿä¿¡å·å…³è”çš„<strong>æ–‡ä»¶æè¿°ç¬¦</strong>ï¼Œèƒ½å¤Ÿä»¥ io çš„è¡Œä¸ºè·å–åˆ°ç³»ç»Ÿä¿¡å·ï¼Œå±æ€§ä¸Šæ¥è®² signalfd ä¹Ÿæ˜¯ä¸€ä¸ªåŒ¿å fd ç±»å‹ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/signalfd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">signalfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">sigset_t</span> <span class="token operator">*</span>mask<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿”å›è¯¥ä¿¡å·è°ƒç”¨çš„fd</p><p>è¯»ä¸€ä¸ª signalfd çš„æ“ä½œéå¸¸ç®€å•ï¼Œä¸»è¦é€»è¾‘ï¼š</p><ol><li>æŸ¥çœ‹å½“å‰é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ä¿¡å·ï¼Œæœ‰çš„è¯å°±å–å‡ºæ¥ï¼Œå¡«å……åˆ°ç”¨æˆ·ç»™çš„ç»“æ„ä½“ä¸­ï¼›</li><li>å¦‚æœå¥æŸ„æ˜¯é˜»å¡ç±»å‹çš„ï¼Œåœ¨æ²¡æœ‰ä¿¡å·çš„æ—¶å€™ï¼Œä¼šåˆ‡èµ° cpuï¼Œç­‰åˆ°æœ‰ä¿¡å·çš„æ—¶å€™åˆ‡å›æ¥ã€‚å¦‚æœæ˜¯éé˜»å¡ç±»å‹çš„ï¼Œç›´æ¥æŠ¥é”™ï¼Œè¿”å› EAGAIN ï¼›</li></ol><p><strong>è¿›ç¨‹æœ‰ä¿¡å·çš„æ—¶å€™ï¼Œsignalfd å¥æŸ„å°±æ˜¯å¯è¯»çš„</strong>ã€‚</p><p>ä¿¡å·ä¹Ÿå®ç°äº†pollè¯­å¥ï¼Œå› æ­¤å¯ä»¥å’Œepollè¿›è¡Œå…³è”</p><p><code>epoll_ctl</code> æ³¨å†Œ signalfd çš„æ—¶å€™ï¼Œè°ƒç”¨ <code>signalfd_poll</code> ï¼Œ<code>signalfd_poll</code> ä¼šæŠŠ epoll åˆ›å»ºçš„ wait entry æŒ‚åˆ° <code>current-&gt;sighand</code> ä¸Šã€‚å”¤é†’çš„æ—¶å€™è°ƒç”¨è¿™ä¸ª wait é“¾è¡¨çš„å›è°ƒã€‚</p><p>æ‰€æœ‰çš„ä¿¡å·å‘é€éƒ½ä¼šè°ƒç”¨åˆ° <code>send_signal</code> ï¼Œåœ¨è¿™ä¸ªé‡Œé¢å®ç°äº†å”¤é†’ <code>sighand-&gt;signalfd_wqh</code> é“¾è¡¨çš„æ“ä½œã€‚ä»è€Œä½¿å¾— epoll æ„ŸçŸ¥åˆ° signalfd å¯è¯»äº†ï¼ˆå› ä¸ºæ¥ä¿¡å·äº†ï¼‰ï¼Œä½¿å¾— epoll ä» epoll_wait å‡ºå”¤é†’ï¼Œç„¶åè°ƒç”¨ read æ“ä½œï¼ŒæŠŠä¿¡å·çš„ç›¸å…³ä¿¡æ¯ä»å¥æŸ„ä¸­è¯»å‡ºæ¥ã€‚</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>signalfd_notify
    -&gt; wake_up ï¼ˆå”¤é†’ç­‰å¾…é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯ epollï¼‰
        -&gt; ep_poll_callback
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>waitå”¤é†’çš„æ—¶æœºåœ¨<strong>ä¿¡å·å‘é€</strong>çš„è¿‡ç¨‹ã€‚</p><p><strong>æ€»ç»“</strong></p><ol><li>ä¿¡å·èƒ½å¤Ÿåƒæ–‡ä»¶ä¸€æ · read å‡ºæ¥ï¼Œè¿™ç§ä¼˜é›…çš„ä¿¡å·å¤„ç†æ–¹å¼å¾—ç›Šäº signalfd çš„å°è£…ï¼›</li><li>ä¿¡å·æ˜¯æŒ‚åœ¨åœ¨è¿›ç¨‹ task_struct ç»“æ„ä½“ä¸Šçš„ï¼Œä¿¡å·é˜Ÿåˆ—éç©ºçš„æ—¶å€™ signalfd å¥æŸ„å¯è¯»ï¼›</li><li>å’Œ epoll æ± çš„é…åˆåŒæ ·è¿˜æ˜¯è€å¥—è·¯ï¼Œepoll_ctl æ³¨å†Œçš„æ—¶å€™è°ƒç”¨ <code>.poll</code> æ¥å£æŒ‚è½½ epoll çš„ wait entry åˆ° <code>sighand-&gt;signalfd_wqh</code> ä¹‹ä¸Šï¼Œä¿¡å·å‘é€æ—¶ï¼ˆï¼‰å”¤é†’ epoll ï¼›</li><li>signalfd æ˜¯ä¸€ç§åŒ¿å fd ç±»å‹ï¼›</li></ol><h3 id="timer-fd" tabindex="-1"><a class="header-anchor" href="#timer-fd" aria-hidden="true">#</a> **Timer fd **</h3><p>ä»€ä¹ˆæ˜¯ timerfd ï¼Ÿè¿™æ˜¯ä¸€ä¸ªè·Ÿæ—¶é—´æœ‰å…³ç³»çš„ fd ç±»å‹ï¼Œé€šå¸¸å«åšå®šæ—¶å™¨ fd ï¼Œå…ˆå»çœ‹ä¸€ä¸‹ timerfd çš„æ ·å­å§ã€‚å¥‡ä¼¢åœ¨ Linux çš„æœºå™¨ä¸Šæ‰¾äº†ä¸€ä¸ª open äº† timerfd çš„è¿›ç¨‹ï¼Œå¦‚ä¸‹ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>root@ubuntu:~# ll /proc/6997/fd/
...
lrwx------ 1 root root 64 Aug 10 14:13 3 -&gt; anon_inode:[timerfd]

root@ubuntu:~# cat /proc/6997/fdinfo/3 
pos: 0
flags: 02
mnt_id: 11
clockid: 0
ticks: 0
settime flags: 01
it_value: (0, 969820149)
it_interval: (1, 0)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ proc fs é€šè¿‡ <code>/proc/${pid}/fd/</code> å¯ä»¥çœ‹åˆ°è¿›ç¨‹æ‰“å¼€çš„å¥æŸ„ã€‚è¿™é‡Œçœ‹åˆ°æŒºå…³é”®çš„ä¿¡æ¯ï¼š<code>anon_inode:[timerfd]</code>ï¼Œè¯´æ˜ <strong>timerfd ç»‘å®šçš„æ˜¯åŒ¿å inode</strong>ã€‚</p><p>é€šè¿‡ <code>/proc/${pid}/fdinfo/</code> å¯ä»¥çœ‹åˆ°å¥æŸ„çš„å±•ç¤ºä¿¡æ¯ã€‚</p><ul><li>clockidï¼šæ—¶é’Ÿç±»å‹ï¼›</li><li>ticksï¼šè¶…æ—¶æ¬¡æ•°ï¼›</li><li>settime flagsï¼šè¿™ä¸ªæ˜¯ <code>timerfd_settime</code> çš„å‚æ•°ï¼›</li><li>it_valueï¼šå®šæ—¶å™¨åˆ°æœŸè¿˜å‰©å¤šå°‘æ—¶é—´ï¼›</li><li>it_intervalï¼šè¶…æ—¶é—´éš”ï¼›</li></ul><p>timerfd è¿™ä¸ªåå­—æ‹†å¼€æ¥çœ‹ï¼Œå°±æ˜¯ timer fdï¼Œæ‰€è°“å®šæ—¶å™¨ fd ç±»å‹ï¼Œé‚£ä¹ˆå®ƒçš„å¯è¯»å¯å†™äº‹ä»¶ä¸€å®šæ˜¯è·Ÿæ—¶é—´æœ‰å…³ç³»ã€‚timerfd è¢« new å‡ºæ¥ä¹‹å ï¼ˆ <code>timerfd_create</code> ï¼‰ï¼Œå¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆ <code>timerfd_setting</code> ï¼‰ï¼Œè¶…æ—¶ä¹‹åï¼Œè¯¥å¥æŸ„å¯è¯»ï¼Œè¯»å‡ºæ¥çš„æ˜¯<strong>è¶…æ—¶çš„æ¬¡æ•°</strong>ã€‚</p><p>æ–‡ä»¶å¥æŸ„ï¼Œç½‘ç»œå¥æŸ„éƒ½æ˜¯å¯ä»¥ <code>read</code>/<code>write</code>/<code>close</code> çš„ï¼Œtimerfd å¯ä»¥åšä»€ä¹ˆï¼Ÿ</p><p>timerfd å¯ä»¥ <code>read</code>ï¼Œ<code>poll</code>ï¼Œ<code>close</code> ï¼Œè¿™ä¸ªä»å†…æ ¸å®ç°çš„æ¥å£å¯çŸ¥ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>// fs/timerfd.c
static const struct file_operations timerfd_fops = { 
    .release    = timerfd_release,
    .poll       = timerfd_poll,
    .read       = timerfd_read,
    .show_fdinfo    = timerfd_show,
    // ...
};
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®šæ—¶å™¨å¥æŸ„ timerfd çš„å®ç°å°±å†…èšåœ¨ <code>fs/timerfd.c</code> ä¸€ä¸ªæ–‡ä»¶ã€‚</p><p>è¿˜è®°å¾—ä¸Šé¢ <code>cat /proc/${pid}/fdinfo/</code> é‡Œé¢å±•ç¤ºçš„ä¿¡æ¯å—ï¼Ÿå°±æ˜¯ <code>timerfd_show</code> è´Ÿè´£å±•ç¤ºçš„ã€‚</p><p>timerfd å¸¸ç”¨æ¥åšå®šæ—¶å™¨çš„ä½¿ç”¨ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ä¹‹åï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ timerfd å°±æ˜¯å¯è¯»çš„ã€‚</p><ol><li>procfs æ˜¯å†…æ ¸æä¾›ç»™ç”¨æˆ·æ¢è§†è¿›ç¨‹ç»†èŠ‚çš„æ¥å£ï¼Œéå¸¸é‡è¦ï¼Œ<code>/proc/${pid}/fd/</code> ä¸‹æœ‰æ‰€æœ‰æ‰“å¼€çš„å¥æŸ„ï¼Œ <code>/proc/${pid}/fdinfo/</code> ä¸‹èƒ½çœ‹åˆ°å¥æŸ„çš„è¯¦ç»†ä¿¡æ¯ï¼ŒæŒ‚é’©çš„æ˜¯ <code>.show_fdinfo</code> å›è°ƒå®ç°ï¼›</li><li>timerfd çš„æ ¸å¿ƒç»“æ„æ˜¯ <code>timerfd_ctx</code> ï¼Œé€šè¿‡ fd å…ˆæ‰¾åˆ° file ç»“æ„ä½“ï¼Œå®ƒå°±è—åœ¨ <code>file-&gt;private_data</code> è¿™é‡Œï¼›</li><li>timerfd æ˜¯ç›´æ¥å¤ç”¨çš„ hrtimer æˆ–è€… alarm ç±»å‹çš„å®šæ—¶å™¨ï¼Œtimerfd æœ¬èº«åªæ˜¯å¯¹<strong>å®šæ—¶å™¨</strong>åšçš„<strong>æ–‡ä»¶æ¥å£</strong>çš„å°è£…ï¼›</li><li>å†…æ ¸æä¾›äº†ä¸€å¥—åå« <strong>anon_inodefs çš„åŒ¿åæ–‡ä»¶ç³»ç»Ÿ</strong>ã€‚å¯¹äºæƒ³å®ç°æ–‡ä»¶æ¥å£ï¼Œä½†åˆä¸æƒ³å®ç°å®Œæ•´çš„ inode åŠŸèƒ½çš„å¥æŸ„ç±»å‹æ˜¯ç¦éŸ³ï¼Œtimerfd ï¼Œeventfdï¼Œeventpoll ç­‰ç±»å‹çš„ fd éƒ½å¾—ç›Šäºæ­¤ï¼›</li><li>timerfd å¥æŸ„ <code>timerfd_create</code> åˆ›å»ºçš„æ—¶å€™å‡†å¤‡å¥½ç­‰å¾…é˜Ÿåˆ— <code>ctx-&gt;wqh</code> ï¼Œ<code>timerfd_settime</code> è®¾ç½®å®šæ—¶å›è°ƒ <code>timerfd_tmrproc</code>ï¼Œ<code>epoll_ctl</code> æ³¨å†Œå¥æŸ„çš„æ—¶å€™æŠŠ <code>ep_poll_back</code> è£…è¿› wait å¯¹è±¡å¹¶æŒ‚åˆ° <code>ctx-&gt;wqh</code> é“¾è¡¨ä¹‹ä¸Šã€‚å®šæ—¶å™¨è¶…æ—¶çš„æ—¶å€™ï¼Œç”± timerfd_tmrproc éå† <code>ctx-&gt;wqh</code> ï¼Œè°ƒç”¨ <code>ep_poll_callback</code> ä»è€Œå®Œæˆäº‹ä»¶è§¦å‘ï¼›</li></ol></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/main/demo/theme-docs/src/article/os/filesystem.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><!----><!----></footer><!----><div class="giscus-wrapper input-top" style="display:block;"><div style="text-align:center">Loading...</div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">[ä¸»é¢˜æ¥æº](https://vuepress-theme-hope.github.io/v2/zh/guide)</div><div class="copyright">Copyright Â© 2023 Pineapple</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-89ebfde6.js" defer></script>
  </body>
</html>

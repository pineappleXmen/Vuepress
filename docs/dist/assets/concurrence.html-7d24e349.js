import{_ as p,V as o,W as l,Y as n,Z as s,$ as t,a0 as e,D as c}from"./framework-3845b112.js";const i="/os/CPU80486.png",u="/os/CPU80486cache.png",r={},d=e(`<div class="custom-container tip"><p class="custom-container-title">å¹¶å‘æ¨¡å—</p><p>å¤šå¤„ç†å™¨ç¼–ç¨‹</p><p>ç†è§£å¹¶å‘ç¨‹åºæ‰§è¡Œ</p><p>å¹¶å‘æ§åˆ¶</p><p>å¹¶å‘ç¼–ç¨‹åŠå¯¹Bugåº”å¯¹</p></div><div class="custom-container note"><p class="custom-container-title">ä»€ä¹ˆæ˜¯å¹¶å‘(Concurrent)</p><p>Concurrent: existing, happening, or done <strong><em>at the same time</em>.</strong></p><p>In computer science, concurrency refers to the ability of different parts or units of a program, algorithm, or problem to be executed out-of-order or in partial order, without affecting the final outcome. (Wikipedia)</p></div><p>å¦‚æœä½¿ç”¨çŠ¶æ€æœºçš„è§†è§’æŸ¥çœ‹å¹¶å‘ç¨‹åºï¼Œå¹¶å‘çš„ç¨‹åºå®é™…æ˜¯ä¸€ä¸ªå…±äº«å†…å­˜çš„å¤šä¸ªæ‰§è¡Œæµ</p><p>å…±äº«å†…å­˜çš„å¤šä¸ªæ‰§è¡Œæµ</p><ul><li>æ‰§è¡Œæµæ‹¥æœ‰ç‹¬ç«‹çš„å †æ ˆ/å¯„å­˜å™¨</li><li>å…±äº«å…¨éƒ¨çš„å†…å­˜ (æŒ‡é’ˆå¯ä»¥äº’ç›¸å¼•ç”¨)</li></ul><p>å¤šä¸ªæ‰§è¡Œæµä¼šå¸¦æ¥æ–¹ä¾¿ï¼ŒåŒæ—¶ä¹Ÿæ‰“å¼€äº†æ½˜å¤šæ‹‰çš„é­”ç›’</p><div class="custom-container note"><p class="custom-container-title">å¹¶å‘ç¨‹åºå¸¦æ¥çš„é—®é¢˜</p><p>åŸå­æ€§ç¼ºå¤±</p><p>é¡ºåºæ€§ç¼ºå¤±</p><p>å¯è§æ€§ç¼ºå¤±</p></div><h2 id="å¤šå¤„ç†å™¨ç¼–ç¨‹" tabindex="-1"><a class="header-anchor" href="#å¤šå¤„ç†å™¨ç¼–ç¨‹" aria-hidden="true">#</a> å¤šå¤„ç†å™¨ç¼–ç¨‹</h2><h3 id="åŸå­æ€§" tabindex="-1"><a class="header-anchor" href="#åŸå­æ€§" aria-hidden="true">#</a> <strong>åŸå­æ€§</strong></h3><p>åŸå­æ€§ï¼šä¸€æ®µä»£ç æ‰§è¡Œ (ä¾‹å¦‚ <code>pay()</code>) ç‹¬å æ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿ</p><ul><li>å•å¤„ç†å™¨å¤šçº¿ç¨‹ <ul><li>çº¿ç¨‹åœ¨è¿è¡Œæ—¶å¯èƒ½è¢«ä¸­æ–­ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ</li></ul></li><li>å¤šå¤„ç†å™¨å¤šçº¿ç¨‹ <ul><li>çº¿ç¨‹æ ¹æœ¬å°±æ˜¯å¹¶è¡Œæ‰§è¡Œçš„</li></ul></li></ul><p>åœ¨å¤šå¤„ç†å™¨æ—¶ä»£ï¼Œç¨‹åºçš„åŸå­æ€§æ— æ³•è¢«ä¿è¯ã€‚æ­¤æ—¶éœ€è¦ä½¿ç”¨å…¶ä»–çš„æ–¹å¼æ¥ä¿è¯åœ¨å¹¶å‘çŠ¶æ€ä¸‹çš„ç¨‹åºçš„åŸå­æ€§ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•å®ç°å¹¶å‘ç¨‹åºçš„åŸå­æ€§å‘¢ï¼Ÿ</p><ul><li><code>lock(&amp;lk)</code></li><li><code>unlock(&amp;lk)</code><ul><li>å®ç°ä¸´ç•ŒåŒº (critical section) ä¹‹é—´çš„ç»å¯¹ä¸²è¡ŒåŒ–</li><li>ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ä¾ç„¶å¯ä»¥å¹¶è¡Œæ‰§è¡Œ</li></ul></li></ul><p>99% çš„å¹¶å‘é—®é¢˜éƒ½å¯ä»¥ç”¨ä¸€ä¸ªé˜Ÿåˆ—è§£å†³</p><ul><li>æŠŠå¤§ä»»åŠ¡åˆ‡åˆ†æˆå¯ä»¥å¹¶è¡Œçš„å°ä»»åŠ¡</li><li>worker thread å»é”ä¿æŠ¤çš„é˜Ÿåˆ—é‡Œå–ä»»åŠ¡</li><li>é™¤å»ä¸å¯å¹¶è¡Œçš„éƒ¨åˆ†ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†å¯ä»¥è·å¾—çº¿æ€§çš„åŠ é€Ÿ</li></ul><h3 id="é¡ºåºæ€§" tabindex="-1"><a class="header-anchor" href="#é¡ºåºæ€§" aria-hidden="true">#</a> <strong>é¡ºåºæ€§</strong></h3><div class="custom-container note"><p class="custom-container-title">ç¼–è¯‘å™¨çš„ä¼˜åŒ–</p><p>ç¼–è¯‘å™¨å¯¹å†…å­˜è®¿é—® â€œeventually consistentâ€ çš„å¤„ç†å¯¼è‡´å…±äº«å†…å­˜ä½œä¸ºçº¿ç¨‹åŒæ­¥å·¥å…·çš„å¤±æ•ˆã€‚</p></div><p>åœ¨Cç¨‹åºè¢«ç¼–è¯‘æˆæ±‡ç¼–ç çš„è¿‡ç¨‹é‡Œï¼Œå¹¶ä¸ä¼šä¿è¯ç¨‹åºæ‰§è¡Œçš„é¡ºåºæ€§ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼ŒCPUä¹Ÿæ˜¯ç¼–è¯‘å™¨ï¼Œä¼šå¯¹æ±‡ç¼–ç è¿›è¡Œè¿›ä¸€æ­¥çš„ä¼˜åŒ–ã€‚è¿™ä¹Ÿä¼šå¯¼è‡´ä»£ç é¡ºåºæ€§çš„é”™è¯¯ã€‚</p><p>å¦‚ä½•ä¿è¯é¡ºåºæ€§ï¼Ÿ</p><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å†…è”æ±‡ç¼–è¯­å¥å®ç°å†…å­˜å±éšœ</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">asm</span> <span class="token keyword">volatile</span> <span class="token punctuation">(</span><span class="token string">&quot;&quot;</span> <span class="token operator">::</span><span class="token operator">:</span> <span class="token string">&quot;memory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>__volatile__å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œä¸¥ç¦å°†æ­¤å¤„çš„æ±‡ç¼–è¯­å¥ä¸å…¶å®ƒçš„è¯­å¥é‡ç»„åˆä¼˜åŒ–ã€‚å³ï¼šåŸåŸæœ¬æœ¬æŒ‰åŸæ¥çš„æ ·å­å¤„ç†è¿™è¿™é‡Œçš„æ±‡ç¼–ã€‚ <strong>memory</strong>å¼ºåˆ¶ gcc ç¼–è¯‘å™¨å‡è®¾ RAM æ‰€æœ‰å†…å­˜å•å…ƒå‡è¢«æ±‡ç¼–æŒ‡ä»¤ä¿®æ”¹ï¼Œè¿™æ · cpu ä¸­çš„ registers å’Œ cache ä¸­å·²ç¼“å­˜çš„å†…å­˜å•å…ƒä¸­çš„æ•°æ®å°†ä½œåºŸã€‚**cpu å°†ä¸å¾—ä¸åœ¨éœ€è¦çš„æ—¶å€™é‡æ–°è¯»å–å†…å­˜ä¸­çš„æ•°æ®ã€‚**è¿™å°±é˜»æ­¢äº† cpu åˆå°† registers, cache ä¸­çš„æ•°æ®ç”¨äºå»ä¼˜åŒ–æŒ‡ä»¤ï¼Œè€Œé¿å…å»è®¿é—®å†…å­˜ã€‚ &quot;&quot;::: è¡¨ç¤ºè¿™æ˜¯ä¸ªç©ºæŒ‡ä»¤ã€‚barrier() ä¸ç”¨åœ¨æ­¤æ’å…¥ä¸€æ¡ä¸²è¡ŒåŒ–æ±‡ç¼–æŒ‡ä»¤ã€‚åœ¨åæ–‡å°†è®¨è®ºä»€ä¹ˆå«ä¸²è¡ŒåŒ–æŒ‡ä»¤ã€‚</p><p>é‚£ä¹ˆè¿™å¥è¯æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå®ƒåªæ˜¯æ’å…¥äº†ä¸€ä¸ªç©ºæŒ‡ä»¤&quot;&quot;ï¼Œä»€ä¹ˆä¹Ÿæ²¡åšã€‚å…¶å®ä¸ç„¶ï¼Œè¿™å¥è¯çš„å…³é”®åœ¨æœ€åçš„&quot;memory&quot; clobberï¼Œå®ƒå‘Šè¯‰ç¼–è¯‘å™¨ï¼šè¿™æ¡æŒ‡ä»¤ï¼ˆå…¶å®æ˜¯ç©ºçš„ï¼‰å¯èƒ½ä¼šè¯»å–ä»»ä½•å†…å­˜åœ°å€ï¼Œä¹Ÿå¯èƒ½ä¼šæ”¹å†™ä»»ä½•å†…å­˜åœ°å€ã€‚é‚£ä¹ˆç¼–è¯‘å™¨ä¼šå˜å¾—ä¿å®ˆèµ·æ¥ï¼Œå®ƒä¼šé˜²æ­¢è¿™æ¡fenceå‘½ä»¤ä¸Šæ–¹çš„å†…å­˜è®¿é—®æ“ä½œç§»åˆ°ä¸‹æ–¹ï¼ŒåŒæ—¶é˜²æ­¢ä¸‹æ–¹çš„æ“ä½œç§»åˆ°ä¸Šé¢ï¼Œä¹Ÿå°±æ˜¯é˜²æ­¢äº†ä¹±åºï¼Œæ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚</p><p>ä½†è¿™è¿˜æ²¡å®Œï¼Œè¿™æ¡å‘½ä»¤è¿˜æœ‰å¦å¤–ä¸€ä¸ªå‰¯ä½œç”¨ï¼šå®ƒä¼šè®©ç¼–è¯‘å™¨æŠŠæ‰€æœ‰ç¼“å­˜åœ¨å¯„å­˜å™¨ä¸­çš„å†…å­˜å˜é‡flushåˆ°å†…å­˜ä¸­ï¼Œç„¶åé‡æ–°ä»å†…å­˜ä¸­è¯»å–è¿™äº›å€¼ã€‚è¿™å¹¶ä¸ä¸€å®šæ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œæ¯”å¦‚æœ‰äº›å˜é‡åªåœ¨å½“å‰çº¿ç¨‹ä¸­ä½¿ç”¨ï¼Œç•™åœ¨å¯„å­˜å™¨ä¸­å¾ˆå¥½ï¼Œå¤šäº†ä¸€å¯¹å†™/è¯»å†…å­˜æ“ä½œæ˜¯ä¸å¿…è¦çš„å¼€é”€ã€‚</p><p>åŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨ mfence æ±‡ç¼–å‘½ä»¤å®ç°å†…å­˜çš„å±éšœ</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">asm</span> <span class="token keyword">volatile</span> <span class="token punctuation">(</span><span class="token string">&quot;mfence&quot;</span> <span class="token operator">::</span><span class="token operator">:</span> <span class="token string">&quot;memory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,28),k={class:"custom-container note"},v=n("p",{class:"custom-container-title"},"mfence æ‰‹å†Œ",-1),m={href:"https://www.felixcloutier.com/x86/mfence.html",target:"_blank",rel:"noopener noreferrer"},h={href:"https://stackoverflow.com/questions/12183311/difference-in-mfence-and-asm-volatile-memory",target:"_blank",rel:"noopener noreferrer"},b=n("h3",{id:"å¯è§æ€§",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#å¯è§æ€§","aria-hidden":"true"},"#"),s(" å¯è§æ€§")],-1),f=n("p",null,"ç°ä»£çš„å¤„ç†å™¨æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªåŠ¨æ€çš„å¤„ç†å™¨",-1),g={class:"custom-container note"},_=n("p",{class:"custom-container-title"},"ç°ä»£å¤„ç†å™¨ä¹Ÿæ˜¯åªä¿è¯æœ€ç»ˆä¸€è‡´æ€§",-1),y=n("p",null,"æ»¡è¶³å•å¤„ç†å™¨ eventual memory consistency çš„æ‰§è¡Œï¼Œåœ¨å¤šå¤„ç†å™¨ä¸Šå¯èƒ½æ— æ³•åºåˆ—åŒ–ï¼",-1),w={href:"https://research.swtch.com/hwmm",target:"_blank",rel:"noopener noreferrer"},x=e(`<p>å¦‚ä½•ä¿è¯é¡ºåºæ€§</p><p>å¯ä»¥é€šè¿‡å…³é”®å­—</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">__sync_synchronize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
RTFM 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div>`,3),q={href:"https://gcc.gnu.org/onlinedocs/gcc/_005f_005fsync-Builtins.html",target:"_blank",rel:"noopener noreferrer"},C=e('<h2 id="å¹¶å‘ç¼–ç¨‹æ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#å¹¶å‘ç¼–ç¨‹æ§åˆ¶" aria-hidden="true">#</a> å¹¶å‘ç¼–ç¨‹æ§åˆ¶</h2><h3 id="äº’æ–¥" tabindex="-1"><a class="header-anchor" href="#äº’æ–¥" aria-hidden="true">#</a> äº’æ–¥</h3><div class="custom-container note"><p class="custom-container-title">äº’æ–¥ç®—æ³•çš„å›°éš¾ç‚¹</p><p>å®ç°äº’æ–¥çš„æ ¹æœ¬å›°éš¾ï¼šä¸èƒ½åŒæ—¶è¯»/å†™å…±äº«å†…å­˜</p><ul><li>load (ç¯é¡¾å››å‘¨) çš„æ—¶å€™ä¸èƒ½å†™ï¼Œåªèƒ½ â€œçœ‹ä¸€çœ¼å°±æŠŠçœ¼ç›é—­ä¸Šâ€ <ul><li>çœ‹åˆ°çš„ä¸œè¥¿é©¬ä¸Šå°±è¿‡æ—¶äº†</li></ul></li><li>store (æ”¹å˜ç‰©ç†ä¸–ç•ŒçŠ¶æ€) çš„æ—¶å€™ä¸èƒ½è¯»ï¼Œåªèƒ½ â€œé—­ç€çœ¼ç›åŠ¨æ‰‹â€ <ul><li>ä¹Ÿä¸çŸ¥é“æŠŠä»€ä¹ˆæ”¹æˆäº†ä»€ä¹ˆ</li></ul></li></ul></div><blockquote><p>Petersonç®—æ³•</p></blockquote><p>å¦‚æœè½¯ä»¶æ— æ³•è§£å†³é—®é¢˜ï¼Œç¡¬ä»¶å¯ä»¥ç”¨ä¸€æ¡æŒ‡ä»¤æ¥è§£å†³</p><p>ç¡¬ä»¶èƒ½ä¸ºæˆ‘ä»¬æä¾›ä¸€æ¡ â€œç¬é—´å®Œæˆâ€ çš„è¯» + å†™æŒ‡ä»¤</p><p>åœ¨Intel 80486æŒ‡ä»¤é›†ä¸­ å¢åŠ äº†LockæŒ‡ä»¤</p><p>Lockçš„ä½œç”¨ä¸ºï¼Œåœ¨CPUæ‰§è¡Œåˆ°å¸¦æœ‰LockæŒ‡ä»¤çš„æ—¶å€™ï¼Œä¼šå°†å†…å­˜å…ˆä¸Šé”ï¼ˆæ­¤æ—¶å…¶ä»–CPUæ— æ³•è¯»å†™å†…å­˜ï¼‰éšååœ¨æ‰§è¡Œæ“ä½œã€‚</p><figure><img src="'+i+`" alt="80486 CPUå†…å­˜æ¨¡å‹" tabindex="0" loading="lazy"><figcaption>80486 CPUå†…å­˜æ¨¡å‹</figcaption></figure><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">xchg</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">int</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token keyword">int</span> newval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> result<span class="token punctuation">;</span>
  <span class="token keyword">asm</span> <span class="token keyword">volatile</span> <span class="token punctuation">(</span><span class="token string">&quot;lock xchg %0, %1&quot;</span>
    <span class="token operator">:</span> <span class="token string">&quot;+m&quot;</span><span class="token punctuation">(</span><span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;=a&quot;</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">(</span>newval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œæ˜¯åœ¨ç¡¬ä»¶å±‚é¢ä¸Šäº†ä¸€æŠŠæ€»çº¿é”ï¼Œç”±æ€»çº¿å†³å®šè°æ›´å…ˆè¿è¡Œã€‚</p><p>ç„¶è€Œä»Šå¤©çš„CPUæ‹¥æœ‰å¤šä¸ªç¼“å­˜(L1ã€L2ã€L3)</p><figure><img src="`+u+`" alt="CPU Cacheæ¨¡å‹" tabindex="0" loading="lazy"><figcaption>CPU Cacheæ¨¡å‹</figcaption></figure><p>è¿™æ„å‘³ç€ï¼Œå¦‚æœéœ€è¦ç»™Memoryä¸­çš„æŸä¸ªå€¼ä¸Šé”ï¼Œåˆ™éœ€è¦å°†å…¶ä»–CPUçš„Cacheä¸­çš„è¿™ä¸ªå€¼ç»™åˆ æ‰ï¼Œè¿™å¢åŠ äº†å¾ˆå¤šæ€§èƒ½æŸè€—ã€‚</p><p><strong>æ€è€ƒä¸€ä¸‹ï¼šæˆ‘ä»¬å¯¹åŸå­æ“ä½œçš„ä¸»è¦éœ€æ±‚</strong></p><p>è€ƒè™‘å¸¸è§çš„åŸå­æ“ä½œï¼š</p><ul><li>atomic test-and-set <ul><li><code>reg = load(x); if (reg == XX) { store(x, YY); }</code></li></ul></li><li>lock xchg <ul><li><code>reg = load(x); store(x, XX);</code></li></ul></li><li>lock add <ul><li><code>t = load(x); t++; store(x, t);</code></li></ul></li></ul><p>å®ƒä»¬çš„æœ¬è´¨éƒ½æ˜¯ï¼š</p><ol><li>load</li><li>exec (å¤„ç†å™¨æœ¬åœ°å¯„å­˜å™¨çš„è¿ç®—)</li><li>store</li></ol><p>é€šè¿‡ç¡¬ä»¶æ¥è§£å†³è¿™ä¸ªé—®é¢˜</p><h4 id="load-reserved-store-conditional-lr-sc" tabindex="-1"><a class="header-anchor" href="#load-reserved-store-conditional-lr-sc" aria-hidden="true">#</a> Load-Reserved/Store-Conditional (LR/SC)</h4><p>LR: åœ¨å†…å­˜ä¸Šæ ‡è®° reserved (ç›¯ä¸Šä½ äº†)ï¼Œä¸­æ–­ã€å…¶ä»–å¤„ç†å™¨å†™å…¥éƒ½ä¼šå¯¼è‡´æ ‡è®°æ¶ˆé™¤</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>lr.w rd, (rs1)
  rd = M[rs1]
  reserve M[rs1]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p>SC: å¦‚æœ â€œç›¯ä¸Šâ€ æœªè¢«è§£é™¤ï¼Œåˆ™å†™å…¥</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>sc.w rd, rs2, (rs1)
  if still reserved:
    M[rs1] = rs2
    rd = 0
  else:
    rd = nonzero
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ç¡¬ä»¶ä¸Šå®ç°CASæŒ‡ä»¤</p><h4 id="compare-and-swap-çš„-lr-sc-å®ç°" tabindex="-1"><a class="header-anchor" href="#compare-and-swap-çš„-lr-sc-å®ç°" aria-hidden="true">#</a> Compare-and-Swap çš„ LR/SC å®ç°</h4><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>int cas(int *addr, int cmp_val, int new_val) {
  int old_val = *addr;
  if (old_val == cmp_val) {
    *addr = new_val; return 0;
  } else { return 1; }
}
cas:
  lr.w  t0, (a0)       # Load original value.
  bne   t0, a1, fail   # Doesnâ€™t match, so fail.
  sc.w  t0, a2, (a0)   # Try to update.
  bnez  t0, cas        # Retry if store-conditional failed.
  li a0, 0             # Set return to success.
  jr ra                # Return.
fail:
  li a0, 1             # Set return to failure.
  jr ra                # Return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™å°±æ˜¯ä¸€ä¸ªè‡ªæ—‹é”ã€‚</p>`,30),S={class:"custom-container note"},A=n("p",{class:"custom-container-title"},"LR/SCçš„ç¡¬ä»¶å®ç°",-1),P={href:"https://github.com/riscv-boom/riscv-boom",target:"_blank",rel:"noopener noreferrer"},T={href:"https://github.com/riscv-boom/riscv-boom/blob/master/src/main/scala/lsu/dcache.scala#L655",target:"_blank",rel:"noopener noreferrer"},L=e(`<div class="custom-container tip"><p class="custom-container-title">è‡ªæ—‹é”ç¼ºé™·</p><p>è‡ªæ—‹é”ä¹Ÿä¼šé¢ä¸´ä¸€å®šçš„ç¼ºé™·</p><ul><li><p>è‡ªæ—‹ (å…±äº«å˜é‡) ä¼šè§¦å‘å¤„ç†å™¨é—´çš„ç¼“å­˜åŒæ­¥ï¼Œå»¶è¿Ÿå¢åŠ </p></li><li><p>é™¤äº†è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹ï¼Œå…¶ä»–å¤„ç†å™¨ä¸Šçš„çº¿ç¨‹éƒ½åœ¨ç©ºè½¬</p></li><li><p>äº‰æŠ¢é”çš„å¤„ç†å™¨è¶Šå¤šï¼Œåˆ©ç”¨ç‡è¶Šä½</p></li><li><p>è·å¾—è‡ªæ—‹é”çš„çº¿ç¨‹ å¯èƒ½è¢«æ“ä½œç³»ç»Ÿåˆ‡æ¢å‡ºå»</p><ul><li>æ“ä½œç³»ç»Ÿä¸ â€œæ„ŸçŸ¥â€ çº¿ç¨‹åœ¨åšä»€ä¹ˆ (ä½†ä¸ºä»€ä¹ˆä¸èƒ½å‘¢ï¼Ÿ)</li></ul></li><li><p>å®ç° 100% çš„èµ„æºæµªè´¹</p></li></ul></div><p>è‡ªæ—‹é”æµªè´¹çš„ä¾‹å­</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;thread.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;thread-sync.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N</span> <span class="token expression"><span class="token number">10000000</span></span></span>
<span class="token class-name">spinlock_t</span> lock <span class="token operator">=</span> <span class="token function">SPIN_INIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">long</span> n<span class="token punctuation">,</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Tsum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sum<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> nthread <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  n <span class="token operator">=</span> N <span class="token operator">/</span> nthread<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nthread<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">create</span><span class="token punctuation">(</span>Tsum<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>sum <span class="token operator">==</span> n <span class="token operator">*</span> nthread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰§è¡Œä¸Šé¢çš„ä»£ç ï¼Œå‘ç°ä¸€ä¸ªçº¿ç¨‹æ—¶åªéœ€100ms è€Œå¦‚æœå¢åŠ å¤šä¸ªçº¿ç¨‹è¿è¡Œæ—¶ï¼Œæ—¶é—´ä¸å‡åå¢ï¼Œè¿™å°±æ˜¯å› ä¸ºè‡ªæ—‹é”é¢ä¸´çš„é—®é¢˜ã€‚</p><div class="custom-container note"><p class="custom-container-title">è‡ªæ—‹é”ä½¿ç”¨åœºæ™¯</p><p><strong>ä¸´ç•ŒåŒºå‡ ä¹ä¸æ‹¥å µ</strong></p><p><strong>æŒæœ‰è‡ªæ—‹é”æ—¶ç¦æ­¢æ‰§è¡Œæµåˆ‡æ¢</strong>ï¼ˆæŒæœ‰é” ä½†è¢«åˆ‡æ¢å‡ºå» å¯¼è‡´å…¶ä»–ä¸€ç›´åœ¨ç­‰ï¼Œä½†æ“ä½œç³»ç»Ÿä¸ä¼šå…è®¸ç¨‹åºå®ç°è¿™ä¸€ç‚¹ï¼‰</p><p>æ•…ä½¿ç”¨åœºæ™¯ä¸»è¦åœ¨</p><ul><li>æ“ä½œç³»ç»Ÿå¯ä»¥å…³é—­ä¸­æ–­å’ŒæŠ¢å  <ul><li>ä¿è¯é”çš„æŒæœ‰è€…åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å¯ä»¥é‡Šæ”¾é”</li></ul></li><li>(å¦‚æœæ˜¯è™šæ‹Ÿæœºå‘¢...ğŸ˜‚) <ul><li>PAUSE æŒ‡ä»¤ä¼šè§¦å‘ VM Exit</li></ul></li><li>ä½†ä¾æ—§å¾ˆéš¾åšå¥½</li></ul></div><p>é‚£ä¹ˆè¯¥å¦‚ä½•å®ç°é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥å‘¢</p><p>â€œè®©â€ ä¸æ˜¯ C è¯­è¨€ä»£ç å¯ä»¥åšåˆ°çš„ (C ä»£ç åªèƒ½è®¡ç®—)</p><ul><li><p>æŠŠé”çš„å®ç°æ”¾åˆ°æ“ä½œç³»ç»Ÿé‡Œå°±å¥½å•¦ï¼</p><ul><li><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>syscall(SYSCALL_lock, &amp;lk);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>è¯•å›¾è·å¾— <code>lk</code>ï¼Œä½†å¦‚æœå¤±è´¥ï¼Œå°±åˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹</li></ul></li><li><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>syscall(SYSCALL_unlock, &amp;lk);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>é‡Šæ”¾ <code>lk</code>ï¼Œå¦‚æœæœ‰ç­‰å¾…é”çš„çº¿ç¨‹å°±å”¤é†’</li></ul></li></ul></li></ul><p>æ“ä½œç³»ç»Ÿ = æ›´è¡£å®¤ç®¡ç†å‘˜</p><ul><li>å…ˆåˆ°çš„äºº (çº¿ç¨‹) <ul><li>æˆåŠŸè·å¾—æ‰‹ç¯ï¼Œè¿›å…¥æ¸¸æ³³é¦†</li><li><code>*lk = ğŸ”’</code>ï¼Œç³»ç»Ÿè°ƒç”¨ç›´æ¥è¿”å›</li></ul></li><li>ååˆ°çš„äºº (çº¿ç¨‹) <ul><li>ä¸èƒ½è¿›å…¥æ¸¸æ³³é¦†ï¼Œæ’é˜Ÿç­‰å¾…</li><li>çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæ‰§è¡Œçº¿ç¨‹åˆ‡æ¢ (yield)</li></ul></li><li>æ´—å®Œæ¾¡å‡ºæ¥çš„äºº (çº¿ç¨‹) <ul><li>äº¤è¿˜æ‰‹ç¯ç»™ç®¡ç†å‘˜ï¼›ç®¡ç†å‘˜æŠŠæ‰‹ç¯å†äº¤ç»™æ’é˜Ÿçš„äºº</li><li>å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œä»ç­‰å¾…é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªçº¿ç¨‹å…è®¸æ‰§è¡Œ</li><li>å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œ<code>*lk = âœ…</code></li></ul></li><li>ç®¡ç†å‘˜ (OS) ä½¿ç”¨è‡ªæ—‹é”ç¡®ä¿è‡ªå·±å¤„ç†æ‰‹ç¯çš„è¿‡ç¨‹æ˜¯åŸå­çš„</li></ul><p><strong>è‡ªæ—‹é”å’Œç¡çœ é”å„æœ‰è‡ªå·±çš„ä¼˜ç‚¹å’Œç¼ºç‚¹</strong></p><p>è‡ªæ—‹é” (çº¿ç¨‹ç›´æ¥å…±äº« locked)</p><ul><li>æ›´å¿«çš„ fast path <ul><li>xchg æˆåŠŸ â†’ ç«‹å³è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¼€é”€å¾ˆå°</li></ul></li><li>æ›´æ…¢çš„ slow path <ul><li>xchg å¤±è´¥ â†’ æµªè´¹ CPU è‡ªæ—‹ç­‰å¾…</li></ul></li></ul><p>ç¡çœ é” (é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—® locked)</p><ul><li>æ›´å¿«çš„ slow path <ul><li>ä¸Šé”å¤±è´¥çº¿ç¨‹ä¸å†å ç”¨ CPU</li></ul></li><li>æ›´æ…¢çš„ fast path <ul><li>å³ä¾¿ä¸Šé”æˆåŠŸä¹Ÿéœ€è¦è¿›å‡ºå†…æ ¸ (syscall)</li></ul></li></ul><p>é‚£ä¹ˆæ˜¯å¦æœ‰ä¸¤ç§éƒ½è¦çš„é”å‘¢</p><ul><li>Fast path: ä¸€æ¡åŸå­æŒ‡ä»¤ï¼Œä¸Šé”æˆåŠŸç«‹å³è¿”å›</li><li>Slow path: ä¸Šé”å¤±è´¥ï¼Œæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ç¡çœ  <ul><li>æ€§èƒ½ä¼˜åŒ–çš„æœ€å¸¸è§æŠ€å·§ <ul><li>çœ‹ average (frequent) case è€Œä¸æ˜¯ worst case</li></ul></li></ul></li></ul><hr><p>POSIX çº¿ç¨‹åº“ä¸­çš„äº’æ–¥é” (<code>pthread_mutex</code>)</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;thread.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;thread-sync.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N</span> <span class="token expression"><span class="token number">10000000</span></span></span>
<span class="token class-name">mutexlock_t</span> lock <span class="token operator">=</span> <span class="token function">MUTEX_INIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">long</span> n<span class="token punctuation">,</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Tsum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sum<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> nthread <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  n <span class="token operator">=</span> N <span class="token operator">/</span> nthread<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nthread<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">create</span><span class="token punctuation">(</span>Tsum<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>sum <span class="token operator">==</span> n <span class="token operator">*</span> nthread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="futexçš„å®ç°" tabindex="-1"><a class="header-anchor" href="#futexçš„å®ç°" aria-hidden="true">#</a> Futexçš„å®ç°</h4><p>å¯ä»¥å‘ç°æ˜æ˜¾æ”¹å–„äº†å¤šçº¿ç¨‹çš„æ—¶å€™è‡ªæ—‹é”çš„ç¼ºç‚¹ã€‚</p><p>é‚£ä¹ˆFutexå¦‚ä½•å®ç°çš„å‘¢</p><p>å…ˆåœ¨ç”¨æˆ·ç©ºé—´è‡ªæ—‹</p>`,24),I=n("li",null,"å¦‚æœè·å¾—é”ï¼Œç›´æ¥è¿›å…¥",-1),O=n("li",null,"æœªèƒ½è·å¾—é”ï¼Œç³»ç»Ÿè°ƒç”¨",-1),z={href:"http://jyywiki.cn/pages/OS/2022/demos/futex.py",target:"_blank",rel:"noopener noreferrer"},E=n("li",null,"æ›´å¥½çš„è®¾è®¡å¯ä»¥åœ¨ fast-path ä¸è¿›è¡Œç³»ç»Ÿè°ƒç”¨",-1),U={class:"custom-container note"},N=n("p",{class:"custom-container-title"},"Futex",-1),j={href:"https://lwn.net/Articles/360699/",target:"_blank",rel:"noopener noreferrer"},B={href:"http://jyywiki.cn/pages/OS/manuals/futexes-are-tricky.pdf",target:"_blank",rel:"noopener noreferrer"},M=e(`<h3 id="åŒæ­¥" tabindex="-1"><a class="header-anchor" href="#åŒæ­¥" aria-hidden="true">#</a> åŒæ­¥</h3><div class="custom-container tip"><p class="custom-container-title">åŒæ­¥æ¦‚å¿µ</p><h4 id="åŒæ­¥-synchronization" tabindex="-1"><a class="header-anchor" href="#åŒæ­¥-synchronization" aria-hidden="true">#</a> åŒæ­¥ (Synchronization)</h4><p>ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šéšæ—¶é—´å˜åŒ–çš„é‡åœ¨å˜åŒ–è¿‡ç¨‹ä¸­ä¿æŒä¸€å®šçš„ç›¸å¯¹å…³ç³»</p><ul><li>iPhone/iCloud åŒæ­¥ (æ‰‹æœº vs ç”µè„‘ vs äº‘ç«¯)</li><li>å˜é€Ÿç®±åŒæ­¥å™¨ (åˆå¹¶å¿«æ…¢é€Ÿé½¿è½®)</li><li>åŒæ­¥ç”µæœº (è½¬å­ä¸ç£åœºé€Ÿåº¦ä¸€è‡´)</li><li>åŒæ­¥ç”µè·¯ (æ‰€æœ‰è§¦å‘å™¨åœ¨è¾¹æ²¿åŒæ—¶è§¦å‘)</li></ul><hr><p>å¼‚æ­¥ (Asynchronous) = ä¸åŒæ­¥</p><ul><li>ä¸Šè¿°å¾ˆå¤šä¾‹å­éƒ½æœ‰å¼‚æ­¥ç‰ˆæœ¬ (å¼‚æ­¥ç”µæœºã€å¼‚æ­¥ç”µè·¯ã€å¼‚æ­¥çº¿ç¨‹)</li></ul></div><h4 id="ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜-å­¦åºŸä½ å°±èµ¢äº†" tabindex="-1"><a class="header-anchor" href="#ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜-å­¦åºŸä½ å°±èµ¢äº†" aria-hidden="true">#</a> ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼šå­¦åºŸä½ å°±èµ¢äº†</h4><blockquote><p>99% çš„å®é™…å¹¶å‘é—®é¢˜éƒ½å¯ä»¥ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£å†³ã€‚</p></blockquote><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>void Tproduce() { while (1) printf(&quot;(&quot;); }
void Tconsume() { while (1) printf(&quot;)&quot;); }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ <code>printf</code> å‰åå¢åŠ ä»£ç ï¼Œä½¿å¾—æ‰“å°çš„æ‹¬å·åºåˆ—æ»¡è¶³</p><ul><li><p>ä¸€å®šæ˜¯æŸä¸ªåˆæ³•æ‹¬å·åºåˆ—çš„å‰ç¼€</p></li><li><p>æ‹¬å·åµŒå¥—çš„æ·±åº¦ä¸è¶…è¿‡</p><p>n<em>n</em></p><ul><li>n=3<em>n</em>=3, <code>((())())(((</code> åˆæ³•</li><li>n=3<em>n</em>=3, <code>(((())))</code>, <code>(()))</code> ä¸åˆæ³•</li></ul></li><li><p>åŒæ­¥</p><ul><li>ç­‰åˆ°æœ‰ç©ºä½å†æ‰“å°å·¦æ‹¬å·</li><li>ç­‰åˆ°èƒ½é…å¯¹æ—¶å†æ‰“å°å³æ‹¬å·</li></ul></li></ul><p>ä¸ºä»€ä¹ˆå« â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€ è€Œä¸æ˜¯ â€œæ‹¬å·é—®é¢˜â€ï¼Ÿ</p><ul><li>å·¦æ‹¬å·ï¼šç”Ÿäº§èµ„æº (ä»»åŠ¡)ã€æ”¾å…¥é˜Ÿåˆ—</li><li>å³æ‹¬å·ï¼šä»é˜Ÿåˆ—å–å‡ºèµ„æº (ä»»åŠ¡) æ‰§è¡Œ</li></ul><hr><p>èƒ½å¦ç”¨äº’æ–¥é”å®ç°æ‹¬å·é—®é¢˜ï¼Ÿ</p>`,11),D=n("li",null,[s("å·¦æ‹¬å·ï¼šåµŒå¥—æ·±åº¦ (é˜Ÿåˆ—) ä¸è¶³ n"),n("em",null,"n"),s(" æ—¶æ‰èƒ½æ‰“å°")],-1),R=n("li",null,[s("å½“ç„¶æ˜¯ç­‰åˆ°æ»¡è¶³æ¡ä»¶æ—¶å†æ‰“å°äº† "),n("ul",null,[n("li",null,"ç”¨äº’æ–¥é”ä¿æŒæ¡ä»¶æˆç«‹")])],-1),V={href:"http://jyywiki.cn/pages/OS/2022/demos/pc-check.py",target:"_blank",rel:"noopener noreferrer"},G=n("li",null,"Model checker å½“ç„¶ä¹Ÿä¸èƒ½å°‘ (ç•™ä½œä¹ é¢˜)ss",-1),F=e(`<div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;thread.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;thread-sync.h&quot;</span></span>

<span class="token keyword">int</span> n<span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name">mutex_t</span> lk <span class="token operator">=</span> <span class="token function">MUTEX_INIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Tproduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
retry<span class="token operator">:</span>
    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> retry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Tconsume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
retry<span class="token operator">:</span>
    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> retry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    count<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  n <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">create</span><span class="token punctuation">(</span>Tproduce<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">create</span><span class="token punctuation">(</span>Tconsume<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½†æ˜¯è¿™æ ·è¿˜æ˜¯ä¼šæœ‰è‡ªæ—‹çš„æ“ä½œ</p><p>å¦‚ä½•é¿å…å‘¢</p><h4 id="conditional-variables-æ¡ä»¶å˜é‡-cv" tabindex="-1"><a class="header-anchor" href="#conditional-variables-æ¡ä»¶å˜é‡-cv" aria-hidden="true">#</a> Conditional Variables (æ¡ä»¶å˜é‡, CV)</h4><p>æŠŠä¸Šè¿°ä»£ç ä¸­çš„è‡ªæ—‹å˜æˆç¡çœ </p><ul><li>åœ¨å®Œæˆæ“ä½œæ—¶å”¤é†’</li></ul><hr><p>æ¡ä»¶å˜é‡ API</p><ul><li>wait(cv, mutex) ğŸ’¤ <ul><li>è°ƒç”¨æ—¶å¿…é¡»ä¿è¯å·²ç»è·å¾— mutex</li><li>é‡Šæ”¾ mutexã€è¿›å…¥ç¡çœ çŠ¶æ€</li></ul></li><li>signal/notify(cv) ğŸ’¬ ç§ä¿¡ï¼šèµ°èµ· <ul><li>å¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾… cvï¼Œåˆ™å”¤é†’å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹</li></ul></li><li>broadcast/notifyAll(cv) ğŸ“£ æ‰€æœ‰äººï¼šèµ°èµ· <ul><li>å”¤é†’å…¨éƒ¨æ­£åœ¨ç­‰å¾… cv çš„çº¿ç¨‹</li></ul></li></ul><p>é€šè¿‡æ¡ä»¶å˜é‡çš„ä»£ç </p><p>æˆ‘ä»¬å¯ä»¥å®ç°åˆšåˆšçš„é—®é¢˜</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">Tproduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> n<span class="token punctuation">)</span> <span class="token function">cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> count<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token function">cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Tconsume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> count<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token function">cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½†æ˜¯è¿™æ ·çš„ä»£ç åœ¨é¢ä¸´ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸å¯¹ç­‰çš„æ—¶å€™æ˜¯ä¸æˆç«‹çš„ã€‚</p><p>æ‰€ä»¥éœ€è¦ä¸¤ä¸ªæ¡ä»¶å˜é‡æ¥æ§åˆ¶åŒç±»ä¸å”¤é†’ã€‚</p><p><strong>æ¡ä»¶å˜é‡ï¼šæ­£ç¡®çš„æ‰“å¼€æ–¹å¼</strong></p><p>éœ€è¦ç­‰å¾…æ¡ä»¶æ»¡è¶³æ—¶</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>mutex_lock(&amp;mutex);
while (!cond) {
  wait(&amp;cv, &amp;mutex);
}
assert(cond);
// ...
// äº’æ–¥é”ä¿è¯äº†åœ¨æ­¤æœŸé—´æ¡ä»¶ cond æ€»æ˜¯æˆç«‹
// ...
mutex_unlock(&amp;mutex);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä»–çº¿ç¨‹æ¡ä»¶å¯èƒ½è¢«æ»¡è¶³æ—¶</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>broadcast(&amp;cv);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>éšåæ¥æŒ‘æˆ˜ä¸€ä¸ªæ›´ä¸ºå¤æ‚çš„é¢˜ç›®ï¼</p><p>::: warn æ‰“å°ä¸€æ¡é±¼</p><p>æœ‰ä¸‰ç§çº¿ç¨‹ï¼Œåˆ†åˆ«æ‰“å° <code>&lt;</code>, <code>&gt;</code>, å’Œ <code>_</code></p><ul><li>å¯¹è¿™äº›çº¿ç¨‹è¿›è¡ŒåŒæ­¥ï¼Œä½¿å¾—æ‰“å°å‡ºçš„åºåˆ—æ€»æ˜¯ <code>&lt;&gt;&lt;_</code> å’Œ <code>&gt;&lt;&gt;_</code> ç»„åˆ</li></ul><hr><p>ä½¿ç”¨æ¡ä»¶å˜é‡ï¼Œåªè¦å›ç­”ä¸‰ä¸ªé—®é¢˜ï¼š</p><ul><li>æ‰“å° â€œ<code>&lt;</code>â€ çš„æ¡ä»¶ï¼Ÿ</li><li>æ‰“å° â€œ<code>&gt;</code>â€ çš„æ¡ä»¶ï¼Ÿ</li><li>æ‰“å° â€œ<code>_</code>â€ çš„æ¡ä»¶ï¼Ÿ</li></ul><p>:::</p><p>ç”»çŠ¶æ€æœº åŒæ—¶è§£å†³å³å¯</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;thread.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LENGTH</span><span class="token expression"><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">enum</span> <span class="token punctuation">{</span> A <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">,</span> D<span class="token punctuation">,</span> E<span class="token punctuation">,</span> F<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">rule</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> from<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> to<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">rule</span> rules<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">{</span> A<span class="token punctuation">,</span> <span class="token char">&#39;&lt;&#39;</span><span class="token punctuation">,</span> B <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> B<span class="token punctuation">,</span> <span class="token char">&#39;&gt;&#39;</span><span class="token punctuation">,</span> C <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> C<span class="token punctuation">,</span> <span class="token char">&#39;&lt;&#39;</span><span class="token punctuation">,</span> D <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> A<span class="token punctuation">,</span> <span class="token char">&#39;&gt;&#39;</span><span class="token punctuation">,</span> E <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> E<span class="token punctuation">,</span> <span class="token char">&#39;&lt;&#39;</span><span class="token punctuation">,</span> F <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> F<span class="token punctuation">,</span> <span class="token char">&#39;&gt;&#39;</span><span class="token punctuation">,</span> D <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> D<span class="token punctuation">,</span> <span class="token char">&#39;_&#39;</span><span class="token punctuation">,</span> A <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> current <span class="token operator">=</span> A<span class="token punctuation">,</span> quota <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token class-name">pthread_mutex_t</span> lk   <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>
<span class="token class-name">pthread_cond_t</span>  cond <span class="token operator">=</span> PTHREAD_COND_INITIALIZER<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">char</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">LENGTH</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">rule</span> <span class="token operator">*</span>rule <span class="token operator">=</span> <span class="token operator">&amp;</span>rules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rule<span class="token operator">-&gt;</span>from <span class="token operator">==</span> current <span class="token operator">&amp;&amp;</span> rule<span class="token operator">-&gt;</span>ch <span class="token operator">==</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> rule<span class="token operator">-&gt;</span>to<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">fish_before</span><span class="token punctuation">(</span><span class="token keyword">char</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">next</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> quota<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// can proceed only if (next(ch) &amp;&amp; quota)</span>
    <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  quota<span class="token operator">--</span><span class="token punctuation">;</span>
  <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">fish_after</span><span class="token punctuation">(</span><span class="token keyword">char</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  quota<span class="token operator">++</span><span class="token punctuation">;</span>
  current <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token keyword">char</span> roles<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;.&lt;&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;___&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">fish_thread</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> role <span class="token operator">=</span> roles<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fish_before</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">putchar</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// can be long; no lock protection</span>
    <span class="token function">fish_after</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token function">create</span><span class="token punctuation">(</span>fish_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä¿¡å·é‡-å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…" tabindex="-1"><a class="header-anchor" href="#ä¿¡å·é‡-å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…" aria-hidden="true">#</a> ä¿¡å·é‡ï¼šå®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…</h4><p>åšä¸€ç‚¹æ‰©å±•â€”â€”çº¿ç¨‹å¯ä»¥ä»»æ„ â€œå˜å‡ºâ€ ä¸€ä¸ªæ‰‹ç¯</p><ul><li>æŠŠæ‰‹ç¯çœ‹æˆæ˜¯ä»¤ç‰Œ</li><li>å¾—åˆ°ä»¤ç‰Œçš„å¯ä»¥è¿›å…¥æ‰§è¡Œ</li><li>å¯ä»¥éšæ—¶åˆ›å»ºä»¤ç‰Œ</li></ul><hr><p>â€œæ‰‹ç¯â€ = â€œä»¤ç‰Œâ€ = â€œä¸€ä¸ªèµ„æºâ€ = â€œä¿¡å·é‡â€ (semaphore)</p><ul><li>P(&amp;sem) - prolaag = try + decrease; wait; down; in <ul><li>ç­‰å¾…ä¸€ä¸ªæ‰‹ç¯åè¿”å›</li><li>å¦‚æœæ­¤æ—¶ç®¡ç†å‘˜æ‰‹ä¸Šæœ‰ç©ºé—²çš„æ‰‹ç¯ï¼Œç«‹å³è¿”å›</li></ul></li><li>V(&amp;sem) - verhoog = increase; post; up; out <ul><li>å˜å‡ºä¸€ä¸ªæ‰‹ç¯ï¼Œé€ç»™ç®¡ç†å‘˜</li></ul></li></ul><p>ä¿¡å·é‡è®¾è®¡çš„é‡ç‚¹</p>`,36),X={href:"http://jyywiki.cn/pages/OS/2022/demos/pc-sem.c",target:"_blank",rel:"noopener noreferrer"},Y=n("code",null,"pc-sem.c",-1),H=e(`<div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>void producer() {
  P(&amp;empty);   // P()è¿”å› -&gt; å¾—åˆ°æ‰‹ç¯
  printf(&quot;(&quot;); // å‡è®¾çº¿ç¨‹å®‰å…¨
  V(&amp;fill);
}
void consumer() {
  P(&amp;fill);
  printf(&quot;)&quot;);
  V(&amp;empty);
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åœ¨ â€œä¸€å•ä½èµ„æºâ€ æ˜ç¡®çš„é—®é¢˜ä¸Šæ›´å¥½ç”¨</li></ul><h4 id="å“²å­¦å®¶åƒé¥­é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#å“²å­¦å®¶åƒé¥­é—®é¢˜" aria-hidden="true">#</a> å“²å­¦å®¶åƒé¥­é—®é¢˜</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>avail<span class="token punctuation">[</span>lhs<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> avail<span class="token punctuation">[</span>rhs<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
avail<span class="token punctuation">[</span>lhs<span class="token punctuation">]</span> <span class="token operator">=</span> avail<span class="token punctuation">[</span>rhs<span class="token punctuation">]</span> <span class="token operator">=</span> false<span class="token punctuation">;</span>
<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
avail<span class="token punctuation">[</span>lhs<span class="token punctuation">]</span> <span class="token operator">=</span> avail<span class="token punctuation">[</span>rhs<span class="token punctuation">]</span> <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ†å¸ƒå¼çš„è§£å†³æ–¹æ¡ˆ</p><p>å¦ä¸€æ–¹é¢æ˜¯é›†ä¸­å¼</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">Tphilosopher</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">send_request</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> EAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">P</span><span class="token punctuation">(</span>allowed<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// waiter ä¼šæŠŠå‰å­é€’ç»™å“²å­¦å®¶</span>
  <span class="token function">philosopher_eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">send_request</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> DONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Twaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>id<span class="token punctuation">,</span> status<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">receive_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> EAT<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> DONE<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ©ç”¨ä¸€ä¸ªwaiteræ¥é›†ä¸­ç»™å“²å­¦å®¶åˆ†é…å‰å­</p><p>ä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œç®¡å‰å­çš„äººæ˜¯æ€§èƒ½ç“¶é¢ˆ</p><ul><li>ä¸€å¤§æ¡Œäººåƒé¥­ï¼Œæ¯ä¸ªäººéƒ½å«æœåŠ¡å‘˜çš„æ„Ÿè§‰</li><li>Premature optimization is the root of all evil (D. E. Knuth)</li></ul><hr><p>æŠ›å¼€ workload è°ˆä¼˜åŒ–å°±æ˜¯è€æµæ°“</p>`,12),W=n("li",null,"åƒé¥­çš„æ—¶é—´é€šå¸¸è¿œè¿œå¤§äºè¯·æ±‚æœåŠ¡å‘˜çš„æ—¶é—´",-1),Z={href:"https://www.usenix.org/conference/nsdi20/presentation/brooker",target:"_blank",rel:"noopener noreferrer"},K=n("h3",{id:"ç°å®ç”Ÿæ´»ä¸­çš„å¹¶å‘ç¨‹åº",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#ç°å®ç”Ÿæ´»ä¸­çš„å¹¶å‘ç¨‹åº","aria-hidden":"true"},"#"),s(),n("strong",null,"ç°å®ç”Ÿæ´»ä¸­çš„å¹¶å‘ç¨‹åº")],-1),J={class:"custom-container tip"},$=n("p",{class:"custom-container-title"},"å¹¶å‘ç¨‹åºé‡åˆ°çš„ä¸»è¦æŒ‘æˆ˜",-1),Q=n("p",null,[n("strong",null,"è®¡ç®—ä»»åŠ¡å¦‚ä½•åˆ†è§£")],-1),nn=n("li",null,[s("è®¡ç®—å›¾éœ€è¦å®¹æ˜“å¹¶è¡ŒåŒ– "),n("ul",null,[n("li",null,"æœºå™¨-çº¿ç¨‹ä¸¤çº§ä»»åŠ¡åˆ†è§£")])],-1),sn={href:"https://hpc-tutorials.llnl.gov/mpi/",target:"_blank",rel:"noopener noreferrer"},an={href:"https://www.openmp.org/",target:"_blank",rel:"noopener noreferrer"},tn={href:"https://web.mit.edu/dimitrib/www/pdc.html",target:"_blank",rel:"noopener noreferrer"},en=n("hr",null,null,-1),pn=n("p",null,[n("strong",null,"çº¿ç¨‹é—´å¦‚ä½•é€šä¿¡")],-1),on=n("ul",null,[n("li",null,"é€šä¿¡ä¸ä»…å‘ç”Ÿåœ¨èŠ‚ç‚¹/çº¿ç¨‹ä¹‹é—´ï¼Œè¿˜å‘ç”Ÿåœ¨ä»»ä½•å…±äº«å†…å­˜è®¿é—®")],-1),ln=e('<h4 id="æ•°æ®ä¸­å¿ƒ-åç¨‹å’Œçº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#æ•°æ®ä¸­å¿ƒ-åç¨‹å’Œçº¿ç¨‹" aria-hidden="true">#</a> æ•°æ®ä¸­å¿ƒï¼šåç¨‹å’Œçº¿ç¨‹</h4><p>æ•°æ®ä¸­å¿ƒ</p><ul><li>åŒä¸€æ—¶é—´æœ‰æ•°åƒ/æ•°ä¸‡ä¸ªè¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨</li><li>è®¡ç®—éƒ¨åˆ† <ul><li>éœ€è¦åˆ©ç”¨å¥½å¤šå¤„ç†å™¨ <ul><li>çº¿ç¨‹ â†’ è¿™å°±æ˜¯æˆ‘æ“…é•¿çš„ (Mandelbrot Set)</li><li>åç¨‹ â†’ ä¸€äººå‡ºåŠ›ï¼Œä»–äººæ‘¸é±¼</li></ul></li></ul></li><li>I/O éƒ¨åˆ† <ul><li>ä¼šåœ¨ç³»ç»Ÿè°ƒç”¨ä¸Š block (ä¾‹å¦‚è¯·æ±‚å¦ä¸€ä¸ªæœåŠ¡æˆ–è¯»ç£ç›˜) <ul><li>åç¨‹ â†’ ä¸€äººå¹²ç­‰ï¼Œä»–äººå›´è§‚</li><li>çº¿ç¨‹ â†’ æ¯ä¸ªçº¿ç¨‹éƒ½å ç”¨å¯è§‚çš„æ“ä½œç³»ç»Ÿèµ„æº</li></ul></li></ul></li><li>(è¿™ä¸ªé—®é¢˜æ¯”ä½ æƒ³è±¡çš„å¤æ‚ï¼Œä¾‹å¦‚è™šæ‹Ÿæœº)</li></ul><h4 id="go-å’Œ-goroutine" tabindex="-1"><a class="header-anchor" href="#go-å’Œ-goroutine" aria-hidden="true">#</a> Go å’Œ Goroutine</h4><blockquote><p>Go: å°å­©å­æ‰åšé€‰æ‹©ï¼Œå¤šå¤„ç†å™¨å¹¶è¡Œå’Œè½»é‡çº§å¹¶å‘æˆ‘å…¨éƒ½è¦ï¼</p></blockquote><p>Goroutine: æ¦‚å¿µä¸Šæ˜¯çº¿ç¨‹ï¼Œå®é™…æ˜¯çº¿ç¨‹å’Œåç¨‹çš„æ··åˆä½“</p><ul><li>æ¯ä¸ª CPU ä¸Šæœ‰ä¸€ä¸ª Go Workerï¼Œè‡ªç”±è°ƒåº¦ goroutines</li><li>æ‰§è¡Œåˆ° blocking API æ—¶ (ä¾‹å¦‚ sleep, read) <ul><li>Go Worker å·å·æ”¹æˆ non-blocking çš„ç‰ˆæœ¬ <ul><li>æˆåŠŸ â†’ ç«‹å³ç»§ç»­æ‰§è¡Œ</li><li>å¤±è´¥ â†’ ç«‹å³ yield åˆ°å¦ä¸€ä¸ªéœ€è¦ CPU çš„ goroutine <ul><li>å¤ªå·§å¦™äº†ï¼CPU å’Œæ“ä½œç³»ç»Ÿå…¨éƒ¨ç”¨åˆ° 100%</li></ul></li></ul></li></ul></li></ul><hr><p>ä¾‹å­</p>',9),cn={href:"http://jyywiki.cn/pages/OS/2022/demos/fib.go",target:"_blank",rel:"noopener noreferrer"},un={href:"https://books.studygolang.com/gopl-zh/ch9/ch9-08.html",target:"_blank",rel:"noopener noreferrer"},rn=e(`<p>Goè§£å†³äº†ä¸¤ä¸ªå¤§é—®é¢˜ï¼Œä¸€ä¸ªæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶çš„å¼€é”€ï¼Œä¸€ä¸ªæ˜¯åç¨‹åœ¨é‡åˆ°IOæ“ä½œæ—¶ä¼šé‡åˆ°çš„åˆ‡æ¢çº¿ç¨‹ã€‚</p><p>é€šè¿‡channelæ¥è¿›è¡Œçº¿ç¨‹é—´çš„é€šä¿¡ï¼Œé¿å…äº†å…±äº«å†…å­˜çš„éº»çƒ¦ã€‚</p><h2 id="å¹¶å‘bugåº”å¯¹æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#å¹¶å‘bugåº”å¯¹æ–¹æ³•" aria-hidden="true">#</a> å¹¶å‘BUGåº”å¯¹æ–¹æ³•</h2><p>é˜²å¾¡æ€§ç¼–ç¨‹</p><p>å¤šç”¨Assertæ–­è¨€æ¥åˆ¤æ–­æ“ä½œæ˜¯å¦æ­£ç¡®</p><h3 id="æ­»é”" tabindex="-1"><a class="header-anchor" href="#æ­»é”" aria-hidden="true">#</a> æ­»é”</h3><h4 id="aa-deadlock" tabindex="-1"><a class="header-anchor" href="#aa-deadlock" aria-hidden="true">#</a> AA-Deadlock</h4><p>å‡è®¾ä½ çš„ spinlock ä¸å°å¿ƒå‘ç”Ÿäº†ä¸­æ–­</p><ul><li>åœ¨ä¸è¯¥æ‰“å¼€ä¸­æ–­çš„æ—¶å€™å¼€äº†ä¸­æ–­</li><li>åœ¨ä¸è¯¥åˆ‡æ¢çš„æ—¶å€™æ‰§è¡Œäº† <code>yield()</code></li></ul><hr><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>void os_run() {
  spin_lock(&amp;list_lock);
  spin_lock(&amp;xxx);
  spin_unlock(&amp;xxx); // ---------+
}                          //    |
                           //    |
void on_interrupt() {      //    |
  spin_lock(&amp;list_lock);   // &lt;--+
  spin_unlock(&amp;list_lock);
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="abba-deadlock" tabindex="-1"><a class="header-anchor" href="#abba-deadlock" aria-hidden="true">#</a> ABBA-Deadlock</h4><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>void swap(int i, int j) {
  spin_lock(&amp;lock[i]);
  spin_lock(&amp;lock[j]);
  arr[i] = NULL;
  arr[j] = arr[i];
  spin_unlock(&amp;lock[j]);
  spin_unlock(&amp;lock[i]);
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><p>ä¸Šé”çš„é¡ºåºå¾ˆé‡è¦â€¦â€¦</p>`,15),dn=n("div",{class:"language-text line-numbers-mode","data-ext":"text"},[n("pre",{class:"language-text"},[n("code",null,`swap
`)]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"})])],-1),kn=n("p",null,"æœ¬èº«çœ‹èµ·æ¥æ²¡æœ‰é—®é¢˜",-1),vn=n("li",null,[n("code",null,"swap(1, 2)"),s("; "),n("code",null,"swap(2, 3)"),s(", "),n("code",null,"swap(3, 1)"),s(" â†’ æ­»é”")],-1),mn={href:"http://jyywiki.cn/pages/OS/2022/demos/philosopher.c",target:"_blank",rel:"noopener noreferrer"},hn=n("p",null,"é¿å…æ­»é”",-1),bn={href:"https://en.wikipedia.org/wiki/Edward_G._Coffman,_Jr.",target:"_blank",rel:"noopener noreferrer"},fn=e('<ul><li>äº’æ–¥ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨</li><li>è¯·æ±‚ä¸ä¿æŒï¼šä¸€ä¸ªè¿›ç¨‹è¯·æ±‚èµ„é˜»å¡æ—¶ï¼Œä¸é‡Šæ”¾å·²è·å¾—çš„èµ„æº</li><li>ä¸å‰¥å¤ºï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºä¸èƒ½å¼ºè¡Œå‰¥å¤º</li><li>å¾ªç¯ç­‰å¾…ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆå¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»</li></ul><hr><blockquote><p>â€œç†è§£äº†æ­»é”çš„åŸå› ï¼Œå°¤å…¶æ˜¯äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼Œå°±å¯ä»¥æœ€å¤§å¯èƒ½åœ°é¿å…ã€é¢„é˜²å’Œè§£é™¤æ­»é”ã€‚æ‰€ä»¥ï¼Œåœ¨ç³»ç»Ÿè®¾è®¡ã€è¿›ç¨‹è°ƒåº¦ç­‰æ–¹é¢æ³¨æ„å¦‚ä½•ä¸è®©è¿™å››ä¸ªå¿…è¦æ¡ä»¶æˆç«‹ï¼Œå¦‚ä½•ç¡®å®šèµ„æºçš„åˆç†åˆ†é…ç®—æ³•ï¼Œé¿å…è¿›ç¨‹æ°¸ä¹…å æ®ç³»ç»Ÿèµ„æºã€‚æ­¤å¤–ï¼Œä¹Ÿè¦é˜²æ­¢è¿›ç¨‹åœ¨å¤„äºç­‰å¾…çŠ¶æ€çš„æƒ…å†µä¸‹å ç”¨èµ„æºã€‚å› æ­¤ï¼Œå¯¹èµ„æºçš„åˆ†é…è¦ç»™äºˆåˆç†çš„è§„åˆ’ã€‚â€ â€”â€”Bullshit.</p></blockquote><h4 id="é¿å…æ­»é”-cont-d" tabindex="-1"><a class="header-anchor" href="#é¿å…æ­»é”-cont-d" aria-hidden="true">#</a> é¿å…æ­»é” (cont&#39;d)</h4><p>AA-Deadlock</p><ul><li>AA å‹çš„æ­»é”å®¹æ˜“æ£€æµ‹ï¼ŒåŠæ—©æŠ¥å‘Šï¼ŒåŠæ—©ä¿®å¤</li><li>spinlock-xv6.c ä¸­çš„å„ç§é˜²å¾¡æ€§ç¼–ç¨‹ <ul><li><code>if (holding(lk)) panic();</code></li></ul></li></ul><hr><p>ABBA-Deadlock</p>',8),gn=n("li",null,"ä»»æ„æ—¶åˆ»ç³»ç»Ÿä¸­çš„é”éƒ½æ˜¯æœ‰é™çš„",-1),_n={href:"http://jyywiki.cn/pages/OS/2022/demos/lock-ordering.py",target:"_blank",rel:"noopener noreferrer"},yn=n("li",null,[s("è¿›è€Œè¯æ˜æ˜¯å®‰å…¨çš„ "),n("ul",null,[n("li",null,"â€œåœ¨ä»»æ„æ—¶åˆ»æ€»æ˜¯æœ‰è·å¾— â€œæœ€é åâ€ é”çš„å¯ä»¥ç»§ç»­æ‰§è¡Œâ€")])],-1),wn=n("h3",{id:"æ•°æ®ç«äº‰",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#æ•°æ®ç«äº‰","aria-hidden":"true"},"#"),s(" æ•°æ®ç«äº‰")],-1),xn=n("blockquote",null,[n("p",null,"ä¸åŒçš„çº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€æ®µå†…å­˜ï¼Œä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™ã€‚")],-1),qn=n("p",null,"ä¸¤ä¸ªå†…å­˜è®¿é—®åœ¨ â€œèµ›è·‘â€ï¼Œâ€œè·‘èµ¢â€ çš„æ“ä½œå…ˆæ‰§è¡Œ",-1),Cn=n("p",null,"peterson-barrier.c",-1),Sn=n("p",null,": å†…å­˜è®¿é—®éƒ½åœ¨èµ›è·‘",-1),An={href:"https://www.felixcloutier.com/x86/mfence",target:"_blank",rel:"noopener noreferrer"},Pn=n("s",null,"å¦‚ä½•ç•™ä¸‹æœ€å°‘çš„ fenceï¼Œä¾ç„¶ä¿è¯ç®—æ³•æ­£ç¡®ï¼Ÿ",-1),Tn=e(`<p>ç”¨äº’æ–¥é”ä¿æŠ¤æ•°æ®ï¼Œé¿å…æ•°æ®ç«äº‰</p><h3 id="å…¶ä»–bug" tabindex="-1"><a class="header-anchor" href="#å…¶ä»–bug" aria-hidden="true">#</a> å…¶ä»–BUG</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// Case #1: ä¸Šé”™äº†é”</span>
<span class="token keyword">void</span> <span class="token function">thread1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk1<span class="token punctuation">)</span><span class="token punctuation">;</span> sum<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">thread2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk2<span class="token punctuation">)</span><span class="token punctuation">;</span> sum<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// Case #2: å¿˜è®°ä¸Šé”</span>
<span class="token keyword">void</span> <span class="token function">thread1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk1<span class="token punctuation">)</span><span class="token punctuation">;</span> sum<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lk1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">thread2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> sum<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åŸå­æ€§è¿å-av" tabindex="-1"><a class="header-anchor" href="#åŸå­æ€§è¿å-av" aria-hidden="true">#</a> åŸå­æ€§è¿å (AV)</h4><p>â€œABAâ€</p><ul><li>æˆ‘ä»¥ä¸ºä¸€æ®µä»£ç æ²¡å•¥äº‹å‘¢ï¼Œä½†è¢«äººå¼ºåŠ¿æ’å…¥äº†</li></ul><figure><img src="http://jyywiki.cn/pages/OS/img/av-bug.png" alt="ABA" tabindex="0" loading="lazy"><figcaption>ABA</figcaption></figure><h4 id="é¡ºåºè¿å-ov" tabindex="-1"><a class="header-anchor" href="#é¡ºåºè¿å-ov" aria-hidden="true">#</a> é¡ºåºè¿å (OV)</h4><p>â€œBAâ€</p><ul><li>æ€ä¹ˆå°±æ²¡æŒ‰æˆ‘é¢„æƒ³çš„é¡ºåºæ¥å‘¢ï¼Ÿ <ul><li>ä¾‹å­ï¼šconcurrent use after free</li></ul></li></ul><figure><img src="http://jyywiki.cn/pages/OS/img/ov-bug.png" alt="OV" tabindex="0" loading="lazy"><figcaption>OV</figcaption></figure><h3 id="åº”å¯¹é”™è¯¯çš„æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#åº”å¯¹é”™è¯¯çš„æ–¹æ³•" aria-hidden="true">#</a> åº”å¯¹é”™è¯¯çš„æ–¹æ³•</h3><h4 id="lockdep-è¿è¡Œæ—¶çš„æ­»é”æ£€æŸ¥" tabindex="-1"><a class="header-anchor" href="#lockdep-è¿è¡Œæ—¶çš„æ­»é”æ£€æŸ¥" aria-hidden="true">#</a> Lockdep: è¿è¡Œæ—¶çš„æ­»é”æ£€æŸ¥</h4><p>Lockdep è§„çº¦ (Specification)</p>`,16),Ln={href:"http://jyywiki.cn/pages/OS/2022/demos/lock-site.c",target:"_blank",rel:"noopener noreferrer"},In=n("li",null,"assert: åŒä¸€ä¸ª allocation site çš„é”å­˜åœ¨å…¨å±€å”¯ä¸€çš„ä¸Šé”é¡ºåº",-1),On=e('<p>æ£€æŸ¥æ–¹æ³•ï¼šprintf</p><ul><li>è®°å½•æ‰€æœ‰è§‚å¯Ÿåˆ°çš„ä¸Šé”é¡ºåºï¼Œä¾‹å¦‚</li></ul><p>ç»´æŠ¤çš„å…¶å®æ˜¯ä¸€ä¸ªå›¾ï¼Œå¦‚æœå›¾ä¸­æœ‰ç¯ï¼Œåˆ™è¿èƒŒäº†åŠ é”çš„é¡ºåºã€‚</p><h4 id="threadsanitizer-è¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥" tabindex="-1"><a class="header-anchor" href="#threadsanitizer-è¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥" aria-hidden="true">#</a> ThreadSanitizer: è¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥</h4><p>ä¸ºæ‰€æœ‰äº‹ä»¶å»ºç«‹ happens-before å…³ç³»å›¾</p><ul><li>Program-order + release-acquire</li><li>å¯¹äºå‘ç”Ÿåœ¨ä¸åŒçº¿ç¨‹ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™çš„ x,y<em>x</em>,<em>y</em> æ£€æŸ¥</li></ul><p>è¿˜æ˜¯è¦ä¾é å·¥å…·åšæ£€æŸ¥ï¼</p><h2 id="åŠ¨æ€åˆ†æå·¥å…·-sanitizers" tabindex="-1"><a class="header-anchor" href="#åŠ¨æ€åˆ†æå·¥å…·-sanitizers" aria-hidden="true">#</a> åŠ¨æ€åˆ†æå·¥å…·ï¼šSanitizers</h2><p>æ²¡ç”¨è¿‡ lint/sanitizersï¼Ÿ</p>',9),zn=n("li",null,"Buffer (heap/stack/global) overflow, use-after-free, use-after-return, double-free, ...",-1),En={href:"http://jyywiki.cn/pages/OS/2022/demos/uaf.c",target:"_blank",rel:"noopener noreferrer"},Un={href:"https://www.kernel.org/doc/html/latest/dev-tools/kasan.html",target:"_blank",rel:"noopener noreferrer"},Nn={href:"http://jyywiki.cn/pages/OS/2022/demos/fish.c",target:"_blank",rel:"noopener noreferrer"},jn={href:"http://jyywiki.cn/pages/OS/2022/demos/sum.c",target:"_blank",rel:"noopener noreferrer"},Bn={href:"http://jyywiki.cn/pages/OS/2022/demos/peterson-barrier.c",target:"_blank",rel:"noopener noreferrer"},Mn={href:"https://github.com/google/ktsan",target:"_blank",rel:"noopener noreferrer"},Dn={href:"https://clang.llvm.org/docs/MemorySanitizer.html",target:"_blank",rel:"noopener noreferrer"},Rn=n("li",null,[s("UBSanitizer(ubsan): undefined behavior "),n("ul",null,[n("li",null,"Misaligned pointer, signed integer overflow, ..."),n("li",null,[s("Kernel ä¼šå¸¦ç€ "),n("code",null,"-fwrapv"),s(" ç¼–è¯‘")])])],-1);function Vn(Gn,Fn){const a=c("ExternalLinkIcon");return o(),l("div",null,[d,n("div",k,[v,n("p",null,[n("a",m,[s("mfence"),t(a)])]),n("p",null,[n("a",h,[s('mfence å’Œ asm volatile ("" ::: "memory"); åŒºåˆ«'),t(a)])])]),b,f,n("div",g,[_,y,n("p",null,[n("a",w,[s("å†…å­˜ç³»ç»Ÿæ¨¡å‹"),t(a)])])]),x,n("p",null,[n("a",q,[s("syc æ‰‹å†Œ"),t(a)])]),C,n("div",S,[A,n("p",null,[n("a",P,[s("RISCV-BOOM"),t(a)])]),n("p",null,[n("a",T,[s("LR SC"),t(a)])])]),L,n("ul",null,[I,O,n("li",null,[s("è§£é”ä»¥åä¹Ÿéœ€è¦ç³»ç»Ÿè°ƒç”¨ "),n("ul",null,[n("li",null,[n("a",z,[s("futex.py"),t(a)])]),E])])]),n("div",U,[N,n("p",null,[n("a",j,[s("Futex overview and update"),t(a)])]),n("p",null,[n("a",B,[s("Futex are tricky"),t(a)])])]),M,n("ul",null,[D,n("li",null,[s("å³æ‹¬å·ï¼šåµŒå¥—æ·±åº¦ (é˜Ÿåˆ—)>1æ—¶æ‰èƒ½æ‰“å° "),n("ul",null,[R,n("li",null,[s("å‹åŠ›æµ‹è¯•çš„æ£€æŸ¥å½“ç„¶ä¸èƒ½å°‘ï¼š"),n("a",V,[s("pc-check.py"),t(a)])]),G])])]),F,n("ul",null,[n("li",null,[s("è€ƒè™‘ â€œæ‰‹ç¯â€ (æ¯ä¸€å•ä½çš„ â€œèµ„æºâ€) æ˜¯ä»€ä¹ˆï¼Œè°åˆ›é€ ï¼Ÿè°è·å–ï¼Ÿ "),n("ul",null,[n("li",null,[n("a",X,[Y,t(a)])])])])]),H,n("ul",null,[W,n("li",null,[s("å¦‚æœä¸€ä¸ª manager æä¸å®šï¼Œå¯ä»¥åˆ†å¤šä¸ª (fast/slow path) "),n("ul",null,[n("li",null,[s("æŠŠç³»ç»Ÿè®¾è®¡å¥½ï¼Œä½¿é›†ä¸­ç®¡ç†ä¸æˆä¸ºç“¶é¢ˆ "),n("ul",null,[n("li",null,[n("a",Z,[s("Millions of tiny databases"),t(a)]),s(" (NSDI'20)")])])])])])]),K,n("div",J,[$,Q,n("ul",null,[nn,n("li",null,[s("ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£å†³ä¸€åˆ‡ "),n("ul",null,[n("li",null,[n("a",sn,[s("MPI"),t(a)]),s(" - â€œa specification for the developers and users of message passing librariesâ€, "),n("a",an,[s("OpenMP"),t(a)]),s(" - â€œmulti-platform shared-memory parallel programming in C/C++ and Fortranâ€")])])]),n("li",null,[n("a",tn,[s("Parallel and Distributed Computation: Numerical Methods"),t(a)])])]),en,pn,on]),ln,n("ul",null,[n("li",null,[n("a",cn,[s("fib.go"),t(a)]),s(";")]),n("li",null,[n("a",un,[s("The Go Programming Language (ch 9.8)"),t(a)])])]),rn,n("ul",null,[n("li",null,[dn,kn,n("ul",null,[vn,n("li",null,[n("a",mn,[s("philosopher.c"),t(a)])])])])]),hn,n("p",null,[s("æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶ ("),n("a",bn,[s("Edward G. Coffman"),t(a)]),s(", 1971):")]),fn,n("ul",null,[gn,n("li",null,[s("ä¸¥æ ¼æŒ‰ç…§å›ºå®šçš„é¡ºåºè·å¾—æ‰€æœ‰é” (lock ordering; æ¶ˆé™¤ â€œå¾ªç¯ç­‰å¾…â€) "),n("ul",null,[n("li",null,[s("é‡äº‹ä¸å†³å¯è§†åŒ–ï¼š"),n("a",_n,[s("lock-ordering.py"),t(a)])]),yn])])]),wn,xn,n("ul",null,[n("li",null,[qn,n("ul",null,[n("li",null,[Cn,Sn,n("ul",null,[n("li",null,[n("a",An,[s("MFENCE"),t(a)]),s("ï¼š"),Pn])])])])])]),Tn,n("ul",null,[n("li",null,[s("ä¸ºæ¯ä¸€ä¸ªé”ç¡®å®šå”¯ä¸€çš„ â€œallocation siteâ€ "),n("ul",null,[n("li",null,[n("a",Ln,[s("lock-site.c"),t(a)])]),In])])]),On,n("ul",null,[n("li",null,[s("AddressSanitizer(asan);(paper): éæ³•å†…å­˜è®¿é—® "),n("ul",null,[zn,n("li",null,[s("Demo: "),n("a",En,[s("uaf.c"),t(a)]),s("; "),n("a",Un,[s("kasan"),t(a)])])])]),n("li",null,[s("ThreadSanitizer(tsan): æ•°æ®ç«äº‰ "),n("ul",null,[n("li",null,[s("Demo: "),n("a",Nn,[s("fish.c"),t(a)]),s(", "),n("a",jn,[s("sum.c"),t(a)]),s(", "),n("a",Bn,[s("peterson-barrier.c"),t(a)]),s("; "),n("a",Mn,[s("ktsan"),t(a)])])])]),n("li",null,[n("a",Dn,[s("MemorySanitizer"),t(a)]),s(" (msan): æœªåˆå§‹åŒ–çš„è¯»å–")]),Rn])])}const Yn=p(r,[["render",Vn],["__file","concurrence.html.vue"]]);export{Yn as default};
